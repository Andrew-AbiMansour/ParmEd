

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>parmed.tools.actions &mdash; ParmEd  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> ParmEd
          

          
          </a>

          
            
            
              <div class="version">
                0+untagged.3319.g7a6168d
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topologyobjects.html">Core classes used to represent topologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">The core Structure class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dimensional_analysis.html">Working with units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readwrite.html">Reading and writing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amber.html">The Amber file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../charmm.html">The CHARMM file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gromacs.html">The GROMACS file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rosetta.html">PyRosetta Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html">Using <code class="docutils literal notranslate"><span class="pre">parmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html#using-xparmed">Using <code class="docutils literal notranslate"><span class="pre">xparmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed_api.html">The ParmEd API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openmm.html">OpenMM Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualization.html">Visualization Functionality</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ParmEd</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>parmed.tools.actions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for parmed.tools.actions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">All of the prmtop actions used in PARMED. Each class is a separate action.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">gromacs</span><span class="p">,</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">..amber</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AmberAsciiRestart</span><span class="p">,</span> <span class="n">AmberMask</span><span class="p">,</span> <span class="n">AmberMdcrd</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">,</span>
                     <span class="n">AmoebaParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">,</span> <span class="n">NetCDFRestart</span><span class="p">,</span> <span class="n">NetCDFTraj</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..amber._chamberparm</span> <span class="kn">import</span> <span class="n">ConvertFromPSF</span>
<span class="kn">from</span> <span class="nn">..charmm</span> <span class="kn">import</span> <span class="n">CharmmParameterSet</span><span class="p">,</span> <span class="n">CharmmPsfFile</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">ParmedError</span>
<span class="kn">from</span> <span class="nn">..formats</span> <span class="kn">import</span> <span class="n">CIFFile</span><span class="p">,</span> <span class="n">Mol2File</span><span class="p">,</span> <span class="n">PDBFile</span>
<span class="kn">from</span> <span class="nn">..formats.registry</span> <span class="kn">import</span> <span class="n">load_file</span>
<span class="kn">from</span> <span class="nn">..modeller</span> <span class="kn">import</span> <span class="n">AmberOFFLibrary</span><span class="p">,</span> <span class="n">ResidueTemplateContainer</span>
<span class="kn">from</span> <span class="nn">..periodic_table</span> <span class="kn">import</span> <span class="n">Element</span> <span class="k">as</span> <span class="n">_Element</span>
<span class="kn">from</span> <span class="nn">..residue</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ANION_NAMES</span><span class="p">,</span> <span class="n">CATION_NAMES</span><span class="p">,</span> <span class="n">SOLVENT_NAMES</span><span class="p">,</span>
                       <span class="n">AminoAcidResidue</span><span class="p">,</span> <span class="n">DNAResidue</span><span class="p">,</span> <span class="n">RNAResidue</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">..topologyobjects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Angle</span><span class="p">,</span> <span class="n">AngleType</span><span class="p">,</span> <span class="n">Bond</span><span class="p">,</span> <span class="n">BondType</span><span class="p">,</span> <span class="n">Dihedral</span><span class="p">,</span>
                               <span class="n">DihedralType</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utils.six</span> <span class="kn">import</span> <span class="n">add_metaclass</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">..utils.six.moves</span> <span class="kn">import</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">.argumentlist</span> <span class="kn">import</span> <span class="n">ArgumentList</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AddPDBError</span><span class="p">,</span> <span class="n">AddPDBWarning</span><span class="p">,</span>  <span class="c1"># CoarseGrainError,</span>
                         <span class="n">AmbiguousParmError</span><span class="p">,</span> <span class="n">ArgumentError</span><span class="p">,</span> <span class="n">ChamberError</span><span class="p">,</span>
                         <span class="n">ChangeLJPairError</span><span class="p">,</span> <span class="n">ChangeStateError</span><span class="p">,</span>
                         <span class="n">DeleteDihedralError</span><span class="p">,</span> <span class="n">FileDoesNotExist</span><span class="p">,</span> <span class="n">FileExists</span><span class="p">,</span>
                         <span class="n">HMassRepartitionError</span><span class="p">,</span> <span class="n">IncompatibleParmsError</span><span class="p">,</span>
                         <span class="n">InputError</span><span class="p">,</span> <span class="n">LJ12_6_4Error</span><span class="p">,</span> <span class="n">NoArgument</span><span class="p">,</span>
                         <span class="n">NonexistentParm</span><span class="p">,</span> <span class="n">ParmedChangeError</span><span class="p">,</span> <span class="n">ParmError</span><span class="p">,</span>
                         <span class="n">ParmFileNotFound</span><span class="p">,</span> <span class="n">ParmWarning</span><span class="p">,</span> <span class="n">SeriousParmWarning</span><span class="p">,</span>
                         <span class="n">SetParamError</span><span class="p">,</span> <span class="n">SimulationError</span><span class="p">,</span> <span class="n">TiMergeError</span><span class="p">,</span>
                         <span class="n">UnhandledArgumentWarning</span><span class="p">,</span> <span class="n">WriteOFFError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.parmlist</span> <span class="kn">import</span> <span class="n">ParmList</span>

<span class="n">GB_RADII</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;amber6&#39;</span><span class="p">,</span> <span class="s1">&#39;bondi&#39;</span><span class="p">,</span> <span class="s1">&#39;mbondi&#39;</span><span class="p">,</span> <span class="s1">&#39;mbondi2&#39;</span><span class="p">,</span> <span class="s1">&#39;mbondi3&#39;</span><span class="p">]</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># This gets populated by the ActionType metaclass</span>
<span class="n">COMMANDMAP</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">Usages</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">go</span><span class="o">=</span><span class="s1">&#39;go&#39;</span><span class="p">,</span> <span class="n">quit</span><span class="o">=</span><span class="s1">&#39;quit&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;help [&lt;action&gt;]&#39;</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="s1">&#39;history&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ActionType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass for defining Action types, to add it to the list of available</span>
<span class="sd">    actions and provide a hash lookup to the interpreter to support</span>
<span class="sd">    case-insensitive command access</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cls : class type</span>
<span class="sd">        The class that is being generated by this metaclass</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the class being created</span>
<span class="sd">    bases : tuple of types</span>
<span class="sd">        Tuple of all base class types for this class</span>
<span class="sd">    dct: dict</span>
<span class="sd">        The list of options and attributes currently present in this class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">COMMANDMAP</span><span class="p">,</span> <span class="n">__all__</span><span class="p">,</span> <span class="n">Usages</span>
        <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Action&#39;</span><span class="p">:</span>
            <span class="n">COMMANDMAP</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">if</span> <span class="s1">&#39;usage&#39;</span> <span class="ow">in</span> <span class="n">dct</span><span class="p">:</span>
            <span class="n">Usages</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dct</span><span class="p">[</span><span class="s1">&#39;usage&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="c1"># Skip base action class</span>
            <span class="n">Usages</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActionType</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<span class="n">lawsuit</span> <span class="o">=</span> <span class="nb">object</span>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="Action"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.Action">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">ActionType</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Action</span><span class="p">(</span><span class="n">lawsuit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class for all ParmEd actions. The metaclass for Action adds the</span>
<span class="sd">    action and its usage statement to a map that is imported and used by the</span>
<span class="sd">    ParmEd interpreter. So just adding the subclass, wherever it happens, and</span>
<span class="sd">    giving it a &#39;usage&#39; attribute is sufficient to have it added to the</span>
<span class="sd">    interpreter map. There are a number of attributes that can refine the</span>
<span class="sd">    behavior of individual Actions in the interpreter:</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_parm : Structure</span>
<span class="sd">    arg_list : str or ArgumentList</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    stderr : file-like, optional</span>
<span class="sd">        Having a ``write`` attribute, this is where errors and warnings will be</span>
<span class="sd">        written. Default is sys.stderr</span>
<span class="sd">    needs_parm : bool, optional</span>
<span class="sd">        If this Action needs a ``parm`` instance to operate on. If your Action</span>
<span class="sd">        either acts on the interpreter or *creates* a parm, this can be False.</span>
<span class="sd">        Default is True</span>
<span class="sd">    supported_subclasses : tuple</span>
<span class="sd">        A tuple of all types whose subclasses can be acted upon by this Action.</span>
<span class="sd">        This is useful for permissive Action classes</span>
<span class="sd">    strictly_supported : tuple</span>
<span class="sd">        This Action can *only* act on a particular set of class instances. If</span>
<span class="sd">        the parm does not have one of the listed types, it is not supported</span>
<span class="sd">        (subclasses do *not* count here)</span>
<span class="sd">    not_supported : tuple</span>
<span class="sd">        These classes are *not* supported (supplements supported_subclasses)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="c1"># Does this action need a populated parm_list? If yes, bail out if it&#39;s</span>
    <span class="c1"># unpopulated</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Do we allow any action to overwrite existing files? Static variable.</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Default for API. parmed sets this every time</span>
    <span class="c1"># We do one of two kinds of filtering for each action. Each action can</span>
    <span class="c1"># support either a strict subset of classes, in which case the type *must*</span>
    <span class="c1"># be an exact member (not a subclass) of one of that list. If that list is</span>
    <span class="c1"># empty, then we loop through the supported_subclasses static tuple and see</span>
    <span class="c1"># if our parm is a subclass of any of those classes</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">Structure</span><span class="p">,)</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">()</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Is this action &#39;valid&#39; (i.e., can we run &#39;execute&#39;)?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Accept both an AmberParm or ParmList instance to simplify the API</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_parm</span><span class="p">,</span> <span class="n">ParmList</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span> <span class="o">=</span> <span class="n">input_parm</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_parm</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span> <span class="o">=</span> <span class="n">ParmList</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">add_parm</span><span class="p">(</span><span class="n">input_parm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">input_parm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span> <span class="o">=</span> <span class="n">ParmList</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;input_parm expected to be a ParmList or Structure instance&#39;</span><span class="p">)</span>
        <span class="c1"># Set active parm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">parm</span> <span class="c1"># Current active parm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_parm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;Action requires a loaded topology file&#39;</span><span class="p">)</span>
        <span class="c1"># Fill the argument list</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arg_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_list</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="c1"># arg_list has a space, so enclose it in quotes</span>
                <span class="n">arg_list</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;  &#39;</span> <span class="o">%</span> <span class="n">arg_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg_list</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">arg_list</span>
            <span class="n">arg_list</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_arg</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">arg_list</span> <span class="o">+=</span> <span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_arg</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">arg_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="n">ArgumentList</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_list</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_arg</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span>
        <span class="c1"># If our arg_list is a string, convert it to an ArgumentList</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_list</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="n">ArgumentList</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg_list</span> <span class="o">=</span> <span class="n">ArgumentList</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg_list</span><span class="p">))</span>
        <span class="c1"># Now that we have the argument list, see if we have requested a</span>
        <span class="c1"># specific parm. If so, set self.parm equal to that object, instead</span>
        <span class="n">parm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;parm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># If it is an integer, see if it is a valid index. If it&#39;s not a valid</span>
        <span class="c1"># index, try it as a string. Otherwise just try it as a string.</span>
        <span class="k">if</span> <span class="n">parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using parm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">parm</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Cannot find parm </span><span class="si">%s</span><span class="s1">. Skipping this action&#39;</span> <span class="o">%</span> <span class="n">parm</span><span class="p">,</span>
                                  <span class="n">SeriousParmWarning</span><span class="p">)</span>
                    <span class="k">return</span> <span class="c1"># pragma: no cover</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parm</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">parm</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using parm </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">parm</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Cannot find parm </span><span class="si">%s</span><span class="s1">. Skipping this action&#39;</span> <span class="o">%</span> <span class="n">parm</span><span class="p">,</span>
                                  <span class="n">SeriousParmWarning</span><span class="p">)</span>
                    <span class="k">return</span> <span class="c1"># pragma: no cover</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_parm</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strictly_supported</span> <span class="ow">and</span>
                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strictly_supported</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> objects are not supported by this action&#39;</span> <span class="o">%</span>
                                <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">strictly_supported</span><span class="p">:</span>
                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_supported</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">cls</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> objects are not supported by this action&#39;</span> <span class="o">%</span>
                                        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_subclasses</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> objects are not supported by this action&#39;</span> <span class="o">%</span>
                                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg_list</span> <span class="o">=</span> <span class="n">arg_list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoArgument</span><span class="p">:</span>
            <span class="n">cmdname</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">usage</span> <span class="o">=</span> <span class="n">cmdname</span>
            <span class="n">Action</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Bad command </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmdname</span><span class="p">,</span> <span class="n">usage</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Check any unmarked commands</span>
        <span class="n">unmarked_cmds</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">unmarked</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmarked_cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unmarked_cmds</span><span class="p">),</span> <span class="n">UnhandledArgumentWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="Action.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.Action.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This should be overridden if anything needs to be done &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;init must be overridden by Action subclass&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Action.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.Action.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Commands involved in executing the action &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_format_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats an argument so that if it&#39;s a string with a space in it, the argument will be</span>
<span class="sd">        encapsulated with quotes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">arg</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39; &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span> <span class="o">%</span> <span class="n">arg</span>
        <span class="k">return</span> <span class="n">arg</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="parmout"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.parmout">[docs]</a><span class="k">class</span> <span class="nc">parmout</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Final prmtop written after all actions are complete</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;prmtop_name&gt; [&lt;inpcrd_name&gt;] [netcdf]&#39;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>

<div class="viewcode-block" id="parmout.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.parmout.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;netcdf&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rst7_format</span> <span class="o">=</span> <span class="s1">&#39;NCRST&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rst7_format</span> <span class="o">=</span> <span class="s1">&#39;RST7&#39;</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Outputting Amber topology file </span><span class="si">%s</span><span class="s1"> and restart </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Outputting Amber topology file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>

<div class="viewcode-block" id="parmout.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.parmout.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FileExists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists; not overwriting.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">FileExists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists; not overwriting.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rst7_format</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="setOverwrite"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setOverwrite">[docs]</a><span class="k">class</span> <span class="nc">setOverwrite</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Necessary to overwrite original topology file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[True|False]&#39;</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="setOverwrite.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setOverwrite.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="c1"># see if we got an argument</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;setOverwrite: unrecognized argument. Assuming False&quot;</span><span class="p">,</span>
                              <span class="n">SeriousParmWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Files are overwritable&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Files are NOT overwritable&#39;</span>

<div class="viewcode-block" id="setOverwrite.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setOverwrite.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overwrite</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="writeFrcmod"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeFrcmod">[docs]</a><span class="k">class</span> <span class="nc">writeFrcmod</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes an frcmod file from all of the parameters in the topology file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;frcmod_name&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="writeFrcmod.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeFrcmod.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span> <span class="o">=</span> <span class="s1">&#39;frcmod&#39;</span>
        <span class="c1"># Emit warnings about 10-12 prmtops if we detect any 10-12 parameters</span>
        <span class="n">hbond_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">hbond_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">hbond_indexes</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBOND_ACOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBOND_BCOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBCUT&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Frcmod dumping does not work with 10-12 prmtops&#39;</span><span class="p">,</span>
                                  <span class="n">SeriousParmWarning</span><span class="p">)</span>
                    <span class="k">break</span> <span class="c1"># pragma: no cover</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># pragma: no cover</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Dumping FRCMOD file </span><span class="si">%s</span><span class="s1"> with parameters from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span>

<div class="viewcode-block" id="writeFrcmod.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeFrcmod.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes the frcmod file &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.amber.parameters</span> <span class="kn">import</span> <span class="n">AmberParameterSet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FileExists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists; not overwriting&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span><span class="p">)</span>
        <span class="n">parmset</span> <span class="o">=</span> <span class="n">AmberParameterSet</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Force field parameters from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">parmset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frcmod_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="loadRestrt"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.loadRestrt">[docs]</a><span class="k">class</span> <span class="nc">loadRestrt</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a restart file so we have coordinates. Necessary for distance-based</span>
<span class="sd">    mask criteria and writeOFF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;restrt_filename&gt;&#39;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="loadRestrt.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.loadRestrt.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Loading restart file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span>

<div class="viewcode-block" id="loadRestrt.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.loadRestrt.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">load_rst7</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rst_name</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="loadCoordinates"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.loadCoordinates">[docs]</a><span class="k">class</span> <span class="nc">loadCoordinates</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a coordinate file and loads the first set of coordinates found into</span>
<span class="sd">    the active structure. File type is auto-detected. Supported file formats</span>
<span class="sd">    include:</span>

<span class="sd">        - Amber restart file</span>
<span class="sd">        - Amber NetCDF restart file</span>
<span class="sd">        - CHARMM coordinate file</span>
<span class="sd">        - CHARMM restart file</span>
<span class="sd">        - Amber mdcrd trajectory</span>
<span class="sd">        - Amber NetCDF trajectory</span>
<span class="sd">        - PDB file</span>
<span class="sd">        - PDBx/mmCIF file</span>
<span class="sd">        - Gromacs GRO file</span>
<span class="sd">        - Mol2 file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;filename&gt;&#39;</span>
<div class="viewcode-block" id="loadCoordinates.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.loadCoordinates.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Adding coordinates to </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="loadCoordinates.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.loadCoordinates.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">crd</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="n">hasbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;Cannot get coordinates from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">box</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="writeCoordinates"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeCoordinates">[docs]</a><span class="k">class</span> <span class="nc">writeCoordinates</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the coordinates of the active structure to a coordinate file. The</span>
<span class="sd">    format of the file is detected from filename extension, with the following</span>
<span class="sd">    extensions being recognized:</span>

<span class="sd">        - ``.nc``: Amber NetCDF trajectory with a single frame</span>
<span class="sd">        - ``.ncrst``: Amber NetCDF restart file</span>
<span class="sd">        - ``.pdb``: PDB file</span>
<span class="sd">        - ``.cif``: PDBx/mmCIF file</span>
<span class="sd">        - ``.rst7``, ``.restrt``, ``.inpcrd``: Amber restart file</span>
<span class="sd">        - ``.mdcrd``: Amber mdcrd file</span>
<span class="sd">        - ``.mol2``: Sybyl Mol2 file</span>
<span class="sd">        - Default is Amber restart file</span>

<span class="sd">    Alternatively, the following keywords can be used to override the filename</span>
<span class="sd">    extension:</span>

<span class="sd">        - ``netcdftraj``: Amber NetCDF trajectory with a single frame</span>
<span class="sd">        - ``netcdf``: Amber NetCDF restart file</span>
<span class="sd">        - ``pdb``: PDB file</span>
<span class="sd">        - ``cif``: PDBx/mmCIF file</span>
<span class="sd">        - ``restart``: Amber restart/inpcrd file</span>
<span class="sd">        - ``mdcrd``: Amber mdcrd file</span>
<span class="sd">        - ``mol2``: Sybyl mol2 file</span>

<span class="sd">    Note, NetCDF files require scipy or netCDF4 to be installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;filename&gt; [netcdftraj | netcdf | pdb | cif | restart | mdcrd | &#39;</span>
             <span class="s1">&#39;mol2]&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="writeCoordinates.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeCoordinates.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;NCTRAJ&#39;</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ncrst&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;NCRESTART&#39;</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pdb&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;PDB&#39;</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.cif&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;CIF&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.rst7&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.restrt&#39;</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.inpcrd&#39;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;RESTART&#39;</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mdcrd&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;MDCRD&#39;</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mol2&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;MOL2&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;RESTART&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;netcdftraj&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;NCTRAJ&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;netcdf&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;NCRESTART&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;pdb&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;PDB&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;cif&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;CIF&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;restart&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;RESTART&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;mdcrd&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;MDCRD&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;mol2&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="s1">&#39;MOL2&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Unrecognized file format </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Writing coordinates to </span><span class="si">%s</span><span class="s1"> as type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span><span class="p">)</span>

<div class="viewcode-block" id="writeCoordinates.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeCoordinates.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FileExists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists; not overwriting&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="n">velocities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">velocities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;NCTRAJ&#39;</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">NetCDFTraj</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span>
                                       <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">add_time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">add_coordinates</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">add_velocities</span><span class="p">(</span><span class="n">velocities</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">add_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;NCRESTART&#39;</span><span class="p">:</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="n">NetCDFRestart</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span>
                                         <span class="n">box</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vels</span><span class="o">=</span><span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">rst</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="k">if</span> <span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rst</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="n">velocities</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rst</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span>
            <span class="n">rst</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;PDB&#39;</span><span class="p">:</span>
            <span class="n">PDBFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;CIF&#39;</span><span class="p">:</span>
            <span class="n">CIFFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;MOL2&#39;</span><span class="p">:</span>
            <span class="n">Mol2File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;MDCRD&#39;</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="n">AmberMdcrd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span>
                              <span class="n">hasbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">add_coordinates</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">add_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;RESTART&#39;</span><span class="p">:</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="n">AmberAsciiRestart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                    <span class="n">hasbox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">rst</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="k">if</span> <span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rst</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="n">velocities</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rst</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span>
            <span class="n">rst</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Should not be here. Unrecognized coordinate file format type.&#39;</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="writeOFF"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeOFF">[docs]</a><span class="k">class</span> <span class="nc">writeOFF</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes an Amber OFF Library with all of the residues found in the topology</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;OFF_filename&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="writeOFF.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeOFF.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">off_file</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Writing Amber OFF file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_file</span>

<div class="viewcode-block" id="writeOFF.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.writeOFF.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Action</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">off_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">FileExists</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists; not overwriting&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WriteOFFError</span><span class="p">(</span><span class="s1">&#39;You must load a restart for WriteOFF!&#39;</span><span class="p">)</span>

        <span class="n">lib</span> <span class="o">=</span> <span class="n">ResidueTemplateContainer</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span><span class="o">.</span><span class="n">to_library</span><span class="p">()</span>
        <span class="n">AmberOFFLibrary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">off_file</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="changeRadii"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeRadii">[docs]</a><span class="k">class</span> <span class="nc">changeRadii</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes intrinsic GB radii to the specified set: Allowed values are</span>
<span class="sd">        amber6, bondi, mbondi, mbondi2, mbondi3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;radii_set&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="changeRadii.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeRadii.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Changing PB/GB radii to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span>

<div class="viewcode-block" id="changeRadii.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeRadii.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.changeradii</span> <span class="kn">import</span> <span class="n">ChRad</span>
        <span class="c1"># Add RADIUS_SET to prmtop if it&#39;s not there already, and a blank</span>
        <span class="c1"># description, since it&#39;s about to be set here</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;RADIUS_SET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RADIUS_SET&#39;</span><span class="p">,</span> <span class="s1">&#39;1a80&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;RADII&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RADII&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;SCREEN&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SCREEN&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
            <span class="n">ChRad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span>
            <span class="c1"># Load the data into the parm arrays</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RADII&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">solvent_radius</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SCREEN&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">screen</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, just set the radii</span>
            <span class="n">ChRad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="changeLJPair"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJPair">[docs]</a><span class="k">class</span> <span class="nc">changeLJPair</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes a particular Lennard Jones pair based on a given (pre-combined)</span>
<span class="sd">    epsilon/Rmin</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt; &lt;Rmin&gt; &lt;epsilon&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
<div class="viewcode-block" id="changeLJPair.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJPair.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Setting LJ </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> pairwise interaction to have Rmin = </span><span class="si">%16.5f</span><span class="s1"> and Epsilon = &#39;</span>
                <span class="s1">&#39;</span><span class="si">%16.5f</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>

<div class="viewcode-block" id="changeLJPair.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJPair.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">selection1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">selection2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Action</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Skipping empty masks in changeLJPair</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Make sure we only selected 1 atom type in each mask</span>
        <span class="n">attype1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attype2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selection1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attype1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attype1</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attype1</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ChangeLJPairError</span><span class="p">(</span><span class="s1">&#39;First mask matches multiple atom types!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selection2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attype2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attype2</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attype2</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ChangeLJPairError</span><span class="p">(</span><span class="s1">&#39;Second mask matches multiple atom types!&#39;</span><span class="p">)</span>
        <span class="n">_change_lj_pair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">attype1</span><span class="p">,</span> <span class="n">attype2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="changeLJ14Pair"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJ14Pair">[docs]</a><span class="k">class</span> <span class="nc">changeLJ14Pair</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes a particular 1-4 Lennard Jones pair based on a given (pre-combined)</span>
<span class="sd">    epsilon/Rmin. Only valid for CHAMBER prmtops</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt; &lt;Rmin&gt; &lt;epsilon&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">ChamberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="changeLJ14Pair.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJ14Pair.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="c1"># Make sure this is a chamber prmtop</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">,</span> <span class="s1">&#39;Chamber-style prmtop required!&#39;</span>
        <span class="c1"># If not, initiate instance data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Setting LJ 1-4 </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> pairwise interaction to have 1-4 Rmin = </span><span class="si">%16.5f</span><span class="s1"> and 1-4 &#39;</span>
                <span class="s1">&#39;Epsilon = </span><span class="si">%16.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">))</span>

<div class="viewcode-block" id="changeLJ14Pair.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJ14Pair.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">selection1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">selection2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Action</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Skipping empty masks in changeLJ14Pair</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Make sure we only selected 1 atom type, and figure out what it is</span>
        <span class="n">attype1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attype2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selection1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attype1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attype1</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attype1</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ChangeLJPairError</span><span class="p">(</span><span class="s1">&#39;First mask matches multiple atom types!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selection2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attype2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attype2</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attype2</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ChangeLJPairError</span><span class="p">(</span><span class="s1">&#39;Second mask matches multiple atom types!&#39;</span><span class="p">)</span>

        <span class="c1"># Adjust 1-4 non-bonded terms as well if we&#39;re using a chamber-prmtop</span>
        <span class="n">_change_lj_pair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">attype1</span><span class="p">,</span> <span class="n">attype2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="checkValidity"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.checkValidity">[docs]</a><span class="k">class</span> <span class="nc">checkValidity</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic checks for prmtop validity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>

<div class="viewcode-block" id="checkValidity.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.checkValidity.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Determining validity of prmtop&#39;</span>

<div class="viewcode-block" id="checkValidity.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.checkValidity.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.checkvalidity</span> <span class="kn">import</span> <span class="n">check_validity</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.exceptions</span> <span class="kn">import</span> <span class="n">WarningList</span>
        <span class="c1"># Clear our warnings and start logging them, since check_validity</span>
        <span class="c1"># reports concerns about the prmtop through the warning system.</span>
        <span class="n">warning_log</span> <span class="o">=</span> <span class="n">WarningList</span><span class="p">(</span><span class="n">empty_msg</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> looks OK to me!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">))</span>
        <span class="n">check_validity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">warning_log</span><span class="p">)</span>
        <span class="n">warning_log</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="change"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.change">[docs]</a><span class="k">class</span> <span class="nc">change</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the property of given atoms to a new value. &lt;property&gt; can be</span>
<span class="sd">    CHARGE, MASS, RADII, SCREEN, ATOM_NAME, ATOM_TYPE, ATOM_TYPE_INDEX,</span>
<span class="sd">    or ATOMIC_NUMBER (note, changing elements with this command will NOT</span>
<span class="sd">    change their assignment for SHAKE!).</span>

<span class="sd">    If given, the [quiet] keyword will prevent ParmEd from printing out a</span>
<span class="sd">    summary with every property changed for every atom that was changed</span>
<span class="sd">    useful for suppressing overwhelming output if you are zeroing every</span>
<span class="sd">    charge, for instance)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;property&gt; &lt;mask&gt; &lt;new_value&gt; [quiet]&#39;</span>
<div class="viewcode-block" id="change.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.change.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;quiet&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_name</span> <span class="o">=</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span> <span class="s1">&#39;RADII&#39;</span><span class="p">,</span> <span class="s1">&#39;SCREEN&#39;</span><span class="p">,</span> <span class="s1">&#39;MASS&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_val_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_int</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_val_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%4i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span>
        <span class="k">elif</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;AMBER_ATOM_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;TREE_CHAIN_CLASSIFICATION&#39;</span><span class="p">,</span> <span class="s1">&#39;ATOM_TYPE&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Only 4 letters allowed for </span><span class="si">%s</span><span class="s1"> entries! Truncating remaining &#39;</span>
                              <span class="s1">&#39;letters.&#39;</span> <span class="o">%</span> <span class="n">prop</span><span class="p">,</span> <span class="n">ParmWarning</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_val_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-4s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParmedChangeError</span><span class="p">(</span><span class="s1">&#39;You may only use &quot;change&quot; with CHARGE, MASS, RADII, SCREEN, &#39;</span>
                                    <span class="s1">&#39;ATOM_NAME, ATOM_TYPE, ATOM_TYPE_INDEX, ATOMIC_NUMBER, or &#39;</span>
                                    <span class="s1">&#39;TREE_CHAIN_CLASSIFICATION&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span> <span class="ow">is</span> <span class="n">AmoebaParm</span><span class="p">:</span>
            <span class="c1"># Catch illegal values for Amoeba topologies</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span> <span class="s1">&#39;RADII&#39;</span><span class="p">,</span> <span class="s1">&#39;SCREEN&#39;</span><span class="p">,</span> <span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ParmedChangeError</span><span class="p">(</span><span class="s1">&#39;You cannot change </span><span class="si">%s</span><span class="s1"> in Amoeba topologies&#39;</span> <span class="o">%</span> <span class="n">prop</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">:</span>
                <span class="c1"># AmoebaParm can have an AMOEBA_ATOMIC_NUMBER section instead of</span>
                <span class="c1"># ATOMIC_NUMBER. So see which of them is available and change</span>
                <span class="c1"># that one</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">amoeba</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">flag_name</span> <span class="o">=</span> <span class="s1">&#39;AMOEBA_ATOMIC_NUMBER&#39;</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">:</span>
                    <span class="c1"># Add it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atnums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atnums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;change </span><span class="si">%s</span><span class="s2">: Nothing to do&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Changing </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atnums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s2">&quot;Changing </span><span class="si">%s</span><span class="s2"> of atom # </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val_str</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span>

<div class="viewcode-block" id="change.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.change.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atnums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atnums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;change </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> matches no atoms&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">),</span> <span class="n">ParmWarning</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;nb_idx&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;AMBER_ATOM_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;ATOM_TYPE&#39;</span><span class="p">):</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;TREE_CHAIN_CLASSIFICATION&#39;</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;tree&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;RADII&#39;</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="s1">&#39;solvent_radius&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atnums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_val</span><span class="p">)</span>
        <span class="c1"># Update the raw data for any Amber topologies</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">:</span>
                <span class="n">addAtomicNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flag_name</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printInfo"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printInfo">[docs]</a><span class="k">class</span> <span class="nc">printInfo</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints all prmtop data corresponding to the given %FLAG</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;flag&gt;&#39;</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="printInfo.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printInfo.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">FLAG </span><span class="si">%s</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                          <span class="n">SeriousParmWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">found</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># pragma: no cover</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%16.5f</span><span class="s1"> &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-16s</span><span class="s1"> &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">found</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">]):</span>
                <span class="n">ret_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">ret_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret_str</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="addLJType"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addLJType">[docs]</a><span class="k">class</span> <span class="nc">addLJType</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns given mask into a new LJ atom type. It uses the radius and Rmin from</span>
<span class="sd">    the first atom type in &lt;mask&gt; if new_radius or new_epsilon aren&#39;t provided</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;mask&gt; [radius &lt;new_radius&gt;] [epsilon &lt;new_epsilon&gt;] &#39;</span>
             <span class="s1">&#39;[radius_14 &lt;new_radius14&gt;] [epsilon_14 &lt;new_epsilon14&gt;]&#39;</span><span class="p">)</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
<div class="viewcode-block" id="addLJType.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addLJType.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_radius_14</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;radius_14&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon_14</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;epsilon_14&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_radius</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;epsilon&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Making atoms </span><span class="si">%s</span><span class="s1"> into a new LJ atom type&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>

<div class="viewcode-block" id="addLJType.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addLJType.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.addljtype</span> <span class="kn">import</span> <span class="n">AddLJType</span>
        <span class="c1"># Find the first atom that&#39;s selected in this selection. We&#39;ve</span>
        <span class="c1"># already made sure that at least one atom was selected</span>
        <span class="n">sel_atms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sel_atms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="c1"># If either the radius or epsilon were not specified, then pull it</span>
        <span class="c1"># from the *first* atom in the selection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_radius</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon</span>
        <span class="c1"># Now do the same for chamber prmtops</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_radius_14</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_radius_14</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_14_radius</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_radius_14</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon_14</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon_14</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_14_depth</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon_14</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">AddLJType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">sel_atms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">new_radius_14</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_epsilon_14</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">load_atom_info</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="outparm"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outparm">[docs]</a><span class="k">class</span> <span class="nc">outparm</span><span class="p">(</span><span class="n">parmout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints a new prmtop like parmout, but keeps its place in the action stack so</span>
<span class="sd">    several can be written out in 1 parmed session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;prmtop_name&gt; [&lt;inpcrd_name&gt;] [netcdf]&#39;</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printLJTypes"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printLJTypes">[docs]</a><span class="k">class</span> <span class="nc">printLJTypes</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the Lennard Jones type index for the given atom mask or, if no value</span>
<span class="sd">    is given, the LJ type index for each atom.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[&lt;mask&gt;|&lt;type idx&gt;]&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
<div class="viewcode-block" id="printLJTypes.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printLJTypes.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="c1"># Compile the list of indices</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">try_type</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">NoArgument</span><span class="p">:</span>
            <span class="n">try_type</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">try_type</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">NoArgument</span><span class="p">:</span>
                <span class="c1"># Our default is print all indices...</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="s1">&#39;:*&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">type_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">begin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ntypes&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">begin</span> <span class="ow">or</span>
                            <span class="n">begin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ntypes&#39;</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;printLJTypes: Bad atom type range&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ntypes&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;printLJTypes: Bad atom type index&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">field</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Construct the atom selections and related atom types lists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_list</span><span class="p">:</span>
                    <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Nothing to do for printLJTypes&#39;</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">)</span>

        <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">%15s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%4s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;  ATOM NUMBER  &quot;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE&#39;</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;---------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="s1">&#39;ATOM </span><span class="si">%-10d</span><span class="s1"> </span><span class="si">%-4s</span><span class="s1"> </span><span class="si">%-4s</span><span class="s1">: Type index: </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                                                                      <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="scee"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scee">[docs]</a><span class="k">class</span> <span class="nc">scee</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the 1-4 EEL scaling factor in the prmtop</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;scee_value&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="scee.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scee.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scee_value</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Setting default SCEE electrostatic scaling value to </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scee_value</span><span class="p">)</span>

<div class="viewcode-block" id="scee.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scee.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">scee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scee_value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">):</span>
            <span class="n">nptra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;nptra&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span>
                                   <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scee_value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nptra</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scee_value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nptra</span><span class="p">)]</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="scnb"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scnb">[docs]</a><span class="k">class</span> <span class="nc">scnb</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the 1-4 VDW scaling factor in the prmtop</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;scnb_value&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="scnb.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scnb.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scnb_value</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Setting default SCNB van der Waals scaling value to </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scnb_value</span>

<div class="viewcode-block" id="scnb.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scnb.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">scnb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scnb_value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">):</span>
            <span class="n">nptra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;nptra&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span><span class="p">,</span><span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span>
                                   <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scnb_value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nptra</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scnb_value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nptra</span><span class="p">)]</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="changeLJSingleType"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJSingleType">[docs]</a><span class="k">class</span> <span class="nc">changeLJSingleType</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows you to change the radius/well depth of a single LJ type specified by</span>
<span class="sd">    &lt;mask&gt;. Note, this may change more than the atoms selected in just the mask!</span>
<span class="sd">    To find out what else will be changed, look at the output of printLJTypes.</span>

<span class="sd">    Use addLJType to change the Lennard-Jones parameters on a set of specific</span>
<span class="sd">    atoms.</span>

<span class="sd">        - &lt;mask&gt; : The selection of atoms to change the LJ type for. All atoms</span>
<span class="sd">                   selected must have the same LJ type</span>
<span class="sd">        - &lt;radius&gt; : Rmin/2 (van der Waals radius of the new type)</span>
<span class="sd">        - &lt;depth&gt; : Well-depth (a.k.a., epsilon)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask&gt; &lt;radius&gt; &lt;depth&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
<div class="viewcode-block" id="changeLJSingleType.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJSingleType.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_depth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
            <span class="n">first_loc</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">attype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">first_loc</span><span class="p">]</span><span class="o">.</span><span class="n">nb_idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">attype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orig_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">attype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No atoms selected in </span><span class="si">%s</span><span class="s2">. Nothing to do.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Changing </span><span class="si">%s</span><span class="s2"> Lennard-Jones well depth from </span><span class="si">%.4f</span><span class="s2"> to </span><span class="si">%.4f</span><span class="s2"> (kal/mol) and radius from &quot;</span>
                <span class="s2">&quot;</span><span class="si">%.4f</span><span class="s2"> to </span><span class="si">%.4f</span><span class="s2"> (Angstroms)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">orig_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
               <span class="p">)</span>

<div class="viewcode-block" id="changeLJSingleType.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeLJSingleType.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.exceptions</span> <span class="kn">import</span> <span class="n">LJ_TypeError</span>
        <span class="c1"># If this is an empty mask do nothing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="c1"># Make sure we&#39;ve only selected a single atom type with our mask</span>
        <span class="n">attype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attype</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attype</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">LJ_TypeError</span><span class="p">(</span><span class="s1">&#39;changeLJSingleType: Mask has multiple atom types!&#39;</span><span class="p">)</span>
        <span class="c1"># Fill the Lennard-Jones radius and depth arrays to make sure they&#39;re</span>
        <span class="c1"># up-to-date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">fill_LJ</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">attype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">attype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="n">lj_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">attype</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">rij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
            <span class="n">wij</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
            <span class="n">acoef</span> <span class="o">=</span> <span class="n">wij</span> <span class="o">*</span> <span class="n">rij</span> <span class="o">**</span> <span class="mi">12</span>
            <span class="n">bcoef</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wij</span> <span class="o">*</span> <span class="n">rij</span> <span class="o">**</span> <span class="mi">6</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">][</span><span class="n">lj_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">acoef</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">][</span><span class="n">lj_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcoef</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printDetails"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printDetails">[docs]</a><span class="k">class</span> <span class="nc">printDetails</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns information about all atoms in a given mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask&gt;&#39;</span>
<div class="viewcode-block" id="printDetails.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printDetails.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The mask </span><span class="si">%s</span><span class="s2"> matches </span><span class="si">%d</span><span class="s2"> atoms:</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection</span><span class="p">))]</span>
        <span class="c1"># Separate printout for Amoeba-style prmtop files</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmoebaParm</span><span class="p">):</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7s%7s%9s%6s%6s%7s%10s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">,</span> <span class="s1">&#39;RES&#39;</span><span class="p">,</span> <span class="s1">&#39;RESNAME&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;At.#&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass&#39;</span><span class="p">)</span>
                         <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d%7d%9s%6s%6s%7d%10.4f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                              <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                              <span class="n">atm</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
                             <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%7s%7s%9s%6s%6s%7s%12s%12s%10s%10s%10s%10s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">,</span> <span class="s1">&#39;RES&#39;</span><span class="p">,</span> <span class="s1">&#39;RESNAME&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;At.#&#39;</span><span class="p">,</span> <span class="s1">&#39;LJ Radius&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;LJ Depth&#39;</span><span class="p">,</span> <span class="s1">&#39;Mass&#39;</span><span class="p">,</span> <span class="s1">&#39;Charge&#39;</span><span class="p">,</span> <span class="s1">&#39;GB Radius&#39;</span><span class="p">,</span> <span class="s1">&#39;GB Screen&#39;</span><span class="p">)</span>
                         <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%7d%7d%9s%6s%6s%7d%12.4f%12.4f%10.4f%10.4f%10.4f%10.4f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                               <span class="n">atm</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                               <span class="n">atm</span><span class="o">.</span><span class="n">solvent_radius</span><span class="p">,</span> <span class="n">atm</span><span class="o">.</span><span class="n">screen</span><span class="p">)</span>
                             <span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printFlags"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printFlags">[docs]</a><span class="k">class</span> <span class="nc">printFlags</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints all %FLAGs found in the topology file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="printFlags.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printFlags.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">string</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">FLAG </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printPointers"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printPointers">[docs]</a><span class="k">class</span> <span class="nc">printPointers</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints a list of all the POINTERS and their values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="printPointers.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printPointers.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ptrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">]</span>
        <span class="n">ret_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">NATOM (number of atoms in system)................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NTYPES (number of atom type names)...............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NBONH (number of bonds containing H).............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">MBONA (number of bonds without H)................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NTHETH (number of angles containing H)...........= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">MTHETA (number of angles without H)..............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NPHIH (number of dihedrals containing H).........= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">MPHIA (number of dihedrals without H)............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NHPARM (currently unused)........................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NPARM (1 if made with addles, 0 if not)..........= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NNB (number of excluded atoms)...................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NRES (number of residues in system)..............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NBONA (MBONA + constraint bonds).................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NTHETA (MTHETA + constraint angles)..............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NPHIA (MPHIA + constraint dihedrals).............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NUMBND (number of unique bond types).............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NUMANG (number of unique angle types)............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NPTRA (number of unique dihedral types)..........= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NATYP (number of nonbonded atom types)...........= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NPHB (number of distinct 10-12 H-bond pairs).....= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">IFPERT (1 if prmtop is perturbed; not used)......= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NBPER (perturbed bonds; not used)................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NGPER (perturbed angles; not used)...............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NDPER (perturbed dihedrals; not used)............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">MBPER (bonds in perturbed group; not used).......= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">MGPER (angles in perturbed group; not used)......= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">MDPER (diheds in perturbed group; not used)......= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">IFBOX (Type of box: 1=orthogonal, 2=not, 0=none).= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NMXRS (number of atoms in largest residue).......= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">IFCAP (1 if solvent cap exists)..................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NUMEXTRA (number of extra points in topology)....= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ptrs</span><span class="p">[:</span><span class="mi">31</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">ret_str</span> <span class="o">+=</span> <span class="s2">&quot;NCOPY (number of PIMD slices/number of beads)....= </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ptrs</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;IFBOX&#39;</span><span class="p">):</span>
            <span class="n">ret_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SOLVENT POINTERS</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">IPTRES (Final solute residue)....................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NSPM (Total number of molecules).................= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">NSPSOL (The first solvent &quot;molecule&quot;)............= </span><span class="si">%d</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ret_str</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="setMolecules"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setMolecules">[docs]</a><span class="k">class</span> <span class="nc">setMolecules</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the molecularity of the system based on the bonding network and</span>
<span class="sd">    correctly determines the SOLVENT_POINTERS and ATOMS_PER_MOLECULE sections of</span>
<span class="sd">    the topology file. It will consider the ions to be part of the solute if</span>
<span class="sd">    True is passed or not if False is passed. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[solute_ions True|False]&#39;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="setMolecules.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setMolecules.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="c1"># Allow solute_ions to be a keyword argument or the only argument.</span>
        <span class="c1"># Default is True</span>
        <span class="n">solute_ions</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;solute_ions&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">solute_ions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solute_ions</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solute_ions</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solute_ions</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">solute_ions</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solute_ions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Value of solute_ions is unrecognized [</span><span class="si">%s</span><span class="s2">]! Assuming True&quot;</span> <span class="o">%</span> <span class="n">solute_ions</span><span class="p">,</span>
                          <span class="n">SeriousParmWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solute_ions</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># pragma: no cover</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Setting MOLECULE properties of the prmtop (SOLVENT_POINTERS &quot;</span>
                <span class="s2">&quot;and ATOMS_PER_MOLECULE)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="setMolecules.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setMolecules.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">rediscover_molecules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_ions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The atoms in </span><span class="si">%s</span><span class="s1"> were reordered to correct molecule ordering. Any &#39;</span>
                              <span class="s1">&#39;topology printed from now on will *not* work with the original &#39;</span>
                              <span class="s1">&#39;inpcrd or trajectory files created with this prmtop! Consider &#39;</span>
                              <span class="s1">&#39;quitting and loading a restart prior to using setMolecules&#39;</span> <span class="o">%</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">ParmWarning</span><span class="p">)</span>
            <span class="c1"># If we had to reorder our atoms, we need to remake our parm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">load_pointers</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="c1">#</span>
<span class="c1">#class addCoarseGrain(Action):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Adds coarse graining information to the Amber topology file according to</span>
<span class="c1">#    a given coarse graining parameter file</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    strictly_supported = (AmberParm,)</span>
<span class="c1">#    usage = &#39;&lt;parameter_file&gt;</span>
<span class="c1">#    def init(self, arg_list):</span>
<span class="c1">#        self.cg_param_file = arg_list.get_next_string()</span>
<span class="c1">#        if not os.path.exists(self.cg_param_file):</span>
<span class="c1">#            raise CoarseGrainError(&#39;Cannot find parameter file %s&#39; %</span>
<span class="c1">#                                    self.cg_param_file)</span>
<span class="c1">#        # Check to see if we&#39;ve already made this a coarsegrained file...</span>
<span class="c1">#        if &#39;ANGLE_COEF_A&#39; in self.parm.flag_list:</span>
<span class="c1">#            warnings.warn(&#39;Prmtop already has coarse grained sections&#39;,</span>
<span class="c1">#                        ParmWarning)</span>
<span class="c1">#</span>
<span class="c1">#    def __str__(self):</span>
<span class="c1">#        return (&quot;Setting up coarse graining for topology file using parameter &quot;</span>
<span class="c1">#                &quot;file &quot; + self.cg_param_file)</span>
<span class="c1">#</span>
<span class="c1">#    def execute(self):</span>
<span class="c1">#        from parmed.tools.coarsegrain import addCoarseGrain as addCG</span>
<span class="c1">#        if &#39;ANGLE_COEF_A&#39; in self.parm.flag_list: return</span>
<span class="c1">#        addCG(self.parm, self.cg_param_file)</span>
<span class="c1">#</span>
<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="changeProtState"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeProtState">[docs]</a><span class="k">class</span> <span class="nc">changeProtState</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the protonation state of a given titratable residue that can be</span>
<span class="sd">    treated via constant pH MD in Amber.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask&gt; &lt;state #&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="changeProtState.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeProtState.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_int</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No residues selected for state change&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">residue</span>
        <span class="k">return</span> <span class="s1">&#39;Changing protonation state of residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_ash_glh</span><span class="p">(</span><span class="n">residues</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds ASH and GLH to the titratable residue list unless it&#39;s already</span>
<span class="sd">        there</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;ASH&#39;</span> <span class="ow">in</span> <span class="n">residues</span><span class="o">.</span><span class="n">titratable_residues</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">dummyrefene1</span> <span class="o">=</span> <span class="n">residues</span><span class="o">.</span><span class="n">_ReferenceEnergy</span><span class="p">()</span>
        <span class="n">dummyrefene1_old</span> <span class="o">=</span> <span class="n">residues</span><span class="o">.</span><span class="n">_ReferenceEnergy</span><span class="p">()</span>
        <span class="n">dummyrefene1_old</span><span class="o">.</span><span class="n">set_pKa</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">dummyrefene2</span> <span class="o">=</span> <span class="n">residues</span><span class="o">.</span><span class="n">_ReferenceEnergy</span><span class="p">()</span>
        <span class="n">atomnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;HA&#39;</span><span class="p">,</span> <span class="s1">&#39;CB&#39;</span><span class="p">,</span> <span class="s1">&#39;HB2&#39;</span><span class="p">,</span> <span class="s1">&#39;HB3&#39;</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="s1">&#39;OD1&#39;</span><span class="p">,</span> <span class="s1">&#39;OD2&#39;</span><span class="p">,</span> <span class="s1">&#39;HD21&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">]</span>
        <span class="n">ash</span> <span class="o">=</span> <span class="n">residues</span><span class="o">.</span><span class="n">TitratableResidue</span><span class="p">(</span><span class="s1">&#39;ASH&#39;</span><span class="p">,</span> <span class="n">atomnames</span><span class="p">,</span> <span class="n">pka</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s2">&quot;ph&quot;</span><span class="p">)</span>
        <span class="n">ash</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">protcnt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">refene</span><span class="o">=</span><span class="n">dummyrefene1</span><span class="p">,</span> <span class="n">refene_old</span><span class="o">=</span><span class="n">dummyrefene1_old</span><span class="p">,</span> <span class="n">pka_corr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                      <span class="n">charges</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.4157</span><span class="p">,</span> <span class="mf">0.2719</span><span class="p">,</span> <span class="mf">0.0341</span><span class="p">,</span> <span class="mf">0.0864</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1783</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0122</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0122</span><span class="p">,</span> <span class="mf">0.7994</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">0.8014</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8014</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5973</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5679</span><span class="p">]</span>
                     <span class="p">)</span>
        <span class="n">ash</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">protcnt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">refene</span><span class="o">=</span><span class="n">dummyrefene2</span><span class="p">,</span> <span class="n">refene_old</span><span class="o">=</span><span class="n">dummyrefene2</span><span class="p">,</span> <span class="n">pka_corr</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                      <span class="n">charges</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.4157</span><span class="p">,</span> <span class="mf">0.2719</span><span class="p">,</span> <span class="mf">0.0341</span><span class="p">,</span> <span class="mf">0.0864</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0316</span><span class="p">,</span> <span class="mf">0.0488</span><span class="p">,</span> <span class="mf">0.0488</span><span class="p">,</span> <span class="mf">0.6462</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">0.5554</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6376</span><span class="p">,</span> <span class="mf">0.4747</span><span class="p">,</span> <span class="mf">0.5973</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5679</span><span class="p">]</span>
                     <span class="p">)</span>
        <span class="n">ash</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>

        <span class="n">atomnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;HA&#39;</span><span class="p">,</span> <span class="s1">&#39;CB&#39;</span><span class="p">,</span> <span class="s1">&#39;HB2&#39;</span><span class="p">,</span> <span class="s1">&#39;HB3&#39;</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="s1">&#39;HG2&#39;</span><span class="p">,</span> <span class="s1">&#39;HG3&#39;</span><span class="p">,</span> <span class="s1">&#39;CD&#39;</span><span class="p">,</span> <span class="s1">&#39;OE1&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;OE2&#39;</span><span class="p">,</span> <span class="s1">&#39;HE21&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">]</span>
        <span class="n">glh</span> <span class="o">=</span> <span class="n">residues</span><span class="o">.</span><span class="n">TitratableResidue</span><span class="p">(</span><span class="s1">&#39;GLH&#39;</span><span class="p">,</span> <span class="n">atomnames</span><span class="p">,</span> <span class="n">pka</span><span class="o">=</span><span class="mf">4.4</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s2">&quot;ph&quot;</span><span class="p">)</span>
        <span class="n">glh</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">protcnt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">refene</span><span class="o">=</span><span class="n">dummyrefene1</span><span class="p">,</span> <span class="n">refene_old</span><span class="o">=</span><span class="n">dummyrefene1_old</span><span class="p">,</span> <span class="n">pka_corr</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                      <span class="n">charges</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.4157</span><span class="p">,</span> <span class="mf">0.2719</span><span class="p">,</span> <span class="mf">0.0145</span><span class="p">,</span> <span class="mf">0.0779</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0398</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0173</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0173</span><span class="p">,</span> <span class="mf">0.0136</span><span class="p">,</span>
                               <span class="o">-</span><span class="mf">0.0425</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0425</span><span class="p">,</span> <span class="mf">0.8054</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8188</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8188</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5973</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5679</span><span class="p">]</span>
                     <span class="p">)</span>
        <span class="n">glh</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">protcnt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">refene</span><span class="o">=</span><span class="n">dummyrefene2</span><span class="p">,</span> <span class="n">refene_old</span><span class="o">=</span><span class="n">dummyrefene2</span><span class="p">,</span> <span class="n">pka_corr</span><span class="o">=</span><span class="mf">4.4</span><span class="p">,</span>
                      <span class="n">charges</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.4157</span><span class="p">,</span> <span class="mf">0.2719</span><span class="p">,</span> <span class="mf">0.0145</span><span class="p">,</span> <span class="mf">0.0779</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0071</span><span class="p">,</span> <span class="mf">0.0256</span><span class="p">,</span> <span class="mf">0.0256</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0174</span><span class="p">,</span>
                               <span class="mf">0.0430</span><span class="p">,</span> <span class="mf">0.0430</span><span class="p">,</span> <span class="mf">0.6801</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5838</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6511</span><span class="p">,</span> <span class="mf">0.4641</span><span class="p">,</span> <span class="mf">0.5973</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5679</span><span class="p">]</span>
                     <span class="p">)</span>
        <span class="n">glh</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
        <span class="n">residues</span><span class="o">.</span><span class="n">ASH</span><span class="p">,</span> <span class="n">residues</span><span class="o">.</span><span class="n">GLH</span> <span class="o">=</span> <span class="n">ash</span><span class="p">,</span> <span class="n">glh</span>
        <span class="n">residues</span><span class="o">.</span><span class="n">titratable_residues</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;ASH&#39;</span><span class="p">,</span> <span class="s1">&#39;GLH&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="changeProtState.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeProtState.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.amber</span> <span class="kn">import</span> <span class="n">titratable_residues</span> <span class="k">as</span> <span class="n">residues</span>
        <span class="n">changeProtState</span><span class="o">.</span><span class="n">_add_ash_glh</span><span class="p">(</span><span class="n">residues</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="c1"># If we didn&#39;t select any residues, just return</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">residue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">residue</span>
        <span class="n">resname</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Get the charges from cpin_data. The first 2 elements are energy and</span>
        <span class="c1"># proton count so the charges are chgs[2:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resname</span> <span class="ow">in</span> <span class="n">residues</span><span class="o">.</span><span class="n">titratable_residues</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s2">&quot;Residue </span><span class="si">%s</span><span class="s2"> isn&#39;t defined as a titratable &quot;</span>
                                   <span class="s2">&quot;residue in titratable_residues.py&quot;</span> <span class="o">%</span> <span class="n">resname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">resname</span><span class="p">)</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;ph&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;Redidue </span><span class="si">%s</span><span class="s1"> is not a pH titratable residue&#39;</span> <span class="o">%</span> <span class="n">resname</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">resname</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;Residue </span><span class="si">%s</span><span class="s1"> only has titratable states 0--</span><span class="si">%d</span><span class="s1">. You chose state </span><span class="si">%d</span><span class="s1">&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">charges</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;You must select one and only one entire titratable residue&#39;</span><span class="p">)</span>

        <span class="n">charges</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">charges</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sel</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;You must select 1 and only 1 entire residue of which to &#39;</span>
                                       <span class="s1">&#39;change the protonation state&#39;</span><span class="p">)</span>
            <span class="c1"># Actually make the change</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">][</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div></div>
            
<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="changeRedoxState"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeRedoxState">[docs]</a><span class="k">class</span> <span class="nc">changeRedoxState</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the reduction state of a given titratable residue that can be</span>
<span class="sd">    treated via constant redox potential MD in Amber.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask&gt; &lt;state #&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="changeRedoxState.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeRedoxState.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_int</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No residues selected for state change&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">residue</span>
        <span class="k">return</span> <span class="s1">&#39;Changing reduction state of residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="changeRedoxState.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.changeRedoxState.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.amber</span> <span class="kn">import</span> <span class="n">titratable_residues</span> <span class="k">as</span> <span class="n">residues</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="c1"># If we didn&#39;t select any residues, just return</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">residue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">residue</span>
        <span class="n">resname</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Get the charges from cein_data. The first 2 elements are energy and</span>
        <span class="c1"># electron count so the charges are chgs[2:]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resname</span> <span class="ow">in</span> <span class="n">residues</span><span class="o">.</span><span class="n">titratable_residues</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s2">&quot;Residue </span><span class="si">%s</span><span class="s2"> isn&#39;t defined as a titratable &quot;</span>
                                   <span class="s2">&quot;residue in titratable_residues.py&quot;</span> <span class="o">%</span> <span class="n">resname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">resname</span><span class="p">)</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;redox&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;Redidue </span><span class="si">%s</span><span class="s1"> is not a redox potential titratable residue&#39;</span> <span class="o">%</span> <span class="n">resname</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">resname</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;Residue </span><span class="si">%s</span><span class="s1"> only has titratable states 0--</span><span class="si">%d</span><span class="s1">. You chose state </span><span class="si">%d</span><span class="s1">&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">charges</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;You must select one and only one entire titratable residue&#39;</span><span class="p">)</span>

        <span class="n">charges</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">charges</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sel</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ChangeStateError</span><span class="p">(</span><span class="s1">&#39;You must select 1 and only 1 entire residue of which to &#39;</span>
                                       <span class="s1">&#39;change the reduction state&#39;</span><span class="p">)</span>
            <span class="c1"># Actually make the change</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">][</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="netCharge"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.netCharge">[docs]</a><span class="k">class</span> <span class="nc">netCharge</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the total charge of all of the atoms given by the mask. Defaults to all atoms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[&lt;mask&gt;]&#39;</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
<div class="viewcode-block" id="netCharge.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.netCharge.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;:*&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;The net charge of </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
            <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selected</span><span class="p">()]))</span>

<div class="viewcode-block" id="netCharge.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.netCharge.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates the charge of all atoms selected in mask &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selected</span><span class="p">()])</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="strip"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.strip">[docs]</a><span class="k">class</span> <span class="nc">strip</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the atoms specified by &lt;mask&gt; from the topology file and rebuilds</span>
<span class="sd">    the topology file according to the parameters that remain. If nobox is</span>
<span class="sd">    provided, the unit cell information is discarded (useful when stripping</span>
<span class="sd">    solvent to run an aperiodic implicit solvent calculation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask&gt; [nobox]&#39;</span>
<div class="viewcode-block" id="strip.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.strip.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobox</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;nobox&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Removing mask &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%d</span><span class="s2"> atoms) from the topology file.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobox</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Deleting box info.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span>

<div class="viewcode-block" id="strip.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.strip.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobox</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="kc">None</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="defineSolvent"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.defineSolvent">[docs]</a><span class="k">class</span> <span class="nc">defineSolvent</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows you to change what parmed will consider to be &quot;solvent&quot;.</span>
<span class="sd">    &lt;residue list&gt; must be a comma-separated set of residue names with no</span>
<span class="sd">    spaces between them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;residue_list&gt;&#39;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="defineSolvent.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.defineSolvent.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">residue</span>
        <span class="n">res_list</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="n">res_list</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res_list</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_list</span> <span class="o">=</span> <span class="n">res_list</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_list</span> <span class="o">=</span> <span class="n">res_list</span>
        <span class="n">residue</span><span class="o">.</span><span class="n">SOLVENT_NAMES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Residues </span><span class="si">%s</span><span class="s2"> are now considered to be solvent&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_list</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="addExclusions"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addExclusions">[docs]</a><span class="k">class</span> <span class="nc">addExclusions</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows you to add arbitrary exclusions to the exclusion list. Every atom in</span>
<span class="sd">    &lt;mask2&gt; is added to the exclusion list for each atom in &lt;mask1&gt; so that</span>
<span class="sd">    non-bonded interactions between those atom pairs will not be computed. NOTE</span>
<span class="sd">    that this ONLY applies to direct-space (short-range) non-bonded potentials.</span>
<span class="sd">    For PME simulations, long-range electrostatics between these atom pairs are</span>
<span class="sd">    still computed (in different unit cells).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="addExclusions.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addExclusions.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Adding atoms from </span><span class="si">%s</span><span class="s1"> to exclusion lists of atoms in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">)</span>

<div class="viewcode-block" id="addExclusions.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addExclusions.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Loop through both selections and add each selected atom in sel2 to</span>
        <span class="c1"># the exclusion list for selected atoms in sel1 (and vice-versa).</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selected</span><span class="p">():</span>
            <span class="n">atm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selected</span><span class="p">():</span>
                <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="c1"># Skip over atm1 == atm2</span>
                <span class="k">if</span> <span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm2</span><span class="p">:</span> <span class="k">continue</span>
                <span class="c1"># Add each other to each other&#39;s exclusion lists.</span>
                <span class="n">atm1</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">atm2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printBonds"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printBonds">[docs]</a><span class="k">class</span> <span class="nc">printBonds</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints all of the bonds (with their details) for the given atoms in the</span>
<span class="sd">    mask. If a second mask is given, only bonds in which one atom appears in</span>
<span class="sd">    *each* list will be printed. If coordinates and parameter types are present,</span>
<span class="sd">    also print the actual distance (in Angstroms) and energy (in kcal/mol) for</span>
<span class="sd">    each printed bond.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[&lt;mask&gt; [&lt;mask&gt;] ]&#39;</span>
<div class="viewcode-block" id="printBonds.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printBonds.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%19s</span><span class="s1"> </span><span class="si">%19s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="s1">&#39;Atom 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom 2&#39;</span><span class="p">,</span> <span class="s1">&#39;R eq&#39;</span><span class="p">,</span> <span class="s1">&#39;Frc Cnst&#39;</span><span class="p">)]</span>
        <span class="c1"># Loop through all of the bonds without and inc hydrogen</span>
        <span class="n">atomsel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
        <span class="n">atomsel2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
        <span class="n">do_measured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">do_energy</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;Distance&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel2</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel2</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) </span><span class="si">%10.4f</span><span class="s1"> </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) </span><span class="si">%-10s</span><span class="s1"> </span><span class="si">%-10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bond</span><span class="o">.</span><span class="n">measure</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bond</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printAngles"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printAngles">[docs]</a><span class="k">class</span> <span class="nc">printAngles</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints all of the angles (with their details) for the given atoms in the</span>
<span class="sd">    mask. If a second mask is given, only atoms whose central atom is in the</span>
<span class="sd">    second mask and another atom is in the first mask is printed. If a third</span>
<span class="sd">    mask is given, the central atom must be in the second mask and the other two</span>
<span class="sd">    atoms must appear in the first *and* third masks (in any order).</span>

<span class="sd">    If coordinates and parameter types are present, the value of the angle (in</span>
<span class="sd">    degrees) and its energy (in kcal/mol) are reported for each printed angle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[&lt;mask&gt; [&lt;mask&gt; [&lt;mask&gt;] ] ]&#39;</span>
<div class="viewcode-block" id="printAngles.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printAngles.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;:*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">arg2</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">arg3</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one_arg</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">arg3</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg3</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%19s</span><span class="s1">  </span><span class="si">%19s</span><span class="s1">  </span><span class="si">%19s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="s1">&#39;Atom 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Frc Cnst&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta eq&#39;</span><span class="p">)]</span>
        <span class="n">do_measured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">do_energy</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;Angle&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_arg</span><span class="p">:</span>
            <span class="n">atomsel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">atomsel</span><span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atomsel</span><span class="p">[</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="n">atomsel</span><span class="p">[</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                           <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                           <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%-10s</span><span class="s1"> </span><span class="si">%-10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                           <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">angle</span><span class="o">.</span><span class="n">measure</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">angle</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atomsel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="n">atomsel2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="n">atomsel3</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">,</span> <span class="n">atom3</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span>
                <span class="k">if</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomsel2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomsel3</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel3</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel3</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1"> </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                           <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
                           <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%-10s</span><span class="s1"> </span><span class="si">%-10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                           <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">angle</span><span class="o">.</span><span class="n">measure</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">angle</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printDihedrals"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printDihedrals">[docs]</a><span class="k">class</span> <span class="nc">printDihedrals</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints all of the dihedrals (with their details) for the given atoms in the</span>
<span class="sd">    mask. If multiple masks are given, only dihedrals that have one atom in each</span>
<span class="sd">    mask are printed. Ordering is important here, so the first atom must be in</span>
<span class="sd">    the first mask, the second atom in the second, etc. The order can be</span>
<span class="sd">    precisely reversed, but no other ordering is recognized.</span>

<span class="sd">    If coordinates and parameter types are present, the value of the torsion</span>
<span class="sd">    angle (in degrees) and the energy of each dihedral (in kcal/mol) are</span>
<span class="sd">    reported for each printed dihedral.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[&lt;mask&gt; [&lt;mask&gt; [&lt;mask&gt; [&lt;mask&gt;] ] ] ]&#39;</span>
<div class="viewcode-block" id="printDihedrals.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printDihedrals.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;:*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">arg2</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">arg3</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">arg4</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one_mask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">arg3</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arg4</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">arg4</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg4</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%21s</span><span class="s1">  </span><span class="si">%19s</span><span class="s1">  </span><span class="si">%19s</span><span class="s1">  </span><span class="si">%19s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s1">&#39;Atom 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">,</span> <span class="s1">&#39;Periodic.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Phase&#39;</span><span class="p">,</span> <span class="s1">&#39;EEL Scale&#39;</span><span class="p">,</span> <span class="s1">&#39;VDW Scale&#39;</span><span class="p">)]</span>
        <span class="n">do_measured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">do_energy</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">DihedralType</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;Dihedral&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Loop through all of the bonds without and inc hydrogen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_mask</span><span class="p">:</span>
            <span class="n">atomsel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom2</span>
                <span class="n">atom3</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom3</span>
                <span class="n">atom4</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">atomsel</span><span class="p">[</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atomsel</span><span class="p">[</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="ow">or</span>
                        <span class="n">atomsel</span><span class="p">[</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="ow">or</span> <span class="n">atomsel</span><span class="p">[</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">]):</span>
                    <span class="k">continue</span>

                <span class="c1"># Determine if it&#39;s an Improper, Multiterm, or neither</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmoebaParm</span><span class="p">):</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                    <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                    <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                    <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                <span class="k">elif</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                        <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">per</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                <span class="k">elif</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                        <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">per</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                        <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">per</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1s</span><span class="s1"> </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) &#39;</span>
                           <span class="s1">&#39; </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">k</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">measure</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atomsel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="n">atomsel2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="n">atomsel3</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="n">atomsel4</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="o">.</span><span class="n">Selected</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="n">atom1</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span>
                <span class="n">atom2</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom2</span>
                <span class="n">atom3</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom3</span>
                <span class="n">atom4</span> <span class="o">=</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span>
                <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomsel4</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel2</span> <span class="ow">and</span>
                    <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel3</span> <span class="ow">and</span> <span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel4</span><span class="p">):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel4</span> <span class="ow">and</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel3</span> <span class="ow">and</span>
                    <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel2</span> <span class="ow">and</span> <span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomsel</span><span class="p">):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmoebaParm</span><span class="p">):</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                    <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                    <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                    <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                <span class="k">elif</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                        <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">per</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                <span class="k">elif</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                        <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">per</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span>
                        <span class="n">per</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span>
                        <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">per</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1s</span><span class="s1"> </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;(</span><span class="si">%4s</span><span class="s1">)  </span><span class="si">%7d</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> (</span><span class="si">%4s</span><span class="s1">) </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;</span><span class="si">%10s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">atom1</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom3</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">atom4</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom4</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">do_measured</span><span class="p">:</span>
                    <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">measure</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">do_energy</span><span class="p">:</span>
                        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%10.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="setBond"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setBond">[docs]</a><span class="k">class</span> <span class="nc">setBond</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes (or adds a non-existent) bond in the topology file. Each mask must</span>
<span class="sd">    select the same number of atoms, and a bond will be placed between the</span>
<span class="sd">    atoms in mask1 and mask2 (one bond between atom1 from mask1 and atom1</span>
<span class="sd">    from mask2 and another bond between atom2 from mask1 and atom2 from mask2,</span>
<span class="sd">    etc.)</span>

<span class="sd">        - &lt;mask1&gt; : Selection of first atoms in each bond</span>
<span class="sd">        - &lt;mask2&gt; : Selection of second atoms in each bond</span>
<span class="sd">        - &lt;k&gt; : Force constant (kcal/mol/A^2) in energy expression k(R-Req)^2</span>
<span class="sd">        - &lt;Req&gt; : Equilibrium distance (A)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt; &lt;k&gt; &lt;Req&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="setBond.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setBond.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Set a bond between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> with k = </span><span class="si">%f</span><span class="s1"> kcal/(mol Angstrom&#39;</span>
                <span class="s1">&#39;**2) and Req = </span><span class="si">%f</span><span class="s1"> Angstroms&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="p">)</span>

<div class="viewcode-block" id="setBond.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setBond.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sel1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SetParamError</span><span class="p">(</span><span class="s1">&#39;setBond: Each mask must select the same &#39;</span>
                                <span class="s1">&#39;number of atoms!&#39;</span><span class="p">)</span>

        <span class="c1"># If no atoms, nothing to do</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Create the new bond type</span>
        <span class="n">new_bnd_typ</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="p">)</span>
        <span class="c1"># Does that bond type exist in the list already? If it does, re-bind</span>
        <span class="c1"># new_bnd to that bond type reference</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">bnd_typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bond_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_bnd_typ</span> <span class="o">==</span> <span class="n">bnd_typ</span><span class="p">:</span>
                <span class="n">new_bnd_typ</span> <span class="o">=</span> <span class="n">bnd_typ</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="c1"># If the bond is new, add it to the type list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_bnd_typ</span><span class="p">)</span>
            <span class="n">new_bnd_typ</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bond_types</span>

        <span class="n">atnum1</span><span class="p">,</span> <span class="n">atnum2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Loop through all of the selected atoms</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)):</span>
            <span class="c1"># Collect the atoms involved</span>
            <span class="n">atnum1</span> <span class="o">=</span> <span class="n">sel1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum2</span> <span class="o">=</span> <span class="n">sel2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum1</span><span class="p">]</span>
            <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum2</span><span class="p">]</span>

            <span class="c1"># See if the bond exists in the first place, and if so, replace its</span>
            <span class="c1"># bond type with our new bond type (new_bnd)</span>
            <span class="k">if</span> <span class="n">atm2</span> <span class="ow">in</span> <span class="n">atm1</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">and</span> <span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atm1</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atm2</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                        <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_bnd_typ</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="c1"># Otherwise, it doesn&#39;t exist, so we just create a new one</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bond</span><span class="p">(</span><span class="n">atm1</span><span class="p">,</span> <span class="n">atm2</span><span class="p">,</span> <span class="n">new_bnd_typ</span><span class="p">))</span>
        <span class="c1"># Make sure we update 1-4 exception handling if we created any rings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">update_dihedral_exclusions</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="setAngle"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setAngle">[docs]</a><span class="k">class</span> <span class="nc">setAngle</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes (or adds a non-existent) angle in the topology file. Each mask must</span>
<span class="sd">    select the same number of atoms, and an angle will be placed between the</span>
<span class="sd">    atoms in mask1, mask2, and mask3 (one angle between atom1 from mask1, atom1</span>
<span class="sd">    from mask2, and atom1 from mask3, another angle between atom2 from mask1,</span>
<span class="sd">    atom2 from mask2, and atom2 from mask3, etc.)</span>

<span class="sd">        - &lt;mask1&gt; : The selection of one of the end-atoms in each angle</span>
<span class="sd">        - &lt;mask2&gt; : The selection of central atoms in each angle</span>
<span class="sd">        - &lt;mask3&gt; : The selection of other end-atoms in each angle</span>
<span class="sd">        - &lt;k&gt; : Force constant in kcal/mol/radians^2 in energy expression</span>
<span class="sd">                k(THET - THETeq)^2</span>
<span class="sd">        - &lt;THETeq&gt; : Equilibrium angle (in *degrees*)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt; &lt;mask3&gt; &lt;k&gt; &lt;THETeq&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="setAngle.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setAngle.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theteq</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Set an angle between </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> with k = </span><span class="si">%f</span><span class="s1"> kcal/(mol &#39;</span>
                <span class="s1">&#39;rad**2) and THETeq = </span><span class="si">%f</span><span class="s1"> degrees&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theteq</span><span class="p">)</span>

<div class="viewcode-block" id="setAngle.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.setAngle.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sel1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SetParamError</span><span class="p">(</span><span class="s1">&#39;Each mask in setAngle must select the same &#39;</span>
                                <span class="s1">&#39;number of atoms!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Create the new angle type</span>
        <span class="n">new_ang_typ</span> <span class="o">=</span> <span class="n">AngleType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theteq</span><span class="p">)</span>
        <span class="c1"># Does that angle type exist in the list already? If it does, re-bind</span>
        <span class="c1"># new_ang to that angle type reference</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ang_typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angle_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_ang_typ</span> <span class="o">==</span> <span class="n">ang_typ</span><span class="p">:</span>
                <span class="n">new_ang_typ</span> <span class="o">=</span> <span class="n">ang_typ</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="c1"># If the angle is new, add it to the type list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_ang_typ</span><span class="p">)</span>
            <span class="n">new_ang_typ</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angle_types</span>

        <span class="n">atnum1</span><span class="p">,</span> <span class="n">atnum2</span><span class="p">,</span> <span class="n">atnum3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Loop through all of the selections</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)):</span>
            <span class="c1"># Collect the atoms involved</span>
            <span class="n">atnum1</span> <span class="o">=</span> <span class="n">sel1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum2</span> <span class="o">=</span> <span class="n">sel2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum3</span> <span class="o">=</span> <span class="n">sel3</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum1</span><span class="p">]</span>
            <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum2</span><span class="p">]</span>
            <span class="n">atm3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum3</span><span class="p">]</span>

            <span class="c1"># See if the angle exists in the first place, and if so, replace its</span>
            <span class="c1"># angle type with our new angle type (new_ang)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm3</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="n">atm1</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atm2</span> <span class="ow">in</span> <span class="n">ang</span> <span class="ow">and</span> <span class="n">atm3</span> <span class="ow">in</span> <span class="n">ang</span><span class="p">:</span>
                        <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_ang_typ</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="c1"># If not found, create a new angle</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Angle</span><span class="p">(</span><span class="n">atm1</span><span class="p">,</span> <span class="n">atm2</span><span class="p">,</span> <span class="n">atm3</span><span class="p">,</span> <span class="n">new_ang_typ</span><span class="p">))</span>
        <span class="c1"># Make sure we update 1-4 exception handling if we created any rings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">update_dihedral_exclusions</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="addDihedral"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addDihedral">[docs]</a><span class="k">class</span> <span class="nc">addDihedral</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a dihedral between mask1, mask2, mask3, and mask4. Each mask must</span>
<span class="sd">    specify the same number of atoms, and the dihedral is defined around the</span>
<span class="sd">    bond between atoms in mask 2 and 3. If each mask selects 2 atoms, for</span>
<span class="sd">    instance, a dihedral will be placed around atom1 in mask 1, atom1 in mask 2,</span>
<span class="sd">    atom1 in mask 3, and atom1 in mask 4.  A second dihedral will be placed</span>
<span class="sd">    around atom2 in mask 1, atom2 in mask 2, atom2 in mask 3, and atom2 in</span>
<span class="sd">    mask4.</span>

<span class="sd">        - &lt;mask1&gt; : Selection of one of the end-atoms for each dihedral</span>
<span class="sd">        - &lt;mask2&gt; : Selection of the middle atom bonded to &lt;mask1&gt; and</span>
<span class="sd">                    &lt;mask3&gt; in each dihedral</span>
<span class="sd">        - &lt;mask3&gt; : Selection of the other middle atom bonded to &lt;mask2&gt;</span>
<span class="sd">                    and &lt;mask4&gt;</span>
<span class="sd">        - &lt;mask4&gt; : Selection of the other end-atom in each dihedral</span>
<span class="sd">        - &lt;phi_k&gt; : Force constant in kcal/mol</span>
<span class="sd">        - &lt;per&gt; : Periodicity</span>
<span class="sd">        - &lt;phase&gt; : Torsion phase shift</span>
<span class="sd">        - &lt;scnb&gt; : 1-4 Lennard-Jones scaling constant (default 2.0)</span>
<span class="sd">        - &lt;scee&gt; : 1-4 electrostatic scaling constant (default 1.2)</span>
<span class="sd">        - &lt;type&gt; : Type of dihedral, either &quot;improper&quot; or &quot;normal&quot;.</span>
<span class="sd">                   Default is &quot;normal&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt; &lt;mask3&gt; &lt;mask4&gt; &lt;phi_k&gt; &lt;per&gt; &lt;phase&gt; [&lt;scee&gt;] &#39;</span>
             <span class="s1">&#39;[&lt;scnb&gt;] [type &lt;type&gt;]&#39;</span><span class="p">)</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>

<div class="viewcode-block" id="addDihedral.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addDihedral.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_k</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scee</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scnb</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="n">dihed_type</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dihed_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dihed_type</span><span class="p">)]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">improper</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;a normal&#39;</span>
        <span class="k">elif</span> <span class="n">dihed_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;improper&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dihed_type</span><span class="p">)]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">improper</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;an improper&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;addDihedral: type must be &quot;normal&quot; or &quot;improper&quot;&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Set </span><span class="si">%s</span><span class="s1"> dihedral between </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, and </span><span class="si">%s</span><span class="s1"> with phi_k = </span><span class="si">%f</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;kcal/mol periodicity = </span><span class="si">%f</span><span class="s1"> phase = </span><span class="si">%f</span><span class="s1"> degrees scee = </span><span class="si">%f</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;scnb = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scnb</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="addDihedral.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addDihedral.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sel1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel3</span><span class="p">)</span> <span class="ow">or</span>
                                      <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel4</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">SetParamError</span><span class="p">(</span><span class="s1">&#39;addDihedral: Each mask must select the same &#39;</span>
                                <span class="s1">&#39;number of atoms!&#39;</span><span class="p">)</span>

        <span class="c1"># If we do nothing, just return</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># Create the new dihedral type</span>
        <span class="n">new_dih_typ</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">scnb</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Do not add a duplicate dihedral type</span>
        <span class="k">for</span> <span class="n">dih_typ</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_dih_typ</span> <span class="o">==</span> <span class="n">dih_typ</span><span class="p">:</span>
                <span class="n">new_dih_typ</span> <span class="o">=</span> <span class="n">dih_typ</span>
                <span class="n">exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_dih_typ</span><span class="p">)</span>
            <span class="n">new_dih_typ</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedral_types</span>

        <span class="c1"># Loop through all of the atoms</span>
        <span class="n">atnum1</span><span class="p">,</span> <span class="n">atnum2</span><span class="p">,</span> <span class="n">atnum3</span><span class="p">,</span> <span class="n">atnum4</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)):</span>
            <span class="c1"># Collect the atoms involved</span>
            <span class="n">atnum1</span> <span class="o">=</span> <span class="n">sel1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum2</span> <span class="o">=</span> <span class="n">sel2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum3</span> <span class="o">=</span> <span class="n">sel3</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum4</span> <span class="o">=</span> <span class="n">sel4</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum1</span><span class="p">]</span>
            <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum2</span><span class="p">]</span>
            <span class="n">atm3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum3</span><span class="p">]</span>
            <span class="n">atm4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum4</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm2</span> <span class="ow">or</span> <span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm3</span> <span class="ow">or</span> <span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm4</span> <span class="ow">or</span>
                <span class="n">atm2</span> <span class="ow">is</span> <span class="n">atm3</span> <span class="ow">or</span> <span class="n">atm2</span> <span class="ow">is</span> <span class="n">atm4</span> <span class="ow">or</span> <span class="n">atm3</span> <span class="ow">is</span> <span class="n">atm4</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SetParamError</span><span class="p">(</span><span class="s1">&#39;addDihedral: Duplicate atoms found!&#39;</span><span class="p">)</span>
            <span class="c1"># Determine if end-group interactions need to be ignored</span>
            <span class="n">ignore_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm4</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">or</span>
                          <span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm4</span><span class="o">.</span><span class="n">angle_partners</span> <span class="ow">or</span>
                          <span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm4</span><span class="o">.</span><span class="n">dihedral_partners</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Dihedral</span><span class="p">(</span><span class="n">atm1</span><span class="p">,</span> <span class="n">atm2</span><span class="p">,</span> <span class="n">atm3</span><span class="p">,</span> <span class="n">atm4</span><span class="p">,</span> <span class="n">improper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span>
                             <span class="n">ignore_end</span><span class="o">=</span><span class="n">ignore_end</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">new_dih_typ</span><span class="p">)</span>
            <span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="addAtomicNumber"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addAtomicNumber">[docs]</a><span class="k">class</span> <span class="nc">addAtomicNumber</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the atomic number of each atom to a new section titled &quot;ATOMIC_NUMBER&quot;</span>
<span class="sd">    in the topology file. Elements are identified by the atomic mass found in</span>
<span class="sd">    the MASS section of the topology files.  Elements are matched by picking the</span>
<span class="sd">    element whose average atomic mass in the periodic table is closest to each</span>
<span class="sd">    atom, which should work appropriately for all isotopes of all atoms, except</span>
<span class="sd">    possibly Tritium</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="addAtomicNumber.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addAtomicNumber.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">amoeba</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">present</span> <span class="o">=</span> <span class="s1">&#39;AMOEBA_ATOMIC_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">present</span> <span class="o">=</span> <span class="s1">&#39;ATOMIC_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">present</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ATOMIC_NUMBER already in [</span><span class="si">%s</span><span class="s1">] -- Doing nothing.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span>
        <span class="k">return</span> <span class="s2">&quot;Adding ATOMIC_NUMBER to [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span>

<div class="viewcode-block" id="addAtomicNumber.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addAtomicNumber.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">present</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">amoeba</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;AMOEBA_ATOMIC_NUMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span>
                               <span class="n">num_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;AMOEBA_ATOMIC_NUMBER&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span>
                               <span class="n">num_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;ATOMIC_NUMBER&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">flag</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">atomic_number</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="deleteDihedral"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deleteDihedral">[docs]</a><span class="k">class</span> <span class="nc">deleteDihedral</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the dihedral around &lt;mask2&gt; and &lt;mask3&gt; in which the end-groups are</span>
<span class="sd">    &lt;mask1&gt; and &lt;mask4&gt;. For multi-term dihedrals, it removes each term.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt; &lt;mask3&gt; &lt;mask4&gt;&#39;</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>
<div class="viewcode-block" id="deleteDihedral.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deleteDihedral.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="ow">or</span>
            <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="ow">or</span>
            <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="o">.</span><span class="n">Selection</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="n">DeleteDihedralError</span><span class="p">(</span><span class="s1">&#39;All masks must select the same number &#39;</span>
                                      <span class="s1">&#39;of atoms!. They selected </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, </span><span class="si">%d</span><span class="s1">, &#39;</span>
                                      <span class="s1">&#39;and </span><span class="si">%d</span><span class="s1">, respectively&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()),</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()),</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selection</span><span class="p">()),</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="o">.</span><span class="n">Selection</span><span class="p">()))</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;No specified dihedrals to delete&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Deleting dihedral terms involving [</span><span class="si">%s</span><span class="s1">]-[</span><span class="si">%s</span><span class="s1">]-[</span><span class="si">%s</span><span class="s1">]-[</span><span class="si">%s</span><span class="s1">]&#39;</span>
                <span class="s1">&#39; (At most </span><span class="si">%d</span><span class="s1"> total, distinct, dihedrals)&#39;</span> <span class="o">%</span>
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="p">,</span>
                <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()))</span>
        <span class="p">)</span>

<div class="viewcode-block" id="deleteDihedral.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deleteDihedral.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the total number of dihedrals deleted &quot;&quot;&quot;</span>
        <span class="n">sel1</span><span class="p">,</span> <span class="n">sel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel3</span><span class="p">,</span> <span class="n">sel4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask3</span><span class="o">.</span><span class="n">Selection</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask4</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="c1"># Bail out if we&#39;re deleting nothing</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
        <span class="c1"># Keep track of the dihedrals we want to delete from each</span>
        <span class="c1"># dihedral list (dihedrals_inc_h, dihedrals_without_h)</span>
        <span class="n">deleting_dihedrals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># We have already checked that they are the same number of atoms</span>
        <span class="c1"># Now, loop through the atoms and see if any dihedrals match that spec</span>
        <span class="n">atnum1</span> <span class="o">=</span> <span class="n">atnum2</span> <span class="o">=</span> <span class="n">atnum3</span> <span class="o">=</span> <span class="n">atnum4</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">total_diheds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sel1</span><span class="p">)):</span>
            <span class="c1"># Collect the atoms involved</span>
            <span class="n">atnum1</span> <span class="o">=</span> <span class="n">sel1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum2</span> <span class="o">=</span> <span class="n">sel2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum3</span> <span class="o">=</span> <span class="n">sel3</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atnum4</span> <span class="o">=</span> <span class="n">sel4</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">atnum4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">atm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum1</span><span class="p">]</span>
            <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum2</span><span class="p">]</span>
            <span class="n">atm3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum3</span><span class="p">]</span>
            <span class="n">atm4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atnum4</span><span class="p">]</span>
            <span class="c1"># Make sure none of the indices are the same</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm2</span> <span class="ow">or</span> <span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm3</span> <span class="ow">or</span> <span class="n">atm1</span> <span class="ow">is</span> <span class="n">atm4</span> <span class="ow">or</span>
                <span class="n">atm2</span> <span class="ow">is</span> <span class="n">atm3</span> <span class="ow">or</span> <span class="n">atm2</span> <span class="ow">is</span> <span class="n">atm4</span> <span class="ow">or</span> <span class="n">atm3</span> <span class="ow">is</span> <span class="n">atm4</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Skipping </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1"> dihedral deletion -- &#39;</span>
                              <span class="s1">&#39;duplicate atoms!&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">atnum1</span><span class="p">,</span> <span class="n">atnum2</span><span class="p">,</span> <span class="n">atnum3</span><span class="p">,</span> <span class="n">atnum4</span><span class="p">),</span>
                              <span class="n">SeriousParmWarning</span><span class="p">)</span>
                <span class="k">continue</span> <span class="c1"># pragma: no cover</span>
            <span class="c1"># Now search through our dihedral list to see which indexes (if any)</span>
            <span class="c1"># we have to remove. Keep tabs of them so we can pop them in reverse</span>
            <span class="c1"># order (so we don&#39;t have to re-figure indices) afterwards</span>
            <span class="n">proposed_dihedral</span> <span class="o">=</span> <span class="p">(</span><span class="n">atnum1</span><span class="p">,</span> <span class="n">atnum2</span><span class="p">,</span> <span class="n">atnum3</span><span class="p">,</span> <span class="n">atnum4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">same_atoms</span><span class="p">(</span><span class="n">proposed_dihedral</span><span class="p">):</span>
                    <span class="n">total_diheds</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">deleting_dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">deleting_dihedrals</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># At this point, we&#39;ve collected all of our dihedrals, now sort them</span>
        <span class="n">deleting_dihedrals</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1"># deleting_dihedrals now contains all of our dihedral indexes</span>
        <span class="k">while</span> <span class="n">deleting_dihedrals</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">deleting_dihedrals</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total_diheds</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="printLJMatrix"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printLJMatrix">[docs]</a><span class="k">class</span> <span class="nc">printLJMatrix</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function prints out how every atom type interacts with the atom type(s)</span>
<span class="sd">    in &lt;mask&gt;. The atom types are printed as all type names that have at least</span>
<span class="sd">    one atom with the Lennard Jones index given in square brackets at the end.</span>
<span class="sd">    Alternatively, you can request a particular atom type index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask&gt;|&lt;index&gt;&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
<div class="viewcode-block" id="printLJMatrix.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.printLJMatrix.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_int</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">has_1264</span> <span class="o">=</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="s1">&#39;parm_data&#39;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">)</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">)</span>
        <span class="n">ret_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span> <span class="n">sel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="c1"># If we selected no atoms, bail out</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;No atom types selected&#39;</span>
        <span class="c1"># Figure out which types correspond to which names</span>
        <span class="n">typenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">typenames</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="c1"># Otherwise, collect our list of atom types that we selected</span>
        <span class="n">sel_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">sel_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">)</span>
        <span class="n">sel_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sel_types</span><span class="p">))</span> <span class="c1"># sort the atom types</span>
        <span class="c1"># Convert all of the typenames into strings, then find the longest one so</span>
        <span class="c1"># we can properly format the string</span>
        <span class="n">maxlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typenames</span><span class="p">):</span>
            <span class="n">typenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39; [</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">typenames</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">has_1264</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%</span><span class="s1">15s </span><span class="si">%%</span><span class="s1">15s </span><span class="si">%%</span><span class="s1">15s </span><span class="si">%%</span><span class="s1">10s </span><span class="si">%%</span><span class="s1">10s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Atom Type 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom Type 2&#39;</span><span class="p">,</span> <span class="s1">&#39;A coefficient&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;B coefficient&#39;</span><span class="p">,</span> <span class="s1">&#39;C coefficient&#39;</span><span class="p">,</span> <span class="s1">&#39;R i,j&#39;</span><span class="p">,</span> <span class="s1">&#39;Eps i,j&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%</span><span class="s1">15s </span><span class="si">%%</span><span class="s1">15s </span><span class="si">%%</span><span class="s1">10s </span><span class="si">%%</span><span class="s1">10s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Atom Type 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Atom Type 2&#39;</span><span class="p">,</span> <span class="s1">&#39;A coefficient&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;B coefficient&#39;</span><span class="p">,</span> <span class="s1">&#39;R i,j&#39;</span><span class="p">,</span> <span class="s1">&#39;Eps i,j&#39;</span><span class="p">)</span>
        <span class="n">ret_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">ret_str</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ret_str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ty</span> <span class="ow">in</span> <span class="n">sel_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ty2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ntypes</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">type1</span><span class="p">,</span> <span class="n">type2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">ty2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">ty2</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span>
                            <span class="n">ntypes</span><span class="o">*</span><span class="p">(</span><span class="n">type1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">type2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">acoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">bcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">has_1264</span><span class="p">:</span>
                    <span class="n">ccoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bcoef</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">acoef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rij</span> <span class="o">=</span> <span class="n">eij</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rij</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">acoef</span> <span class="o">/</span> <span class="n">bcoef</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span>
                    <span class="n">eij</span> <span class="o">=</span> <span class="p">(</span><span class="n">bcoef</span> <span class="o">*</span> <span class="n">bcoef</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">acoef</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">has_1264</span><span class="p">:</span>
                    <span class="n">ret_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%</span><span class="s1">15.6f </span><span class="si">%%</span><span class="s1">15.6f </span><span class="si">%%</span><span class="s1">15.6f </span><span class="si">%%</span><span class="s1">10.6f </span><span class="si">%%</span><span class="s1">10.6f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">)</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">typenames</span><span class="p">[</span><span class="n">type1</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">typenames</span><span class="p">[</span><span class="n">type2</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">acoef</span><span class="p">,</span> <span class="n">bcoef</span><span class="p">,</span> <span class="n">ccoef</span><span class="p">,</span> <span class="n">rij</span><span class="p">,</span> <span class="n">eij</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%%d</span><span class="s1">s </span><span class="si">%%</span><span class="s1">15.6f </span><span class="si">%%</span><span class="s1">15.6f </span><span class="si">%%</span><span class="s1">10.6f </span><span class="si">%%</span><span class="s1">10.6f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">maxlen</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">)</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">typenames</span><span class="p">[</span><span class="n">type1</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">typenames</span><span class="p">[</span><span class="n">type2</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">acoef</span><span class="p">,</span> <span class="n">bcoef</span><span class="p">,</span> <span class="n">rij</span><span class="p">,</span> <span class="n">eij</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret_str</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="tiMerge"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.tiMerge">[docs]</a><span class="k">class</span> <span class="nc">tiMerge</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges molecules removing redundant bonding terms.  Input amber masks</span>
<span class="sd">    corresponding to molecules 1/2 &lt;mol1mask&gt;/&lt;mol2mask&gt;, and the soft core</span>
<span class="sd">    atoms in each molecule as &lt;scmask1&gt;/&lt;scmask2&gt;. The input topology can be</span>
<span class="sd">    created using leap, with the two molecules to be merged adjacent to each</span>
<span class="sd">    other in residue number. This improves the efficiency for pmemd TI when only</span>
<span class="sd">    part of a molecule is being perturbed.</span>

<span class="sd">    &lt;scmask1/2N&gt; are for softcore molecules that are not going to be merged.</span>
<span class="sd">    These options will just add these atoms to the timask output, correcting for</span>
<span class="sd">    any changes in atom number.</span>

<span class="sd">    This can also be used for non-softcore simulations, where</span>
<span class="sd">    &lt;scmask1&gt;/&lt;scmask2&gt; represent the perturbed atoms. The output will give the</span>
<span class="sd">    scmask1/scmask2 flags, which can just be ignored.</span>

<span class="sd">    &lt;tol&gt; is the tolerence to use when matching coordinates (default 0.01).</span>
<span class="sd">    This is used when the atoms in molecules 1/2 are not in the same order and</span>
<span class="sd">    for checking the input coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mol1mask&gt; &lt;mol2mask&gt; &lt;scmask1&gt; &lt;scmask2&gt; [&lt;scmask1N&gt;] [&lt;scmask2N&gt;] [tol &lt;tol&gt;]&#39;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<div class="viewcode-block" id="tiMerge.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.tiMerge.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molmask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molmask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc_mask1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc_mask2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">molmask1N</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">molmask1N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molmask1N</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">molmask1N</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molmask1N</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">molmask2N</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">molmask2N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molmask2N</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">molmask2N</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molmask2N</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Merging molecules [</span><span class="si">%s</span><span class="s1">] [</span><span class="si">%s</span><span class="s1">] with sc mask [</span><span class="si">%s</span><span class="s1">] [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">molmask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="tiMerge.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.tiMerge.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sel1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">sel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">molsel1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask1</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="n">molsel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask2</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>

        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask1N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">molsel1N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask1N</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">molsel1N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask2N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">molsel2N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask2N</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">molsel2N</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sel1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">molsel1</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;scmask1 must be a subset of mol1mask.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sel2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">molsel2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;scmask2 must be a subset of mol2mask.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">molsel1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">molsel2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;mol1mask can not overlap with mol2mask.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">natom</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">molsel1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">molsel1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">molsel2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;mol1mask and mol2mask must be adjacent in topology. &#39;</span>
                                       <span class="s1">&#39;Recreate topology with the molecules to be merged adjacent &#39;</span>
                                       <span class="s1">&#39;in the PDB file.&#39;</span><span class="p">)</span>

        <span class="c1"># self.parm.coordinates is a property that manipulates a numpy array, so get a copy of it</span>
        <span class="c1"># here so we do not wind up accessing that property in an inner loop... EXPENSIVE!</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="k">if</span> <span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;Load coordinates before merging topology.&#39;</span><span class="p">)</span>

        <span class="c1"># we now have enough info to remap the atom indicies if an atom in</span>
        <span class="c1"># molsel2 has no overlap (dihedrals, angles, bonds) with sel2 then we</span>
        <span class="c1"># can just delete it (it is redundant).</span>

        <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">molsel2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sel2</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">atm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">or</span> <span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">angle_partners</span> <span class="ow">or</span>
                            <span class="n">atm1</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">dihedral_partners</span><span class="p">):</span>
                            <span class="n">keep_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">nremove</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">molsel2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sel2</span><span class="p">)</span>

        <span class="c1"># We use an ambmask here to minimize changes to the code and</span>
        <span class="c1"># not introduce extra maintenance issues</span>
        <span class="n">remove_mask</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># remove_map[old_atm_idx] = new_atm_idx</span>
        <span class="n">remove_map</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">)]</span>

        <span class="n">new_atm_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">molsel2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sel2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">remove_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remove_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_atm_idx</span>
                <span class="n">new_atm_idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">remove_str</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remove_mask</span><span class="p">)</span>

        <span class="c1"># However, if there is overlap, we need to re-index the atoms involved</span>
        <span class="c1"># Create a map from molsel2 to molsel1 excluding sel2/sel1 respectively</span>

        <span class="n">mol1common</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mol2common</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">molsel1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sel1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mol1common</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">molsel2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sel2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mol2common</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol1common</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol2common</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;The number of nonsoftcore atoms in mol1mask and mol2mask must be &#39;</span>
                               <span class="s1">&#39;the same.&#39;</span><span class="p">)</span>

        <span class="n">mol2common_sort</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># reorder mol2common so that it matches mol1common</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol1common</span><span class="p">)):</span>
            <span class="n">atm_i</span> <span class="o">=</span> <span class="n">mol1common</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol2common</span><span class="p">)):</span>
                <span class="n">atm_j</span> <span class="o">=</span> <span class="n">mol2common</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">atm_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">atm_j</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">mol2common_sort</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atm_j</span><span class="p">)</span>

        <span class="n">mol2common</span> <span class="o">=</span> <span class="n">mol2common_sort</span>

        <span class="c1"># check again if we didn&#39;t match all coords</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol1common</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol2common</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;The number of nonsoftcore atoms in mol1mask and mol2mask must be &#39;</span>
                               <span class="s1">&#39;the same. Check the masks. If these look correct try using a &#39;</span>
                               <span class="s1">&#39;larger tolerance.&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol1common</span><span class="p">)):</span>
            <span class="n">atm_i</span> <span class="o">=</span> <span class="n">mol1common</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atm_j</span> <span class="o">=</span> <span class="n">mol2common</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">atm_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">atm_j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span><span class="s1">&#39;Common (nonsoftcore) atoms must have the &#39;</span> <span class="c1"># pragma: no cover</span>
                                   <span class="s1">&#39;same coordinates.&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">keep_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sel2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">mol1common</span><span class="p">[</span><span class="n">mol2common</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span>
                <span class="n">atm_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="c1"># What is happening here???</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sel2</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">atm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="c1"># update partners -- the exclusion list will be updated</span>
                        <span class="c1"># when the file is written out</span>
                        <span class="k">if</span> <span class="n">atm</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                            <span class="n">atm</span><span class="o">.</span><span class="n">_bond_partners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atm2</span><span class="p">)</span>
                            <span class="n">atm2</span><span class="o">.</span><span class="n">_bond_partners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atm</span><span class="p">)</span>
                            <span class="n">atm2</span><span class="o">.</span><span class="n">bond_to</span><span class="p">(</span><span class="n">atm_new</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">atm</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">:</span>
                            <span class="n">atm</span><span class="o">.</span><span class="n">_angle_partners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atm2</span><span class="p">)</span>
                            <span class="n">atm2</span><span class="o">.</span><span class="n">_angle_partners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atm</span><span class="p">)</span>
                            <span class="n">atm2</span><span class="o">.</span><span class="n">angle_to</span><span class="p">(</span><span class="n">atm_new</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">atm</span> <span class="ow">in</span> <span class="n">atm2</span><span class="o">.</span><span class="n">dihedral_partners</span><span class="p">:</span>
                            <span class="n">atm</span><span class="o">.</span><span class="n">_dihedral_partners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atm2</span><span class="p">)</span>
                            <span class="n">atm2</span><span class="o">.</span><span class="n">_dihedral_partners</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atm</span><span class="p">)</span>
                            <span class="n">atm2</span><span class="o">.</span><span class="n">dihedral_to</span><span class="p">(</span><span class="n">atm_new</span><span class="p">)</span>

                        <span class="c1"># Now go through each array re-indexing the atoms</span>
                        <span class="c1"># Check to make sure that this is a bond/angle/dihed</span>
                        <span class="c1"># involving the common atom j and the softcore atom k</span>

                        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atm_new</span>

                        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                                    <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                                    <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                                    <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span> <span class="o">=</span> <span class="n">atm_new</span>

                        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span> <span class="o">=</span> <span class="n">atm_new</span>

                        <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">imp</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span> <span class="o">=</span> <span class="n">atm_new</span>

                        <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span> <span class="o">=</span> <span class="n">atm_new</span>
                            <span class="k">elif</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span>
                                        <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="n">k</span><span class="p">):</span>
                                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span> <span class="o">=</span> <span class="n">atm_new</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">nremove</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">remove_str</span><span class="p">)</span>

        <span class="n">new_sc_atm1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_sc_atm2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_sc_atm1_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_sc_atm2_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sel1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">molsel1N</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">new_sc_atm1_int</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remove_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_sc_atm1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remove_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">sel2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">molsel2N</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">new_sc_atm2_int</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">remove_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_sc_atm2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remove_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Do not allow definition where dihedrals cross through the softcore</span>
        <span class="c1"># region. This is generally breaking a ring (and possibly other cases),</span>
        <span class="c1"># and can cause problems with the 1-4 nonbonded calculations.</span>
        <span class="c1"># This can be worked-around:</span>
        <span class="c1"># Define your softcore region so that it includes the ring.</span>
        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="c1"># skip impropers, these are not used to define 1-4 interactions</span>
            <span class="c1"># so these can cross through the softcore region</span>
            <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">atmi</span> <span class="o">=</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">atmj</span> <span class="o">=</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">atmk</span> <span class="o">=</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">atml</span> <span class="o">=</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">atmj</span> <span class="ow">in</span> <span class="n">new_sc_atm1_int</span> <span class="ow">or</span> <span class="n">atmk</span> <span class="ow">in</span> <span class="n">new_sc_atm1_int</span> <span class="ow">or</span> <span class="n">atmj</span> <span class="ow">in</span> <span class="n">new_sc_atm2_int</span> <span class="ow">or</span>
                <span class="n">atmk</span> <span class="ow">in</span> <span class="n">new_sc_atm2_int</span><span class="p">):</span> <span class="c1">#dihedral includes sc atoms</span>

                <span class="c1">#endpoint atoms are not softcore</span>
                <span class="c1">#we are crossing through the softcore region</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atmi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_sc_atm1_int</span> <span class="ow">and</span> <span class="n">atmi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_sc_atm2_int</span> <span class="ow">and</span>
                    <span class="n">atml</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_sc_atm1_int</span> <span class="ow">and</span> <span class="n">atml</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_sc_atm2_int</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">TiMergeError</span><span class="p">(</span> <span class="c1"># pragma: no cover</span>
                            <span class="s1">&#39;Cannot have dihedral cross through softcore &#39;</span>
                            <span class="s1">&#39;region. (DIHED : </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1">). Usually this means &#39;</span>
                            <span class="s1">&#39;you have defined the softcore region in a way &#39;</span>
                            <span class="s1">&#39;that breaks a ring. Try redefining your softcore &#39;</span>
                            <span class="s1">&#39;region to include the ring or at least three &#39;</span>
                            <span class="s1">&#39;consecutive atoms.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atmi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atmj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">atmk</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">atml</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sc_mask1</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_sc_atm1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc_mask2</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_sc_atm2</span><span class="p">)</span>

        <span class="n">ret_str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Merging molecules </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2"> into the same molecule.</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molmask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molmask2</span><span class="p">))</span>
        <span class="n">ret_str2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Use softcore mask:</span><span class="se">\n</span><span class="s2">timask1=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">,</span><span class="se">\n</span><span class="s2">timask2=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">,&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_mask2</span><span class="p">))</span>
        <span class="n">ret_str3</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">scmask1=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">,</span><span class="se">\n</span><span class="s2">scmask2=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">,&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc_mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc_mask2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ret_str</span><span class="p">,</span> <span class="n">ret_str2</span><span class="p">,</span> <span class="n">ret_str3</span><span class="p">))</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="source"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.source">[docs]</a><span class="k">class</span> <span class="nc">source</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sources a file with a list of parmed commands</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;file&gt;&#39;</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="source.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.source.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Sourcing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>

<div class="viewcode-block" id="source.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.source.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a no-op, since a separate command interpreter for this file is</span>
<span class="sd">        launched inside parmed_cmd.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span> <span class="c1"># pragma: no cover</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="parm"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.parm">[docs]</a><span class="k">class</span> <span class="nc">parm</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Either adds a new parm to the list of available parms to edit in ParmEd, or</span>
<span class="sd">    it sets a new &#39;active&#39; parm to edit by default with new commands</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;filename&gt; [&lt;filename&gt; [&lt;filename&gt; ...]] || parm copy &lt;filename&gt;|&#39;</span>
             <span class="s1">&#39;&lt;index&gt; || parm select &lt;filename&gt;|&lt;index&gt;&#39;</span><span class="p">)</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="parm.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.parm.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Add as many parms as we want with one command, and support globbing</span>
        <span class="n">new_parm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">unmarked</span><span class="p">())</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="c1"># Make sure we specified only one operating mode</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">new_parm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;Improper usage of `parm</span><span class="se">\&#39;</span><span class="s1"> command&#39;</span><span class="p">)</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span><span class="p">,</span> <span class="n">new_parm</span><span class="p">)</span>
        <span class="n">nnone</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nnone</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nnone</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParmError</span><span class="p">(</span><span class="s1">&#39;Improper usage of `parm</span><span class="se">\&#39;</span><span class="s1"> -- choose one behavior&#39;</span><span class="p">)</span>
        <span class="c1"># Now get our indexes for copied and new parms if they are integers,</span>
        <span class="c1"># otherwise we index based on filename</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_parm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">new_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">listparms</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">new_parm</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">listparms</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ParmFileNotFound</span><span class="p">(</span><span class="s1">&#39;No files matching </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">new_parm</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">new_parm</span><span class="p">))</span>
                <span class="n">new_parm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span><span class="p">,</span> <span class="s1">&#39;No matching parm files? should not happen&#39;</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in parm list. Doing nothing&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span>
            <span class="k">return</span> <span class="s1">&#39;Setting new active parm [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Adding prmtop </span><span class="si">%s</span><span class="s1"> to parm list. </span><span class="si">%s</span><span class="s1"> is the active parm.&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in parm list. Doing nothing&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Copying prmtop </span><span class="si">%s</span><span class="s2"> to parm list. </span><span class="si">%s</span><span class="s2">&#39;s copy is the active parm.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Should not be here&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="parm.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.parm.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Either set the new active parm or add the new parm &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Add the new parm</span>
            <span class="k">for</span> <span class="n">new_parm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_parm</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">add_parm</span><span class="p">(</span><span class="n">new_parm</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not open </span><span class="si">%s</span><span class="s1"> for reading&#39;</span> <span class="o">%</span> <span class="n">new_parm</span><span class="p">,</span> <span class="n">SeriousParmWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">set_new_active</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in the parm list!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_active_parm</span><span class="p">,</span>
                              <span class="n">SeriousParmWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">add_parm</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in the parm list!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">copied_parm</span><span class="p">,</span> <span class="n">SeriousParmWarning</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="ls"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.ls">[docs]</a><span class="k">class</span> <span class="nc">ls</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lists directory contents. Like UNIX &#39;ls&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[Unix ls options]&#39;</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="ls.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.ls.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Process the argument list to mimic the real ls as much as possible</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                    <span class="c1"># Glob this argument</span>
                    <span class="n">globarg</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">globarg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">globarg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NoArgument</span><span class="p">:</span>
                <span class="k">break</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;/bin/ls&#39;</span><span class="p">,</span> <span class="s1">&#39;-C&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="cd"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.cd">[docs]</a><span class="k">class</span> <span class="nc">cd</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes to a new directory like UNIX &#39;cd&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;directory&gt;&#39;</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="cd.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.cd.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">expanduser</span><span class="p">,</span> <span class="n">expandvars</span>
        <span class="n">mydir</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">expandvars</span><span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">mydir</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Change directory failed&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not exist. cd failed.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;New working directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="cd.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.cd.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No recognized directories given to cd&#39;</span><span class="p">,</span>
                          <span class="n">SeriousParmWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="c1"># pragma: no cover</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;More than one file/directory given to cd&#39;</span><span class="p">,</span>
                          <span class="n">SeriousParmWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="c1"># pragma: no cover</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a directory&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">SeriousParmWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="c1"># pragma: no cover</span>
        <span class="c1"># If we&#39;ve gotten this far, go ahead and change to the directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="listParms"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.listParms">[docs]</a><span class="k">class</span> <span class="nc">listParms</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lists all of the loaded topology files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="listParms.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.listParms.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;No topology files are loaded&quot;</span>

        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Loaded topology files:&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">parm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">):</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[</span><span class="si">%d</span><span class="s1">]</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">parm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parm</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">parm</span><span class="p">:</span>
                <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; (active)&#39;</span>

        <span class="k">return</span> <span class="n">retstr</span>

    <span class="fm">__str__</span> <span class="o">=</span> <span class="fm">__repr__</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="interpolate"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.interpolate">[docs]</a><span class="k">class</span> <span class="nc">interpolate</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates between two topology files (VDW and electrostatic terms only).</span>
<span class="sd">    If [eleconly] is present, only the charges will be interpolated. &lt;nparm&gt; is</span>
<span class="sd">    the number of &#39;interpolated&#39; topology files you want (in addition to the two</span>
<span class="sd">    end-points). The second prmtop must be specified if there are more than 2</span>
<span class="sd">    parms currently loaded in the ParmEd parm list. startnum has no effect on</span>
<span class="sd">    the generated prmtops, but it can be used to control the names of the</span>
<span class="sd">    outputted topology files.</span>

<span class="sd">        - &lt;nparm&gt; : Number of topology files that will be generated</span>
<span class="sd">        - &lt;other_parm&gt; : The other parm object used in interpolation if more</span>
<span class="sd">                         than 2 parms are present (first parm is active one)</span>
<span class="sd">        - eleconly : Only do charge interpolation</span>
<span class="sd">        - &lt;prefix&gt; : Generated parm objects will be written as &lt;prefix&gt;.#, where</span>
<span class="sd">                     # starts from &lt;num&gt; and increases by 1</span>
<span class="sd">        - &lt;num&gt; : Starting number for file names (see &lt;prefix&gt; above)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;nparm&gt; [parm2 &lt;other_parm&gt;] [eleconly] [prefix &lt;prefix&gt;] &#39;</span>
             <span class="s1">&#39;[startnum &lt;num&gt;]&#39;</span><span class="p">)</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>
<div class="viewcode-block" id="interpolate.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.interpolate.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="c1"># Make sure we have at least 2 prmtops</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NonexistentParm</span><span class="p">(</span><span class="s1">&#39;Must have 2 topology files to interpolate!&#39;</span><span class="p">)</span>
        <span class="n">parm2</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;parm2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parm2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">parm2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AmbiguousParmError</span><span class="p">(</span><span class="s1">&#39;You must identify parm2 if more than 2 &#39;</span>
                                     <span class="s1">&#39;parm instances exist!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parm2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parm2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">parm2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">startnum</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_int</span><span class="p">(</span><span class="s1">&#39;startnum&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eleconly</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;eleconly&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nparm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_int</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="s1">&#39;Must have &gt;= 1 prmtop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_vdw</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_parms</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eleconly</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_vdw</span><span class="p">:</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39; [only interpolating charges]&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Creating </span><span class="si">%d</span><span class="s1"> interpolated prmtops between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">nparm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm2</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra</span>

    <span class="k">def</span> <span class="nf">_check_parms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Makes sure that the atoms in both parms are all the same &quot;&quot;&quot;</span>
        <span class="n">parm1</span><span class="p">,</span> <span class="n">parm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm2</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parm1</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parm2</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">IncompatibleParmsError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> have different #s of &#39;</span>
                                         <span class="s1">&#39;atoms!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parm1</span><span class="p">,</span> <span class="n">parm2</span><span class="p">))</span>
        <span class="n">ndiff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parm1</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">parm2</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">ndiff</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ndiff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> atoms have different names b/w </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">ndiff</span><span class="p">,</span> <span class="n">parm1</span><span class="p">,</span> <span class="n">parm2</span><span class="p">),</span> <span class="n">SeriousParmWarning</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atm1</span><span class="p">,</span> <span class="n">atm2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parm1</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">parm2</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">atm1</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">atm2</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">parm1</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">parm2</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">i2</span><span class="p">])</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">parm1</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">parm2</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">i2</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">diff_vdw</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="interpolate.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.interpolate.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Interpolates the prmtops &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_vdw</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eleconly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No support for scaling vdW &#39;</span>
                                      <span class="s1">&#39;parameters yet!&#39;</span><span class="p">)</span>
        <span class="n">parm1</span><span class="p">,</span> <span class="n">parm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm2</span>
        <span class="c1"># Original charges for parm 1</span>
        <span class="n">orig_chg1</span> <span class="o">=</span> <span class="n">parm1</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">]</span>
        <span class="n">chg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parm1</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">])</span>
        <span class="n">chg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">parm2</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">chg2</span> <span class="o">-</span> <span class="n">chg1</span>
        <span class="n">diff</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparm</span><span class="p">):</span>
            <span class="n">new_chg</span> <span class="o">=</span> <span class="n">chg1</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">parm1</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_chg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">parm1</span><span class="o">.</span><span class="n">load_atom_info</span><span class="p">()</span>
            <span class="n">newname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">startnum</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Printing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">newname</span><span class="p">)</span>
            <span class="n">parm1</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>
        <span class="c1"># Restore the original charges</span>
        <span class="n">parm1</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_chg1</span>
        <span class="n">parm1</span><span class="o">.</span><span class="n">load_atom_info</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<span class="k">def</span> <span class="nf">_split_range</span><span class="p">(</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;split a given range to n_chunks. taken from pytraj.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    [(0, 3), (3, 6), (6, 10)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n_chunks</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">//</span><span class="n">chunksize</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">%</span> <span class="n">chunksize</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n_chunks</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chunks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chunks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunksize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_stop</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="k">yield</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">_stop</span>

<span class="k">def</span> <span class="nf">_reformat_long_sentence</span><span class="p">(</span><span class="n">long_sentence</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">n_words</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">long_sentence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
    <span class="n">empty</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">)]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">_split_range</span><span class="p">(</span><span class="n">n_words</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">))]</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

    <span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">empty</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>

<div class="viewcode-block" id="summary"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.summary">[docs]</a><span class="k">class</span> <span class="nc">summary</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints out a summary of prmtop contents</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="summary.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.summary.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Collect statistics &quot;&quot;&quot;</span>
        <span class="n">nnuc</span> <span class="o">=</span> <span class="n">namin</span> <span class="o">=</span> <span class="n">ncion</span> <span class="o">=</span> <span class="n">naion</span> <span class="o">=</span> <span class="n">nwat</span> <span class="o">=</span> <span class="n">nunk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">RNAResidue</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DNAResidue</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">nnuc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">AminoAcidResidue</span><span class="o">.</span><span class="n">_all_residues_by_abbr</span><span class="p">:</span>
                <span class="n">namin</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">SOLVENT_NAMES</span><span class="p">:</span>
                <span class="n">nwat</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">ANION_NAMES</span><span class="p">:</span>
                <span class="n">naion</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">CATION_NAMES</span><span class="p">:</span>
                <span class="n">ncion</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nunk</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">tmass</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">tchg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">retval</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Amino Acid Residues:   </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Nucleic Acid Residues: </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Number of cations:     </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Number of anions:      </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Num. of solvent mols:  </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Num. of unknown res:   </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Total charge (e-):     </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Total mass (amu):      </span><span class="si">%.4f</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Number of atoms:       </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;Number of residues:    </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="n">namin</span><span class="p">,</span> <span class="n">nnuc</span><span class="p">,</span> <span class="n">ncion</span><span class="p">,</span> <span class="n">naion</span><span class="p">,</span> <span class="n">nwat</span><span class="p">,</span> <span class="n">nunk</span><span class="p">,</span> <span class="n">tchg</span><span class="p">,</span> <span class="n">tmass</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">))</span>
        <span class="p">)]</span>

        <span class="n">rset</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">)))</span>
        <span class="n">retval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_reformat_long_sentence</span><span class="p">(</span><span class="n">rset</span><span class="p">,</span> <span class="s1">&#39;Residue set:           &#39;</span><span class="p">,</span>
                                        <span class="n">n_words</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">rcount</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span>
                               <span class="n">Counter</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
                           <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">retval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_reformat_long_sentence</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">sorted</span><span class="p">(</span><span class="n">rcount</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))),</span>
                                        <span class="s1">&#39;Residue count:         &#39;</span><span class="p">,</span> <span class="n">n_words</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="mi">90</span><span class="p">]):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span>
            <span class="c1"># Get the total volume (and density) of orthorhombic box</span>
            <span class="n">retval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;System volume (ang^3): </span><span class="si">%.2f</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;System density (g/mL): </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">tmass</span> <span class="o">/</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="mf">0.602204</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># General triclinic cell</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">box</span><span class="p">[:]</span>
            <span class="c1"># Convert to radians</span>
            <span class="n">cosa</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">cosb</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">cosg</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cosa</span><span class="o">*</span><span class="n">cosa</span> <span class="o">-</span> <span class="n">cosb</span><span class="o">*</span><span class="n">cosb</span> <span class="o">-</span> <span class="n">cosg</span><span class="o">*</span><span class="n">cosg</span> <span class="o">+</span>
                                      <span class="mi">2</span> <span class="o">*</span> <span class="n">cosa</span><span class="o">*</span><span class="n">cosb</span><span class="o">*</span><span class="n">cosg</span><span class="p">)</span>
            <span class="n">retval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;System volume (ang^3): </span><span class="si">%.2f</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;System density (g/mL): </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">tmass</span> <span class="o">/</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="mf">0.602204</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="scale"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scale">[docs]</a><span class="k">class</span> <span class="nc">scale</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiplies all values in a particular section of an Amber prmtop by a scalar</span>
<span class="sd">    factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;FLAG&gt; &lt;factor&gt;&#39;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="scale.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scale.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid prmtop flag!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Scaling data in </span><span class="si">%s</span><span class="s1"> by </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span>

<div class="viewcode-block" id="scale.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.scale.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="s1">&#39;Cannot scale data in </span><span class="si">%%</span><span class="s1">FLAG </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">load_structure</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="lmod"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.lmod">[docs]</a><span class="k">class</span> <span class="nc">lmod</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts Lennard Jones parameters to work with the LMOD code in Amber</span>
<span class="sd">    (changes LJ A coefficients that are 0 to 1000).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>

<div class="viewcode-block" id="lmod.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.lmod.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;Making adjustments for LMOD (LJ A-coef. for H atoms bonded &#39;</span>
                <span class="s1">&#39;to O)&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="lmod.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.lmod.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="ow">or</span> <span class="mf">1000.0</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="addPDB"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addPDB">[docs]</a><span class="k">class</span> <span class="nc">addPDB</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds PDB information to new flags in an Amber topology file to enable</span>
<span class="sd">    analyses based on the original residue information in the PDB file,</span>
<span class="sd">    &lt;filename&gt;. It adds the flags:</span>

<span class="sd">    Residue Properties</span>
<span class="sd">    ------------------</span>
<span class="sd">        - RESIDUE_CHAINID: The chain ID of each residue (* if LEaP added it)</span>
<span class="sd">        - RESIDUE_ICODE: Insertion code, if it exists</span>
<span class="sd">        - RESIDUE_NUMBER: Original residue serial number in the PDB</span>

<span class="sd">    Atom Properties</span>
<span class="sd">    ---------------</span>
<span class="sd">        - ATOM_ELEMENT: Atomic element (redundant now, not printed by default)</span>
<span class="sd">        - ATOM_OCCUPANCY: The occupancy of each atom</span>
<span class="sd">        - ATOM_BFACTOR: The temperature factor of each atom</span>
<span class="sd">        - ATOM_NUMBER: The original atom serial number in the PDB</span>

<span class="sd">    The &#39;strict&#39; keyword turns residue mismatches (NOT solvent) into errors</span>
<span class="sd">    The &#39;elem&#39; keyword will force printing of the element names.</span>
<span class="sd">    The &#39;allicodes&#39; keyword forces insertion codes to be printed, even if every</span>
<span class="sd">    one will be blank (so that parsers can count on that section existing).</span>

<span class="sd">    Residues *not* in the PDB will be assigned a CHAINID of &#39;*&#39; and</span>
<span class="sd">    RESIDUE_NUMBER of 0. Any occupancy or temperature (B) factor that is not</span>
<span class="sd">    present in the input PDB file is assigned a number of 0</span>

<span class="sd">    Historical info:</span>
<span class="sd">        This action is based on, and reproduces the key results of, the</span>
<span class="sd">        historical &#39;add_pdb&#39; program. It is a bit more flexible, though.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;filename&gt; [elem] [strict] [allicodes]&#39;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="addPDB.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addPDB.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;elem&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printicodes</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;allicodes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;strict&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AddPDBWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AddPDBWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbpresent</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;RESIDUE_CHAINID&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;RESIDUE_ICODE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_ELEMENT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_OCCUPANCY&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_BFACTOR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbpresent</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;PDB information already present in </span><span class="si">%s</span><span class="s1">. Doing nothing&#39;</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Adding PDB information from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span> <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">[printing elements from prmtop]&#39;</span>
        <span class="k">return</span> <span class="n">retstr</span>

<div class="viewcode-block" id="addPDB.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.addPDB.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">read_PDB</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbpresent</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">pdb</span> <span class="o">=</span> <span class="n">read_PDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">)</span>
        <span class="n">resnums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">chainids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">icodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">tempfac</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">occupancies</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">atomnums</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">res</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
            <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdb</span><span class="o">.</span><span class="n">residues</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parmres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">reslab</span> <span class="o">=</span> <span class="n">parmres</span><span class="o">.</span><span class="n">name</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">resname</span> <span class="o">!=</span> <span class="n">reslab</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;WAT&#39;</span><span class="p">,</span> <span class="s1">&#39;HOH&#39;</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="ow">not</span> <span class="n">reslab</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;WAT&#39;</span><span class="p">,</span> <span class="s1">&#39;HOH&#39;</span><span class="p">)):</span>
                        <span class="c1"># Allow for 3&#39;s and 5&#39;s in terminal nucleic acid</span>
                        <span class="c1"># residues</span>
                        <span class="k">if</span> <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;DA&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;DT&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">reslab</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s1">&#39;35&#39;</span><span class="p">:</span>
                                <span class="n">reslab</span> <span class="o">=</span> <span class="n">reslab</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">reslab</span> <span class="o">!=</span> <span class="n">resname</span><span class="p">:</span>
                            <span class="n">needs_warn</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Support other Amber residue name replacements</span>
                            <span class="k">if</span> <span class="n">reslab</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;ASH&#39;</span><span class="p">,</span> <span class="s1">&#39;AS4&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ASP&#39;</span><span class="p">,</span> <span class="s1">&#39;ASH&#39;</span><span class="p">,</span> <span class="s1">&#39;AS4&#39;</span><span class="p">):</span>
                                <span class="n">needs_warn</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">reslab</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;GLU&#39;</span><span class="p">,</span> <span class="s1">&#39;GLH&#39;</span><span class="p">,</span> <span class="s1">&#39;GL4&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;GLU&#39;</span><span class="p">,</span> <span class="s1">&#39;GLH&#39;</span><span class="p">,</span> <span class="s1">&#39;GL4&#39;</span><span class="p">):</span>
                                <span class="n">needs_warn</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">reslab</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HIP&#39;</span><span class="p">,</span> <span class="s1">&#39;HIS&#39;</span><span class="p">,</span> <span class="s1">&#39;HIE&#39;</span><span class="p">,</span> <span class="s1">&#39;HID&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;HIP&#39;</span><span class="p">,</span> <span class="s1">&#39;HIS&#39;</span><span class="p">,</span> <span class="s1">&#39;HIE&#39;</span><span class="p">,</span> <span class="s1">&#39;HID&#39;</span><span class="p">):</span>
                                <span class="n">needs_warn</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">reslab</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LYS&#39;</span><span class="p">,</span> <span class="s1">&#39;LYN&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LYS&#39;</span><span class="p">,</span> <span class="s1">&#39;LYN&#39;</span><span class="p">):</span>
                                <span class="n">needs_warn</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">reslab</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CYS&#39;</span><span class="p">,</span> <span class="s1">&#39;CYX&#39;</span><span class="p">,</span> <span class="s1">&#39;CYM&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="n">resname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CYS&#39;</span><span class="p">,</span> <span class="s1">&#39;CYX&#39;</span><span class="p">,</span> <span class="s1">&#39;CYM&#39;</span><span class="p">):</span>
                                <span class="n">needs_warn</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">needs_warn</span><span class="p">:</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Residue name mismatch [#</span><span class="si">%d</span><span class="s1">] </span><span class="si">%s</span><span class="s1"> &#39;</span>
                                              <span class="s1">&#39;vs. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">reslab</span><span class="p">),</span>
                                              <span class="n">AddPDBWarning</span><span class="p">)</span>
                <span class="n">resnums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmres</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">number</span>
                <span class="n">chainids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmres</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span>
                <span class="n">icodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmres</span><span class="o">.</span><span class="n">insertion_code</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AddPDBError</span><span class="p">(</span><span class="s1">&#39;PDB </span><span class="si">%s</span><span class="s1"> has more residues than prmtop </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">))</span>
            <span class="c1"># Now loop through all of the atoms in the parm residue, look for</span>
            <span class="c1"># the atom with the same name in the PDB residue</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">parmres</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pdbatom</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">pdbatom</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="n">tempfac</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdbatom</span><span class="o">.</span><span class="n">bfactor</span>
                        <span class="n">occupancies</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdbatom</span><span class="o">.</span><span class="n">occupancy</span>
                        <span class="n">atomnums</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdbatom</span><span class="o">.</span><span class="n">number</span>
                        <span class="k">break</span>

        <span class="n">ncmts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Residue number (resSeq) read from PDB file; DIMENSION(NRES)&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">printicodes</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">icodes</span><span class="p">):</span>
            <span class="n">haveicodes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ncmts</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Residue insertion codes (iCode) present in </span><span class="si">%F</span><span class="s1">LAG &#39;</span>
                      <span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">haveicodes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ncmts</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Residue insertion code (iCode) not present in PDB file&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;If present: </span><span class="si">%F</span><span class="s1">LAG RESIDUE_ICODE, </span><span class="si">%F</span><span class="s1">ORMAT(20a4)&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;20I4&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">resnums</span><span class="p">,</span>
                           <span class="n">comments</span><span class="o">=</span><span class="n">ncmts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_CHAINID&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">chainids</span><span class="p">,</span>
                          <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Residue chain ID (chainId) read from PDB &#39;</span>
                                    <span class="s1">&#39;file; DIMENSION(NRES)&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">haveicodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">icodes</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Residue insertion code (iCode) read from PDB file; &#39;</span>
                        <span class="s1">&#39;DIMENSION(NRES)&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_ELEMENT&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%2s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_Element</span><span class="p">[</span><span class="n">atm</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                            <span class="k">for</span> <span class="n">atm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span>
                <span class="p">],</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Atom element name read from topology file&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_OCCUPANCY&#39;</span><span class="p">,</span> <span class="s1">&#39;10F8.2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">occupancies</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Atom occupancies read from the PDB file&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_BFACTOR&#39;</span><span class="p">,</span> <span class="s1">&#39;10F8.2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">tempfac</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Atom temperature factor from the PDB file&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_NUMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">atomnums</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Atom serial number from the PDB file&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">load_atom_info</span><span class="p">()</span> <span class="c1"># Get that information saved</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="deletePDB"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deletePDB">[docs]</a><span class="k">class</span> <span class="nc">deletePDB</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This action deletes the flags added by addPDB if they are present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">supported_subclasses</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,)</span>
<div class="viewcode-block" id="deletePDB.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deletePDB.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdbpresent</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;RESIDUE_CHAINID&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;RESIDUE_ICODE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_ELEMENT&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_BFACTOR&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_OCCUPANCY&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span> <span class="ow">or</span>
                           <span class="s1">&#39;ATOM_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">flag_list</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbpresent</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Deleting PDB info from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span>
        <span class="k">return</span> <span class="s1">&#39;No PDB information present in </span><span class="si">%s</span><span class="s1">. Doing nothing&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span>

<div class="viewcode-block" id="deletePDB.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deletePDB.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbpresent</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_CHAINID&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_ELEMENT&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_BFACTOR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_OCCUPANCY&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_NUMBER&#39;</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="add12_6_4"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.add12_6_4">[docs]</a><span class="k">class</span> <span class="nc">add12_6_4</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the LENNARD_JONES_CCOEF term for the new divalent metal ion 12-6-4</span>
<span class="sd">    Lennard-Jones potential term. If provided, the mask will allow you to</span>
<span class="sd">    specify which ions are divalent. The C4 parameter between the metal ion and</span>
<span class="sd">    water can either be taken from Ref. [1] for the requested [watermodel]</span>
<span class="sd">    (TIP3P, TIP4PEW, or SPCE) or provided in the file specified by the c4file</span>
<span class="sd">    keyword.  The polarizabilities must be present in the the polfile file. The</span>
<span class="sd">    chemical symbol of the element will be used to determine the atom type.</span>
<span class="sd">    Parameters are expected in a file with 2 columns:</span>
<span class="sd">        &lt;atom type&gt;   &lt;parameter&gt;</span>

<span class="sd">    All defaults come from Ref. [1], [2] and [3]</span>

<span class="sd">    [1] Pengfei Li and Kenneth M. Merz, J. Chem. Theory Comput., 2014, 10,</span>
<span class="sd">        289-297</span>
<span class="sd">    [2] Pengfei Li, Lin F. Song and Kenneth M. Merz, J. Phys. Chem. B, 2015,</span>
<span class="sd">        119, 883-895</span>
<span class="sd">    [3] Pengfei Li, Lin F. Song and Kenneth M. Merz, J. Chem. Theory Comput.,</span>
<span class="sd">        2015, 11, 1645-1657.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[&lt;divalent ion mask&gt;] [c4file &lt;C4 Param. File&gt; | watermodel &#39;</span>
            <span class="s1">&#39;&lt;water model&gt;] [polfile &lt;Pol. Param File&gt; [tunfactor &lt;tunfactor&gt;]&#39;</span><span class="p">)</span>
    <span class="n">strictly_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="n">ChamberParm</span><span class="p">)</span>

    <span class="n">_supported_wms</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TIP3P&#39;</span><span class="p">,</span> <span class="s1">&#39;TIP4PEW&#39;</span><span class="p">,</span> <span class="s1">&#39;SPCE&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="add12_6_4.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.add12_6_4.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span>
                        <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;:ZN&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c4file</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;c4file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;watermodel&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polfile</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;polfile&#39;</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AMBERHOME&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;dat&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;leap&#39;</span><span class="p">,</span> <span class="s1">&#39;parm&#39;</span><span class="p">,</span> <span class="s1">&#39;lj_1264_pol.dat&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tunfactor</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;tunfactor&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c4file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span> <span class="o">=</span> <span class="s1">&#39;TIP3P&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supported_wms</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LJ12_6_4Error</span><span class="p">(</span><span class="s1">&#39;Unrecognized water model </span><span class="si">%s</span><span class="s1">; pick one &#39;</span>
                                        <span class="s1">&#39;of the following: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span><span class="p">,</span>
                                        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_supported_wms</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LJ12_6_4Error</span><span class="p">(</span><span class="s1">&#39;c4file and watermodel are mutually &#39;</span>
                                    <span class="s1">&#39;exclusive&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Adding Lennard-Jones C-coefficient for 12-6-4 potential. &#39;</span>
                  <span class="s1">&#39;Polarizabilities read from [</span><span class="si">%s</span><span class="s1">]. &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">polfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c4file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;Using default C4 parameters for water model [</span><span class="si">%s</span><span class="s1">].&#39;</span> <span class="o">%</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;Reading C4 parameters from [</span><span class="si">%s</span><span class="s1">].&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">c4file</span>

        <span class="k">return</span> <span class="n">retstr</span>

<div class="viewcode-block" id="add12_6_4.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.add12_6_4.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.add1264</span> <span class="kn">import</span> <span class="n">params1264</span> <span class="k">as</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span>
                <span class="n">num_items</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]),</span>
                <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;For 12-6-4 potential used for divalent metal ions&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c4file</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">watermodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polfile</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">tunfactor</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="HMassRepartition"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.HMassRepartition">[docs]</a><span class="k">class</span> <span class="nc">HMassRepartition</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This action implements hydrogen mass repartitioning in the system by</span>
<span class="sd">    changing the mass of each hydrogen to the desired value (the default new</span>
<span class="sd">    hydrogen mass is 3.024 daltons) and adjusting the mass of the atom to which</span>
<span class="sd">    it is bonded by the amount required to leave the total mass unchanged. By</span>
<span class="sd">    default, water hydrogen masses are unchanged (the SETTLE algorithm for</span>
<span class="sd">    implementing constraints on water molecules is analytical). Water masses can</span>
<span class="sd">    be repartitioned as well with the &#39;dowater&#39; keyword.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;[&lt;mass&gt;] [dowater]&#39;</span>
<div class="viewcode-block" id="HMassRepartition.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.HMassRepartition.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changewater</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;dowater&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_h_mass</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_float</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">3.024</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Repartitioning hydrogen masses to </span><span class="si">%s</span><span class="s1"> daltons. &#39;</span> <span class="o">%</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">new_h_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changewater</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retstr</span> <span class="o">+</span> <span class="s1">&#39;Also changing water hydrogen masses.&#39;</span>
        <span class="k">return</span> <span class="n">retstr</span> <span class="o">+</span> <span class="s1">&#39;Not changing water hydrogen masses.&#39;</span>

<div class="viewcode-block" id="HMassRepartition.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.HMassRepartition.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Back up the masses in case something goes wrong</span>
        <span class="n">original_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">water</span> <span class="o">=</span> <span class="n">SOLVENT_NAMES</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">changewater</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">water</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">heteroatom</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">heteroidx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bondeds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">heteroidx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondeds</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bondeds</span><span class="p">[</span><span class="n">heteroidx</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">heteroatom</span> <span class="o">=</span> <span class="n">bondeds</span><span class="p">[</span><span class="n">heteroidx</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="n">heteroidx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">heteroatom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Only bonded to other hydrogens. Weird, but do not repartition</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;H atom detected not bound to heteroatom. &#39;</span>
                              <span class="s1">&#39;Ignoring.&#39;</span><span class="p">,</span> <span class="n">ParmWarning</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">transfermass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_h_mass</span> <span class="o">-</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_h_mass</span>
            <span class="n">heteroatom</span><span class="o">.</span><span class="n">mass</span> <span class="o">-=</span> <span class="n">transfermass</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;MASS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_h_mass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;MASS&#39;</span><span class="p">][</span><span class="n">heteroatom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">transfermass</span>

        <span class="c1"># Now make sure that all masses are positive, or revert masses and</span>
        <span class="c1"># raise an exception</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">original_masses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;MASS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_masses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">HMassRepartitionError</span><span class="p">(</span><span class="s1">&#39;Too much mass removed from atom &#39;</span>
                                            <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. Hydrogen masses must be &#39;</span>
                                            <span class="s1">&#39;smaller.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="OpenMM"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.OpenMM">[docs]</a><span class="k">class</span> <span class="nc">OpenMM</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class will read a sander/pmemd input file and run an equivalent</span>
<span class="sd">    simulation using the OpenMM Python API. It uses a topology file that has</span>
<span class="sd">    been defined (and/or modified) here. The command-line flags are identical to</span>
<span class="sd">    those used for sander and pmemd (described in the Amber manual). You can</span>
<span class="sd">    additionally specify a computational platform available through OpenMM such</span>
<span class="sd">    as CUDA, OpenCL, Reference, and CPU.</span>

<span class="sd">    The default prmtop will be the &#39;active&#39; parm. The prmtop can be changed</span>
<span class="sd">    using either the &#39;parm&#39; keyword or the &#39;-p&#39; flag, but it must resolve to one</span>
<span class="sd">    of the stored topology files. Any parm given with the &#39;-p&#39; flag has</span>
<span class="sd">    precedence. If present, the &#39;dcd&#39; keyword triggers writting DCD-formatted</span>
<span class="sd">    trajectory files instead of NetCDF when ioutfm=1. The DCD trajectory writing</span>
<span class="sd">    offers binary trajectory support without requiring a NetCDF-Python library.</span>

<span class="sd">    The &#39;progress&#39; keyword triggers printing of ParmEd&#39;s progress in setting up</span>
<span class="sd">    and starting the calculation.</span>

<span class="sd">    The &#39;script&#39; keyword provides a file to write an OpenMM script that performs</span>
<span class="sd">    the same calculation requested by this ParmEd command. The &#39;norun&#39; command</span>
<span class="sd">    will prevent anything from actually being run and can only be used when a</span>
<span class="sd">    script file is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[-p &lt;parm&gt;|&lt;parm index&gt;] [sander/pmemd options] [-platform &#39;</span>
            <span class="s1">&#39;&lt;platform&gt;] [-precision &lt;precision model&gt;] [dcd] [progress] &#39;</span>
            <span class="s1">&#39;[script &lt;script_file.py&gt;] [norun]&#39;</span><span class="p">)</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>

<div class="viewcode-block" id="OpenMM.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.OpenMM.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="n">parm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span>
        <span class="c1"># This consumes the remaining arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span> <span class="o">=</span> <span class="n">ArgumentList</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Running Amber-style simulation with OpenMM using the command &quot;</span>
                <span class="s2">&quot;string:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="s2">This may take awhile...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="p">)</span>

<div class="viewcode-block" id="OpenMM.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.OpenMM.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Runs the OpenMM simulation &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.simulations.openmm</span> <span class="kn">import</span> <span class="n">simulate</span><span class="p">,</span> <span class="n">HAS_OPENMM</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_OPENMM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;OpenMM could not be imported. Skipping.&#39;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
        <span class="c1"># First try to load a restart file if it was supplied</span>
        <span class="n">inptraj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-y&#39;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">has_inpcrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inptraj</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_inpcrd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;No input coordinates provided.&#39;</span><span class="p">)</span>
        <span class="c1"># Eliminate some incompatibilities that are easy to catch now</span>
        <span class="n">simulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="energy"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.energy">[docs]</a><span class="k">class</span> <span class="nc">energy</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This action will compute a single-point energy for the loaded structure (you</span>
<span class="sd">    must use &#39;loadRestart&#39; prior to this command to load coordinates). The</span>
<span class="sd">    following options and keywords are supported:</span>

<span class="sd">    Options</span>
<span class="sd">    -------</span>

<span class="sd">        - cutoff &lt;cut&gt; : The size of the non-bonded cutoff, in Angstroms.</span>
<span class="sd">                         Default 8 A for periodic systems or infinite for</span>
<span class="sd">                         nonperiodic systems</span>

<span class="sd">    For systems with no periodic box information</span>
<span class="sd">    --------------------------------------------</span>

<span class="sd">        - igb &lt;IGB&gt; : An integer corresponding to the desired GB model. May be</span>
<span class="sd">                      1, 2, 5, 7, or 8 as described by the sander and pmemd</span>
<span class="sd">                      manual. Default 5.</span>
<span class="sd">        - saltcon &lt;conc&gt; : The salt concentration, in mol/L, modeled by a Debye</span>
<span class="sd">                           screening parameter. Default 0.0</span>

<span class="sd">    For periodic systems</span>
<span class="sd">    --------------------</span>

<span class="sd">        - Ewald : Use an Ewald sum to compute long-range electrostatics instead</span>
<span class="sd">                  of PME</span>
<span class="sd">        - nodisper : Do not use a long-range vdW dispersion correction</span>

<span class="sd">    OpenMM-specific options</span>
<span class="sd">    -----------------------</span>

<span class="sd">        - omm : If present, this keyword will instruct ParmEd to use OpenMM to</span>
<span class="sd">                compute the energies (and optionally forces) using OpenMM</span>
<span class="sd">                instead of sander.</span>
<span class="sd">        - platform &lt;platform&gt; : OpenMM compute platform to use. Options are</span>
<span class="sd">                CUDA, OpenCL, Reference, and CPU. Consult the OpenMM manual for</span>
<span class="sd">                details (only used if &#39;omm&#39; is provided)</span>
<span class="sd">        - precision &lt;precision model&gt; : Precision model to use. Options are</span>
<span class="sd">                single, double, and mixed. Reference platform is always double</span>
<span class="sd">                and CPU platform is always single. Mixed (default) uses single</span>
<span class="sd">                precision for calculations and double for accumulation (only</span>
<span class="sd">                used if &#39;omm&#39; is provided)</span>
<span class="sd">        - decompose : Print bond, angle, dihedral, and nonbonded energies</span>
<span class="sd">                      separately</span>
<span class="sd">        - applayer : Use OpenMM&#39;s class to compute the energy</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">        # Using AMBER</span>
<span class="sd">        import parmed as pmd</span>
<span class="sd">        parm = pmd.load_file(&#39;prmtop&#39;, xyz=&#39;rst7&#39;)</span>
<span class="sd">        pmd.tools.energy(parm, &#39;igb 8&#39;).execute()</span>

<span class="sd">        # Using Openmm</span>
<span class="sd">        pmd.tools.energy(parm, &#39;igb 5 omm&#39;).execute()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[cutoff &lt;cut&gt;] [[igb &lt;IGB&gt;] [saltcon &lt;conc&gt;] | [Ewald]] &#39;</span>
             <span class="s1">&#39;[nodisper] [omm] [applayer] [platform &lt;platform&gt;] [precision &#39;</span>
             <span class="s1">&#39;&lt;precision model&gt;] [decompose]&#39;</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

<div class="viewcode-block" id="energy.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.energy.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;omm&#39;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmberParm</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span> <span class="o">=</span> <span class="n">ArgumentList</span><span class="p">(</span><span class="n">arg_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">AmoebaParm</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Amoeba prmtops can only get energies &#39;</span>
                                      <span class="s1">&#39;from sander&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Computing a single-point energy for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span>

<div class="viewcode-block" id="energy.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.energy.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">parmed.tools.simulations.openmm</span> <span class="kn">import</span> <span class="n">energy</span><span class="p">,</span> <span class="n">HAS_OPENMM</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_OPENMM</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;OpenMM could not be imported. Skipping.&#39;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>

            <span class="n">energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">parmed.tools.simulations.sanderapi</span> <span class="kn">import</span> <span class="n">energy</span><span class="p">,</span> <span class="n">HAS_SANDER</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_SANDER</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;sander could not be imported. Skipping.&#39;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
            <span class="c1"># Consume the OMM-specific arguments so we don&#39;t have any apparently</span>
            <span class="c1"># unused arguments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;decompose&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;applayer&#39;</span><span class="p">)</span>
            <span class="n">energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="deleteBond"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deleteBond">[docs]</a><span class="k">class</span> <span class="nc">deleteBond</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This action deletes any bonds that occur between the atoms in two masks.</span>

<span class="sd">        - &lt;mask1&gt; : Amber mask defining one of the atoms in a bond</span>
<span class="sd">        - &lt;mask2&gt; : Amber mask defining the other atom in the bond</span>
<span class="sd">        - [verbose] : Print out every bond that is deleted as well as the</span>
<span class="sd">                      number of other valence terms that were eliminated.</span>

<span class="sd">    All bonds will be matched in which one atom comes from &lt;mask1&gt; and the other</span>
<span class="sd">    atom comes from &lt;mask2&gt;. This action will also delete any other valence term</span>
<span class="sd">    (like angles and dihedrals) that would get severed by the deletion of one of</span>
<span class="sd">    the bonds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;&lt;mask1&gt; &lt;mask2&gt;&#39;</span>
<div class="viewcode-block" id="deleteBond.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deleteBond.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_mask</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">)</span>
        <span class="c1"># Go through each atom in mask1 and see if it forms a bond with any atom</span>
        <span class="c1"># in mask2.</span>
        <span class="n">bonds_to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_angles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_dihedrals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_rbtorsions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_urey_bradleys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_impropers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_cmaps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_trigonal_angles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_oopbends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_pi_torsions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_strbnds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">del_tortors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="o">.</span><span class="n">Selected</span><span class="p">():</span>
            <span class="n">ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="o">.</span><span class="n">Selected</span><span class="p">():</span>
                <span class="n">aj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="c1"># Skip if these two atoms are identical</span>
                <span class="k">if</span> <span class="n">ai</span> <span class="ow">is</span> <span class="n">aj</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">ai</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">aj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">bonds_to_delete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
        <span class="c1"># Find other valence terms we need to delete</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bond</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds_to_delete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds_to_delete</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_angles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">dihed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_dihedrals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">dihed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_rbtorsions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">urey</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">urey</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_urey_bradleys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">improper</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">impropers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">improper</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_impropers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">cmaps</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_cmaps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trigonal_angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">trigonal_angle</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_trigonal_angles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oopbend</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">oopbend</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_oopbends</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pitor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">pitor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_pi_torsions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">strbnd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">strbnd</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_strbnds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tortor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">tortor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">del_tortors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;No bonds to delete&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Deleting the </span><span class="si">%d</span><span class="s1"> bonds found between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">)</span>
        <span class="c1"># Now we want full statistics</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Deleting </span><span class="si">%d</span><span class="s1"> bonds between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="p">:</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">bond</span><span class="p">]</span><span class="o">.</span><span class="n">atom2</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%d</span><span class="s1"> [</span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">] </span><span class="si">%s</span><span class="s1"> --- </span><span class="si">%d</span><span class="s1"> [</span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">] </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">a1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">a2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;Deleting </span><span class="si">%d</span><span class="s1"> angles, &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_angles</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> Urey-Bradleys, </span><span class="si">%d</span><span class="s1"> trigonal angles,</span><span class="se">\n</span><span class="s1">         &#39;</span>
                       <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> dihedrals, </span><span class="si">%d</span><span class="s1"> out-of-plane bends, </span><span class="si">%d</span><span class="s1"> stretch-bends</span><span class="se">\n</span><span class="s1">&#39;</span>
                       <span class="s1">&#39;         and </span><span class="si">%d</span><span class="s1"> torsion-torsions&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_urey_bradleys</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_trigonal_angles</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_dihedrals</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_rbtorsions</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_oopbends</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_strbnds</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_tortors</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">impropers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> Urey-Bradleys, </span><span class="si">%d</span><span class="s1"> impropers,</span><span class="se">\n</span><span class="s1">         </span><span class="si">%d</span><span class="s1"> dihedrals &#39;</span>
                        <span class="s1">&#39;and </span><span class="si">%d</span><span class="s1"> CMAPs&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_urey_bradleys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_impropers</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_dihedrals</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_rbtorsions</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_cmaps</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;and </span><span class="si">%d</span><span class="s1"> dihedrals&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_dihedrals</span><span class="p">)</span> <span class="o">+</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_rbtorsions</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">retstr</span>

<div class="viewcode-block" id="deleteBond.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.deleteBond.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_bonds</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_angles</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_dihedrals</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_rbtorsions</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_urey_bradleys</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_impropers</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_cmaps</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_trigonal_angles</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_oopbends</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_tortors</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_strbnds</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">prune_empty_terms</span><span class="p">()</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="chamber"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.chamber">[docs]</a><span class="k">class</span> <span class="nc">chamber</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This action will read CHARMM parameter, topology (RTF), and stream (STR)</span>
<span class="sd">    files and apply those parameters to a structure defined in a CHARMM PSF</span>
<span class="sd">    (protein structure file). XPLOR, CHARMM, and VMD-generated PSF files are all</span>
<span class="sd">    supported. You may specify -top, -param, and -str as many times as you want</span>
<span class="sd">    to provide multiple parameter files. All topology files are read first (in</span>
<span class="sd">    the order they are specified), followed by all parameter files, and finally</span>
<span class="sd">    all stream files are read in.  Topology files are only necessary if the</span>
<span class="sd">    parameter files do not define the atom types (newer CHARMM force fields</span>
<span class="sd">    define atom types directly in the parameter file. Environment variables and</span>
<span class="sd">    shell wild-cards (* and ?), as well as the home shortcut character ~ are</span>
<span class="sd">    properly expanded when looking for files.</span>

<span class="sd">    Options</span>
<span class="sd">    -------</span>
<span class="sd">        - -top        CHARMM topology, or Residue Topology File (RTF) file</span>
<span class="sd">        - -param      CHARMM parameter file</span>
<span class="sd">        - -str        CHARMM stream file. Only RTF and parameter sections read</span>
<span class="sd">        - -toppar     CHARMM topology, parameter, and/or stream file(s). File</span>
<span class="sd">                      type is detected from extension (or in the case of .inp</span>
<span class="sd">                      files, the presence of &#39;top&#39;, &#39;par&#39; in the name)</span>
<span class="sd">        - -psf        CHARMM PSF file</span>
<span class="sd">        - -crd        Coordinate file (PDB, CHARMM CRD, Amber restart, etc.)</span>
<span class="sd">        - -nocmap     Do not use any CMAP parameters</span>
<span class="sd">        - -box        Box dimensions. If no angles are defined, they are assumed</span>
<span class="sd">                      to be 90 degrees (orthorhombic box). Alternatively, you</span>
<span class="sd">                      can use the word &#39;bounding&#39; to define a box that encloses</span>
<span class="sd">                      the centers of all atoms.</span>
<span class="sd">        - -radii      Implicit solvent solvation radii. &lt;radiusset&gt; can be</span>
<span class="sd">                      amber6, bondi, mbondi, mbondi2, mbondi3</span>
<span class="sd">                      Same effect as the changeRadii command. Default is mbondi.</span>
<span class="sd">        - nosettle    This avoids changing the names of the water residue and</span>
<span class="sd">                      oxygen atoms from TIP3 and OH2 to WAT and O</span>

<span class="sd">    If the PDB file has a CRYST1 record, the box information will be set from</span>
<span class="sd">    there. Any box info given on the command-line will override the box found in</span>
<span class="sd">    the crd file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-top &lt;RTF&gt; -param &lt;PAR&gt; [-str &lt;STR&gt;] -psf &lt;PSF&gt; [-crd &lt;CRD&gt;] &#39;</span>
             <span class="s1">&#39;[-nocmap] [-box a,b,c[,alpha,beta,gamma]|bounding] [-radii &#39;</span>
             <span class="s1">&#39;&lt;radiusset&gt;] [nosettle]&#39;</span><span class="p">)</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="chamber.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.chamber.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">expandvars</span><span class="p">,</span> <span class="n">expanduser</span>
        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="c1"># First get all of the topology files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-top&#39;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">topfile</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-top&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">topfile</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">topfile</span><span class="p">)</span>
            <span class="n">topfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">topfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">topfiles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FileDoesNotExist</span><span class="p">(</span><span class="s1">&#39;CHARMM RTF file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span>
                                       <span class="n">topfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">topfiles</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-param&#39;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-param&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FileDoesNotExist</span><span class="p">(</span><span class="s1">&#39;CHARMM parameter file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span>
                                       <span class="o">%</span> <span class="n">param</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-str&#39;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-str&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">streams</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">streams</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FileDoesNotExist</span><span class="p">(</span><span class="s1">&#39;CHARMM stream file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span>
                                       <span class="n">stream</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">streams</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-toppar&#39;</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">toppar</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-toppar&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">toppar</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">toppar</span><span class="p">)</span>
            <span class="n">toppars</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">toppar</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">toppars</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FileDoesNotExist</span><span class="p">(</span><span class="s1">&#39;CHARMM toppar file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span>
                                       <span class="n">toppar</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">toppars</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># ignore the directory name</span>
                <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.rtf&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.top&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.par&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.prm&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">base</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.inp&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;par&#39;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;top&#39;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Cannot detect filetype of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Cannot detect filetype of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">crdfile</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-crd&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crdfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crdfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="n">expandvars</span><span class="p">(</span><span class="n">crdfile</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">crdfiles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FileDoesNotExist</span><span class="p">(</span><span class="s1">&#39;Coordinate file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span>
                                       <span class="n">crdfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crdfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Too many coordinate files selected through &#39;</span>
                                 <span class="s1">&#39;globbing&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span> <span class="o">=</span> <span class="n">crdfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;-nocmap&#39;</span><span class="p">)</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-psf&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;chamber requires a PSF file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="n">expandvars</span><span class="p">(</span><span class="n">psf</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FileDoesNotExist</span><span class="p">(</span><span class="s1">&#39;chamber PSF file </span><span class="si">%s</span><span class="s1"> cannot be found&#39;</span> <span class="o">%</span> <span class="n">psf</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Too many PSF files selected through globbing&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-box&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">box</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;bounding&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">box</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Box info must be comma-delimited floats&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Box must be 3 lengths or 3 lengths and 3 &#39;</span>
                                 <span class="s1">&#39;angles!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s1">&#39;bounding&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;-radii&#39;</span><span class="p">,</span> <span class="s1">&#39;mbondi&#39;</span><span class="p">)</span>

        <span class="c1"># Make sure we have legal input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;No parameter files were provided!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="ow">in</span> <span class="n">GB_RADII</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Illegal radius set </span><span class="si">%s</span><span class="s1"> -- must be one of &#39;</span>
                             <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GB_RADII</span><span class="p">)))</span>
        <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;nocondense&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nosettle</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;nosettle&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Creating chamber topology file from PSF </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;RTF files [</span><span class="si">%s</span><span class="s1">], &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="p">:</span>
                <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;and &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;PAR files [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="p">:</span>
                <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;, and &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;STR files [</span><span class="si">%s</span><span class="s1">].&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; Coords from </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; Using CMAP.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; NO CMAP.&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">==</span> <span class="s1">&#39;bounding&#39;</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; Defining a bounding box.&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; Box info </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; GB Radius set </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nosettle</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; Not changing water names.&#39;</span>
        <span class="k">return</span> <span class="n">retstr</span>

<div class="viewcode-block" id="chamber.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.chamber.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parmset</span> <span class="o">=</span> <span class="n">CharmmParameterSet</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topfiles</span><span class="p">:</span>
            <span class="n">parmset</span><span class="o">.</span><span class="n">read_topology_file</span><span class="p">(</span><span class="n">tfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paramfiles</span><span class="p">:</span>
            <span class="n">parmset</span><span class="o">.</span><span class="n">read_parameter_file</span><span class="p">(</span><span class="n">pfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">streamfiles</span><span class="p">:</span>
            <span class="n">parmset</span><span class="o">.</span><span class="n">read_stream_file</span><span class="p">(</span><span class="n">sfile</span><span class="p">)</span>

        <span class="c1"># Now read the PSF</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">CharmmPsfFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">)</span>

        <span class="c1"># Read the PDB and set the box information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crdbox</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Automatic format determination</span>
            <span class="n">crd</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ChamberError</span><span class="p">(</span><span class="s1">&#39;No coordinates in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">crdfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">crd</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">crd</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">crdbox</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">box</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Trajectory</span>
                    <span class="n">crdbox</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ChamberError</span><span class="p">(</span><span class="s1">&#39;Mismatch in number of coordinates (</span><span class="si">%d</span><span class="s1">) and &#39;</span>
                                   <span class="s1">&#39;3*number of atoms (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span>
                                   <span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))</span>
            <span class="c1"># Set the coordinates now, since creating the parm may re-order the</span>
            <span class="c1"># atoms in order to maintain contiguous molecules</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="c1"># Set the box info from self.box if set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">crdbox</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crdbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">crdbox</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">crdbox</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">crdbox</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected box array shape&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">==</span> <span class="s1">&#39;bounding&#39;</span><span class="p">:</span>
                <span class="c1"># Define the bounding box</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected box array shape&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the box information</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">psf</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected box array shape&#39;</span><span class="p">)</span>

        <span class="n">nsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parmset</span><span class="o">.</span><span class="n">parametersets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nsets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frcfield</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pset</span> <span class="ow">in</span> <span class="n">parmset</span><span class="o">.</span><span class="n">parametersets</span><span class="p">:</span>
                <span class="n">frcfield</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">nsets</span><span class="p">,</span> <span class="n">pset</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frcfield</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;No FF information parsed...&#39;</span><span class="p">]</span>

        <span class="c1"># Delete the CMAP list if requested</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">:</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">clear_cmap</span><span class="p">()</span>
        <span class="c1"># Now load the parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">psf</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">(</span><span class="n">parmset</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ParmedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChamberError</span><span class="p">(</span><span class="s1">&#39;Problem assigning parameters to PSF: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">parm</span> <span class="o">=</span> <span class="n">ConvertFromPSF</span><span class="p">(</span><span class="n">psf</span><span class="p">,</span> <span class="n">parmset</span><span class="p">)</span>
        <span class="n">parm</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf</span>
        <span class="n">changeRadii</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">add_parm</span><span class="p">(</span><span class="n">parm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="n">parm</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nosettle</span><span class="p">:</span>
            <span class="c1"># Change water residue names from TIP3 to WAT and OH2 to O</span>
            <span class="k">for</span> <span class="n">res</span><span class="p">,</span> <span class="n">nam</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">residues</span><span class="p">,</span> <span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_LABEL&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">nam</span> <span class="o">!=</span> <span class="s1">&#39;TIP3&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_LABEL&#39;</span><span class="p">][</span><span class="n">res</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WAT&#39;</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;OH2&#39;</span><span class="p">:</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">][</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;O&#39;</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="minimize"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.minimize">[docs]</a><span class="k">class</span> <span class="nc">minimize</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This action takes a structure and minimizes the energy using either</span>
<span class="sd">    scipy.optimize.minimize (with BFGS) and the sander API *or* OpenMM.</span>
<span class="sd">    Following this action, the coordinates stored in the topology will be the</span>
<span class="sd">    minimized structure</span>

<span class="sd">    General Options</span>
<span class="sd">    ---------------</span>
<span class="sd">        - omm                 Use OpenMM instead of sander+scipy to minimize</span>
<span class="sd">        - cutoff &lt;cutoff&gt;     Nonbonded cutoff in Angstroms</span>
<span class="sd">        - tol &lt;tolerance&gt;     The largest energy difference between successive</span>
<span class="sd">                              steps in the minimization allow the minimization</span>
<span class="sd">                              to stop (Default 0.001)</span>
<span class="sd">        - maxcyc &lt;cycles&gt;     The maximum number of minimization cycles</span>
<span class="sd">                              permitted.  No limit by default (minimization</span>
<span class="sd">                              stops when tolerance is satisfied)</span>

<span class="sd">    Implicit Solvent options</span>
<span class="sd">    ------------------------</span>
<span class="sd">        - igb &lt;IGB&gt;           GB model to use (0=No GB, 1,2,5,7,8 correspond to</span>
<span class="sd">                              Amber models)</span>
<span class="sd">        - saltcon &lt;conc&gt;      Salt concentration for GB in Molarity</span>

<span class="sd">    OpenMM-specific options</span>
<span class="sd">    -----------------------</span>
<span class="sd">        - restrain &lt;mask&gt;     Selection of atoms to restrain</span>
<span class="sd">        - weight &lt;k&gt;          Weight of positional restraints (kcal/mol/A^2)</span>
<span class="sd">        - norun               Do not run the calculation</span>
<span class="sd">        - script &lt;script&gt;     Name of the Python script to write to run this</span>
<span class="sd">                              calculation</span>
<span class="sd">        - platform &lt;platform&gt; Which compute platform to use. Options are CUDA,</span>
<span class="sd">                              OpenCL, CPU, and Reference. Consult OpenMM docs</span>
<span class="sd">                              for more information</span>
<span class="sd">        - precision &lt;precision_model&gt; Which precision model to use. Can be</span>
<span class="sd">                              &quot;single&quot;, &quot;double&quot;, or &quot;mixed&quot;, and only has an</span>
<span class="sd">                              effect on the CUDA and OpenCL platforms.</span>

<span class="sd">    The implicit solvent options will be ignored for systems with periodic</span>
<span class="sd">    boundary conditions. The precision option will be ignored for platforms that</span>
<span class="sd">    do not support user-specified precision. The platform, precision, and script</span>
<span class="sd">    arguments will be ignored unless ``omm`` is specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[cutoff &lt;cut&gt;] [[igb &lt;IGB&gt;] [saltcon &lt;conc&gt;]] [[restrain &lt;mask&gt;] &#39;</span>
             <span class="s1">&#39;[weight &lt;k&gt;]] [norun] [script &lt;script_file.py&gt;] [platform &#39;</span>
             <span class="s1">&#39;&lt;platform&gt;] [precision &lt;precision model&gt;] [tol &lt;tolerance&gt;] &#39;</span>
             <span class="s1">&#39;[maxcyc &lt;cycles&gt;] [omm]&#39;</span><span class="p">)</span>
    <span class="n">not_supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">AmoebaParm</span><span class="p">,)</span>

<div class="viewcode-block" id="minimize.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.minimize.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;omm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;cutoff&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_mask</span><span class="p">(</span><span class="s1">&#39;restrain&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_int</span><span class="p">(</span><span class="s1">&#39;igb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saltcon</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;saltcon&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norun</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;norun&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;mixed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_float</span><span class="p">(</span><span class="s1">&#39;tol&#39;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_int</span><span class="p">(</span><span class="s1">&#39;maxcyc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Check for legal values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># no cutoff</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="mf">8.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Cutoff unreasonably small.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">saltcon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Salt concentration must be non-negative&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restrain</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Restraints only permitted with omm option&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Restraints require a restraint stiffness &#39;</span>
                                 <span class="s1">&#39;larger than 0 kcal/mol/A^2&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restrain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenCL&#39;</span><span class="p">,</span> <span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;platform must be CUDA, OpenCL, CPU or Reference &#39;</span>
                             <span class="s1">&#39;(NOT </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mixed&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;precision must be single, double, or mixed.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Illegal igb value (</span><span class="si">%d</span><span class="s1">). Must be 0, 1, 2, 5, 6, &#39;</span>
                             <span class="s1">&#39;7, or 8&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;maxcyc must be a positive integer&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;tolerance must be positive&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;tolerance must be &gt; 0 if maxcyc is not set.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norun</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;norun only makes sense with the script and omm &#39;</span>
                             <span class="s1">&#39;options&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Minimizing </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">):</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;with PME &#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;in gas phase &#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;with GB(HCT) &#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;with GB(OBC1) &#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;with GB(OBC2) &#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;with GB(GBneck) &#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;with GB(GBneck2) &#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;and no cutoff &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;and a cutoff of </span><span class="si">%.2f</span><span class="s1"> Angstroms &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
        <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;to a tolerance of </span><span class="si">%s</span><span class="s1">. &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restrain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;Restraining </span><span class="si">%s</span><span class="s1"> with weights </span><span class="si">%f</span><span class="s1">. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restrain</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39;Using at most </span><span class="si">%d</span><span class="s1"> minimization steps.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span>
        <span class="k">return</span> <span class="n">retstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<div class="viewcode-block" id="minimize.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.minimize.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.simulations.openmm</span> <span class="kn">import</span> <span class="n">minimize</span> <span class="k">as</span> <span class="n">omm_min</span>
        <span class="kn">from</span> <span class="nn">parmed.tools.simulations.sanderapi</span> <span class="kn">import</span> <span class="n">minimize</span> <span class="k">as</span> <span class="n">san_min</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimulationError</span><span class="p">(</span><span class="s1">&#39;You must load coordinates before &quot;minimize&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_openmm</span><span class="p">:</span>
            <span class="n">omm_min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saltcon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restrain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">san_min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">igb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saltcon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxcyc</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="outPDB"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outPDB">[docs]</a><span class="k">class</span> <span class="nc">outPDB</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a PDB file from the currently active system to &lt;file&gt;</span>

<span class="sd">        - &lt;file&gt;: The PDB file to write</span>
<span class="sd">        - [norenumber]: Use the original atom and residue numbering if available</span>
<span class="sd">        - [charmm]: Put the SEGID, if available, in columns 72 to 76</span>
<span class="sd">        - [anisou]: Write anisotropic B-factors if available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;&lt;file&gt; [norenumber] [charmm] [anisou]&quot;</span>

<div class="viewcode-block" id="outPDB.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outPDB.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;norenumber&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charmm</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;charmm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anisou</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;anisou&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Parm </span><span class="si">%s</span><span class="s1"> does not have loaded coordinates&#39;</span> <span class="o">%</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Writing PDB file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; renumbering atoms and residues&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; not renumbering atoms and residues&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charmm</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; and adding CHARMM SEGIDs&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anisou</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; and adding anisotropic B-factors&#39;</span>
        <span class="k">return</span> <span class="n">retstr</span>

<div class="viewcode-block" id="outPDB.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outPDB.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">,</span>
                            <span class="n">charmm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charmm</span><span class="p">,</span> <span class="n">write_anisou</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anisou</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="outCIF"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outCIF">[docs]</a><span class="k">class</span> <span class="nc">outCIF</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a PDBx/mmCIF file from the currently active system to &lt;file&gt;</span>

<span class="sd">        - &lt;file&gt;: The PDBx/mmCIF file to write</span>
<span class="sd">        - [norenumber]: Use the original atom and residue numbering if available</span>
<span class="sd">        - [anisou]: Write anisotropic B-factors if available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;&lt;file&gt; [norenumber] [charmm] [anisou]&quot;</span>

<div class="viewcode-block" id="outCIF.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outCIF.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;norenumber&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anisou</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;anisou&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Parm </span><span class="si">%s</span><span class="s1"> does not have loaded coordinates&#39;</span> <span class="o">%</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="s1">&#39;Writing PDB file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; renumbering atoms and residues&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; not renumbering atoms and residues&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anisou</span><span class="p">:</span>
            <span class="n">retstr</span> <span class="o">+=</span> <span class="s1">&#39; and adding anisotropic B-factors&#39;</span>
        <span class="k">return</span> <span class="n">retstr</span>

<div class="viewcode-block" id="outCIF.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.outCIF.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">write_cif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">renumber</span><span class="p">,</span>
                            <span class="n">write_anisou</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anisou</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<div class="viewcode-block" id="gromber"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.gromber">[docs]</a><span class="k">class</span> <span class="nc">gromber</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a Gromacs topology file with parameters as an Amber-formatted system.</span>
<span class="sd">    Note, if your Gromacs topology file requires any include topology files, you</span>
<span class="sd">    will need to have Gromacs installed for this to work.</span>

<span class="sd">        - &lt;top_file&gt;: The Gromacs topology file to load</span>
<span class="sd">        - &lt;coord_file&gt;: The coordinate file to load into the system. Can be any</span>
<span class="sd">                        recognized format (GRO, PDB, mmCIF, inpcrd, etc.)</span>
<span class="sd">        - define &lt;DEFINE[=VAR]&gt;: Preprocessor defines that control the</span>
<span class="sd">                        processing of the Gromacs topology file.</span>
<span class="sd">        - topdir &lt;directory&gt;: The directory containing all Gromacs include</span>
<span class="sd">                        topology files. This is only necessary if Gromacs is not</span>
<span class="sd">                        installed in a location that ParmEd can find.</span>
<span class="sd">        - radii &lt;radiusset&gt;: The GB radius set to use. Can be &#39;mbondi&#39;, &#39;bondi&#39;,</span>
<span class="sd">                        &#39;mbondi2&#39;, or &#39;amber6&#39;. Default is mbondi</span>

<span class="sd">    Gromacs topology files do not store the unit cell information. Therefore, in</span>
<span class="sd">    order to make sure that unit cell information is properly assigned to the</span>
<span class="sd">    resulting system, the provided ``&lt;coord_file&gt;`` should contain unit cell</span>
<span class="sd">    information (e.g., GRO, PDB, PDBx/mmCIF, and inpcrd files can all store box</span>
<span class="sd">    information).</span>

<span class="sd">    ParmEd will try to locate the Gromacs topology directory using either the</span>
<span class="sd">    GMXDATA or GMXBIN environment variables (which should point to the</span>
<span class="sd">    $PREFIX/share/gromacs or $PREFIX/bin directories, respectively, where</span>
<span class="sd">    $PREFIX is the install prefix). If neither is set, the topology directory is</span>
<span class="sd">    located relative to the location of the ``gmx`` (Gromacs 5+) or ``pdb2gmx``</span>
<span class="sd">    (Gromacs 4 or older) in the user&#39;s PATH. If none of the above is true, the</span>
<span class="sd">    default installation location (/usr/local/gromacs/share/gromacs/top) is</span>
<span class="sd">    used. Any provided ``topdir`` will override default choices (but only for</span>
<span class="sd">    this particular command -- future ``gromber`` actions will use the default</span>
<span class="sd">    location again).</span>

<span class="sd">    You can provide as many defines as you wish, and the ordering you specify</span>
<span class="sd">    them is preserved. The default value assigned to each define is &quot;1&quot;. To</span>
<span class="sd">    provide multiple defines, use the ``define`` keyword multiple times, for</span>
<span class="sd">    example:</span>

<span class="sd">    define MYVAR=something define MYVAR2=something_else ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;top_file&gt; [&lt;coord_file&gt;] [define &lt;DEFINE[=VAR]&gt;] &quot;</span>
             <span class="s2">&quot;[topdir &lt;directory&gt;] [radii &lt;radiusset&gt;]&quot;</span><span class="p">)</span>
    <span class="n">needs_parm</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="gromber.init"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.gromber.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topfile</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">()</span>
        <span class="n">defines</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">current_define</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;define&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">current_define</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">current_define</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">current_define</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Illegal define: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">current_define</span><span class="p">)</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span>
                <span class="n">defines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">defines</span><span class="p">[</span><span class="n">current_define</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">current_define</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;define&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defines</span> <span class="o">=</span> <span class="n">defines</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_topdir</span> <span class="o">=</span> <span class="n">gromacs</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span>
        <span class="n">topdir</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;topdir&#39;</span><span class="p">,</span> <span class="n">gromacs</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span><span class="p">)</span>
        <span class="n">gromacs</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span> <span class="o">=</span> <span class="n">topdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_next_string</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">arg_list</span><span class="o">.</span><span class="n">get_key_string</span><span class="p">(</span><span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="s1">&#39;mbondi&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Converting Gromacs topology </span><span class="si">%s</span><span class="s1"> to Amber. &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">topfile</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Using the following defines:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">):</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Using topology directory [</span><span class="si">%s</span><span class="s1">]. &#39;</span> <span class="o">%</span>
                      <span class="n">gromacs</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No coordinates provided.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Getting coordinates (and box) from </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span>

<div class="viewcode-block" id="gromber.execute"><a class="viewcode-back" href="../../../api/parmed/parmed.tools.actions.html#parmed.tools.actions.gromber.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">gromacs</span><span class="o">.</span><span class="n">GromacsTopologyFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topfile</span><span class="p">,</span><span class="n">defines</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defines</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">gromacs</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_topdir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crd</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crd</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Coordinate/topology file size mismatch&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">crd</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">xx</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">xy</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">xz</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not contain coordinates&#39;</span> <span class="o">%</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">vx</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">vx</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">vy</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">vy</span>
                        <span class="n">a1</span><span class="o">.</span><span class="n">vz</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">vz</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">crd</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">crd</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">coordinates</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># first frame</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">crd</span><span class="p">,</span> <span class="s1">&#39;positions&#39;</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">crd</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;Cannot find coordinates in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">crd</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">box</span><span class="p">):</span>
                <span class="n">top</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">top</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">crd</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">top</span><span class="o">.</span><span class="n">impropers</span> <span class="ow">or</span> <span class="n">top</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="ow">or</span> <span class="n">top</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="n">ChamberParm</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm</span> <span class="o">=</span> <span class="n">AmberParm</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topfile</span>
        <span class="n">changeRadii</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_list</span><span class="o">.</span><span class="n">add_parm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm</span><span class="p">)</span></div></div>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>

<span class="c1"># Private helper methods</span>

<span class="k">def</span> <span class="nf">_change_lj_pair</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">atom_1</span><span class="p">,</span> <span class="n">atom_2</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">one_4</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">one_4</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;LENNARD_JONES_14&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;LENNARD_JONES&#39;</span>

    <span class="c1"># Make sure that atom type 1 comes first</span>
    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">atom_1</span><span class="p">,</span> <span class="n">atom_2</span><span class="p">])</span>
    <span class="n">ntypes</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">]</span>

    <span class="c1"># Find the atom1 - atom2 interaction (adjusting for indexing from 0)</span>
    <span class="n">term_idx</span> <span class="o">=</span> <span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">ntypes</span><span class="o">*</span><span class="p">(</span><span class="n">a1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">a2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Now change the ACOEF and BCOEF arrays, assuming pre-combined values</span>
    <span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ACOEF&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">][</span><span class="n">term_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">rmin</span><span class="o">**</span><span class="mi">12</span>
    <span class="n">parm</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_BCOEF&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">][</span><span class="n">term_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">rmin</span><span class="o">**</span><span class="mi">6</span>

<span class="c1">#+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015, Jason Swails

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>