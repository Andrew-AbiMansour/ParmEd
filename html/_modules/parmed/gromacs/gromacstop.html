

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>parmed.gromacs.gromacstop &mdash; ParmEd  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> ParmEd
          

          
          </a>

          
            
            
              <div class="version">
                0+untagged.3319.g7a6168d
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topologyobjects.html">Core classes used to represent topologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">The core Structure class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dimensional_analysis.html">Working with units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readwrite.html">Reading and writing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amber.html">The Amber file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../charmm.html">The CHARMM file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gromacs.html">The GROMACS file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rosetta.html">PyRosetta Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html">Using <code class="docutils literal notranslate"><span class="pre">parmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html#using-xparmed">Using <code class="docutils literal notranslate"><span class="pre">xparmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed_api.html">The ParmEd API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openmm.html">OpenMM Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualization.html">Visualization Functionality</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ParmEd</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>parmed.gromacs.gromacstop</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for parmed.gromacs.gromacstop</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains functionality relevant to loading a GROMACS topology file</span>
<span class="sd">and building a Structure from it</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">letters</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">ascii_letters</span> <span class="k">as</span> <span class="n">letters</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">parmed.constants</span> <span class="kn">import</span> <span class="n">TINY</span><span class="p">,</span> <span class="n">DEG_TO_RAD</span>
<span class="kn">from</span> <span class="nn">parmed.exceptions</span> <span class="kn">import</span> <span class="n">GromacsError</span><span class="p">,</span> <span class="n">GromacsWarning</span><span class="p">,</span> <span class="n">ParameterError</span>
<span class="kn">from</span> <span class="nn">parmed.formats.registry</span> <span class="kn">import</span> <span class="n">FileFormatType</span>
<span class="kn">from</span> <span class="nn">parmed.parameters</span> <span class="kn">import</span> <span class="n">ParameterSet</span><span class="p">,</span> <span class="n">_find_ureybrad_key</span>
<span class="kn">from</span> <span class="nn">parmed.gromacs._gromacsfile</span> <span class="kn">import</span> <span class="n">GromacsFile</span>
<span class="kn">from</span> <span class="nn">parmed.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">parmed.topologyobjects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Atom</span><span class="p">,</span> <span class="n">Bond</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">Dihedral</span><span class="p">,</span> <span class="n">Improper</span><span class="p">,</span>
            <span class="n">NonbondedException</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">,</span> <span class="n">BondType</span><span class="p">,</span> <span class="n">Cmap</span><span class="p">,</span> <span class="n">NoUreyBradley</span><span class="p">,</span>
            <span class="n">AngleType</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">,</span> <span class="n">ImproperType</span><span class="p">,</span> <span class="n">CmapType</span><span class="p">,</span>
            <span class="n">RBTorsionType</span><span class="p">,</span> <span class="n">ThreeParticleExtraPointFrame</span><span class="p">,</span> <span class="n">AtomType</span><span class="p">,</span> <span class="n">UreyBradley</span><span class="p">,</span>
            <span class="n">TwoParticleExtraPointFrame</span><span class="p">,</span> <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">,</span>
            <span class="n">NonbondedExceptionType</span><span class="p">,</span> <span class="n">UnassignedAtomType</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">parmed.periodic_table</span> <span class="kn">import</span> <span class="n">element_by_mass</span><span class="p">,</span> <span class="n">AtomicNum</span>
<span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">parmed.utils.io</span> <span class="kn">import</span> <span class="n">genopen</span>
<span class="kn">from</span> <span class="nn">parmed.utils.six</span> <span class="kn">import</span> <span class="n">add_metaclass</span><span class="p">,</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">iteritems</span>
<span class="kn">from</span> <span class="nn">parmed.utils.six.moves</span> <span class="kn">import</span> <span class="nb">range</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pwd</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_username</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">_username</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>
    <span class="n">_userid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>
    <span class="n">_uname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">getpass</span>
    <span class="n">_username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>   <span class="c1"># pragma: no cover</span>
    <span class="n">_userid</span> <span class="o">=</span> <span class="mi">0</span>                     <span class="c1"># pragma: no cover</span>
    <span class="kn">import</span> <span class="nn">platform</span>                 <span class="c1"># pragma: no cover</span>
    <span class="n">_uname</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>        <span class="c1"># pragma: no cover</span>



<span class="c1"># Gromacs uses &quot;funct&quot; flags in its parameter files to indicate what kind of</span>
<span class="c1"># functional form is used for each of its different parameter types. This is</span>
<span class="c1"># taken from the topdirs.c source code file along with a table in the Gromacs</span>
<span class="c1"># user manual. The table below summarizes my findings, for reference:</span>

<span class="c1"># Bonds</span>
<span class="c1"># -----</span>
<span class="c1">#  1 - F_BONDS : simple harmonic potential</span>
<span class="c1">#  2 - F_G96BONDS : fourth-power potential</span>
<span class="c1">#  3 - F_MORSE : morse potential</span>
<span class="c1">#  4 - F_CUBICBONDS : cubic potential</span>
<span class="c1">#  5 - F_CONNBONDS : not even implemented in GROMACS</span>
<span class="c1">#  6 - F_HARMONIC : seems to be the same as (1) ??</span>
<span class="c1">#  7 - F_FENEBONDS : finietely-extensible-nonlinear-elastic (FENE) potential</span>
<span class="c1">#  8 - F_TABBONDS : bond function from tabulated function</span>
<span class="c1">#  9 - F_TABBONDSNC : bond function from tabulated function (no exclusions)</span>
<span class="c1"># 10 - F_RESTRBONDS : restraint bonds</span>

<span class="c1"># Angles</span>
<span class="c1"># ------</span>
<span class="c1">#  1 - F_ANGLES : simple harmonic potential</span>
<span class="c1">#  2 - F_G96ANGLES : cosine-based angle potential</span>
<span class="c1">#  3 - F_CROSS_BOND_BONDS : bond-bond cross term potential</span>
<span class="c1">#  4 - F_CROSS_BOND_ANGLES : bond-angle cross term potential</span>
<span class="c1">#  5 - F_UREY_BRADLEY : Urey-Bradley angle-bond potential</span>
<span class="c1">#  6 - F_QUARTIC_ANGLES : 4th-order polynomial potential</span>
<span class="c1">#  7 - F_TABANGLES : angle function from tabulated function</span>
<span class="c1">#  8 - F_LINEAR_ANGLES : angle function from tabulated function</span>
<span class="c1">#  9 - F_RESTRANGLES : restricted bending potential</span>

<span class="c1"># Dihedrals</span>
<span class="c1"># ---------</span>
<span class="c1">#  1 - F_PDIHS : periodic proper torsion potential [ k(1+cos(n*phi-phase)) ]</span>
<span class="c1">#  2 - F_IDIHS : harmonic improper torsion potential</span>
<span class="c1">#  3 - F_RBDIHS : Ryckaert-Bellemans torsion potential</span>
<span class="c1">#  4 - F_PIDIHS : periodic harmonic improper torsion potential (same as 1)</span>
<span class="c1">#  5 - F_FOURDIHS : Fourier dihedral torsion potential</span>
<span class="c1">#  8 - F_TABDIHS : dihedral potential from tabulated function</span>
<span class="c1">#  9 - F_PDIHS : Same as 1, but can be multi-term</span>
<span class="c1"># 10 - F_RESTRDIHS : Restricted torsion potential</span>
<span class="c1"># 11 - F_CBTDIHS : combined bending-torsion potential</span>

<span class="n">_sectionre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[ (\w+) \]\s*$&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_Defaults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Global properties of force fields as implemented in GROMACS &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbfunc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">comb_rule</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">gen_pairs</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span>
                 <span class="n">fudgeLJ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fudgeQQ</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbfunc</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;nbfunc must be 1 (L-J) or 2 (Buckingham)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">comb_rule</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;comb_rule must be 1, 2, or 3&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gen_pairs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;gen_pairs must be &#39;yes&#39; or &#39;no&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">fudgeLJ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;fudgeLJ must be non-negative&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">fudgeQQ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;fudgeQQ must be non-negative&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbfunc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbfunc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comb_rule</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">comb_rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">=</span> <span class="n">gen_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fudgeLJ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fudgeLJ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fudgeQQ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fudgeQQ</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&lt;_Defaults: nbfunc=</span><span class="si">%d</span><span class="s1">, comb-rule=</span><span class="si">%d</span><span class="s1">, gen-pairs=&quot;</span><span class="si">%s</span><span class="s1">&quot;, &#39;</span>
                <span class="s1">&#39;fudgeLJ=</span><span class="si">%g</span><span class="s1">, fudgeQQ=</span><span class="si">%g</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbfunc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comb_rule</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gen_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># Treat it like the array that it is in the topology file</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfunc</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comb_rule</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_pairs</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fudgeLJ</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fudgeQQ</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> out of range&#39;</span> <span class="o">%</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbfunc</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nbfunc</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comb_rule</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">comb_rule</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fudgeLJ</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fudgeLJ</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fudgeQQ</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;nbfunc must be 1 or 2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nbfunc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;comb_rule must be 1, 2, or 3&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comb_rule</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;gen_pairs must be &quot;yes&quot; or &quot;no&quot;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;fudgeLJ must be non-negative&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fudgeLJ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;fudgeQQ must be non-negative&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fudgeQQ</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> out of range&#39;</span> <span class="o">%</span> <span class="n">idx</span><span class="p">)</span>

<div class="viewcode-block" id="GromacsTopologyFile"><a class="viewcode-back" href="../../../gromacsobj/parmed.gromacs.GromacsTopologyFile.html#parmed.gromacs.GromacsTopologyFile">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">FileFormatType</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GromacsTopologyFile</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class providing a parser and writer for a GROMACS topology file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        The name of the file to read</span>
<span class="sd">    defines : list of str=None</span>
<span class="sd">        If specified, this is the set of defines to use when parsing the</span>
<span class="sd">        topology file</span>
<span class="sd">    parametrized : bool, optional</span>
<span class="sd">        If True, parameters are assigned after parsing is done from the</span>
<span class="sd">        parametertypes sections. If False, only parameter types defined in the</span>
<span class="sd">        parameter sections themselves are loaded (i.e., on the same line as the</span>
<span class="sd">        parameter was defined). Default is True</span>
<span class="sd">    xyz : str or array, optional</span>
<span class="sd">        The source of atomic coordinates. It can be a string containing the name</span>
<span class="sd">        of a coordinate file from which to fill the coordinates (and optionally</span>
<span class="sd">        the unit cell information), or it can be an array with the coordinates.</span>
<span class="sd">        Default is None</span>
<span class="sd">    box : array, optional</span>
<span class="sd">        If provided, the unit cell information will be set from this variable.</span>
<span class="sd">        If provided, it must be a collection of 6 floats representing the unit</span>
<span class="sd">        cell dimensions a, b, c, alpha, beta, and gamma, respectively. Default</span>
<span class="sd">        is None.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If the ``xyz`` argument is a file name that contains the unit cell</span>
<span class="sd">    information, this unit cell information is set. However, the ``box``</span>
<span class="sd">    argument takes precedence and will override values given in the coordinate</span>
<span class="sd">    file unless it has its default value of ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.id_format"><a class="viewcode-back" href="../../../api/parmed/parmed.gromacs.gromacstop.html#parmed.gromacs.GromacsTopologyFile.id_format">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">id_format</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Identifies the file as a GROMACS topology file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file to check if it is a gromacs topology file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_fmt : bool</span>
<span class="sd">            If it is identified as a gromacs topology, return True. False</span>
<span class="sd">            otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">genopen</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#if&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#define&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#include&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#undef&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#endif&#39;</span><span class="p">):</span> <span class="k">continue</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="n">rematch</span> <span class="o">=</span> <span class="n">_sectionre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rematch</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="n">sec</span><span class="p">,</span> <span class="o">=</span> <span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">sec</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;atoms&#39;</span><span class="p">,</span> <span class="s1">&#39;atomtypes&#39;</span><span class="p">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">,</span> <span class="s1">&#39;moleculetype&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;bondtypes&#39;</span><span class="p">,</span> <span class="s1">&#39;angletypes&#39;</span><span class="p">,</span> <span class="s1">&#39;cmaptypes&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;dihedraltypes&#39;</span><span class="p">,</span> <span class="s1">&#39;bonds&#39;</span><span class="p">,</span> <span class="s1">&#39;angles&#39;</span><span class="p">,</span> <span class="s1">&#39;dihedrals&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;cmaps&#39;</span><span class="p">,</span> <span class="s1">&#39;molecules&#39;</span><span class="p">,</span> <span class="s1">&#39;exclusions&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;nonbond_params&#39;</span><span class="p">,</span> <span class="s1">&#39;position_restraints&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.__init__"><a class="viewcode-back" href="../../../gromacsobj/parmed.gromacs.GromacsTopologyFile.html#parmed.gromacs.GromacsTopologyFile.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parametrize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">load_file</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GromacsTopologyFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">_Defaults</span><span class="p">(</span><span class="n">gen_pairs</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span> <span class="c1"># make ParmEd&#39;s default yes</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">defines</span><span class="p">,</span> <span class="n">parametrize</span><span class="p">)</span>
            <span class="c1"># Fill in coordinates and unit cell information if appropriate</span>
            <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">skip_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> does not have coordinates&#39;</span> <span class="o">%</span>
                                        <span class="n">xyz</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">coordinates</span>
                    <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">box</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">box</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot provide coordinates/box and NOT a top&#39;</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.read"><a class="viewcode-back" href="../../../api/parmed/parmed.gromacs.gromacstop.html#parmed.gromacs.GromacsTopologyFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">defines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parametrize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reads the topology file into the current instance &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">gromacs</span> <span class="k">as</span> <span class="n">gmx</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span> <span class="o">=</span> <span class="n">ParameterSet</span><span class="p">()</span>
        <span class="n">molecules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecules</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bond_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">angle_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">ub_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">dihedral_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">exc_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">structure_contents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">molnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">defines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">defines</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">FLEXIBLE</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">proper_multiterm_dihedrals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">GromacsFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">includes</span><span class="o">=</span><span class="p">[</span><span class="n">gmx</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span><span class="p">],</span> <span class="n">defines</span><span class="o">=</span><span class="n">defines</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>

                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
                    <span class="n">current_section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;moleculetype&#39;</span><span class="p">:</span>
                    <span class="n">molname</span><span class="p">,</span> <span class="n">nrexcl</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">nrexcl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nrexcl</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">molname</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Duplicate definition of molecule </span><span class="si">%s</span><span class="s1">&#39;</span>
                                           <span class="o">%</span> <span class="n">molname</span><span class="p">)</span>
                    <span class="n">molecule</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
                    <span class="n">molecules</span><span class="p">[</span><span class="n">molname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">nrexcl</span><span class="p">)</span>
                    <span class="n">molnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">molname</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">nrexcl</span> <span class="o">=</span> <span class="n">nrexcl</span>
                    <span class="n">bond_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">angle_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">ub_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">dihedral_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">exc_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;atoms&#39;</span><span class="p">:</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_atoms</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;bonds&#39;</span><span class="p">:</span>
                    <span class="n">bond</span><span class="p">,</span> <span class="n">bond_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_bonds</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">bond_types</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">bond_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">molecule</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond_type</span><span class="p">)</span>
                        <span class="n">bond_type</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">bond_types</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;pairs&#39;</span><span class="p">:</span>
                    <span class="n">nbe</span><span class="p">,</span> <span class="n">nbet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_pairs</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">exc_types</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbe</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nbet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">molecule</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nbet</span><span class="p">)</span>
                        <span class="n">nbet</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">adjust_types</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;angles&#39;</span><span class="p">:</span>
                    <span class="n">ang</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">angt</span><span class="p">,</span> <span class="n">ubt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_angles</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">angle_types</span><span class="p">,</span> <span class="n">ub_types</span><span class="p">,</span>
                                                            <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">molecule</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">angt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">molecule</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angt</span><span class="p">)</span>
                        <span class="n">angt</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">angle_types</span>
                    <span class="k">if</span> <span class="n">ubt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ubt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NoUreyBradley</span><span class="p">:</span>
                        <span class="n">molecule</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ubt</span><span class="p">)</span>
                        <span class="n">ubt</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">urey_bradley_types</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;dihedrals&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_parse_dihedrals</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">dihedral_types</span><span class="p">,</span> <span class="n">proper_multiterm_dihedrals</span><span class="p">,</span>
                                          <span class="n">molecule</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;cmap&#39;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cmaps</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;defaults&#39;</span><span class="p">:</span>
                    <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># 3, 4, and 5 fields are optional</span>
                        <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Too few fields in [ defaults ]&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unsupported nonbonded type; unknown functional&#39;</span><span class="p">,</span>
                                      <span class="n">GromacsWarning</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">=</span> <span class="s1">&#39;geometric&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">_Defaults</span><span class="p">(</span><span class="o">*</span><span class="n">words</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;molecules&#39;</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                    <span class="n">structure_contents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;settles&#39;</span><span class="p">:</span>
                    <span class="n">bnds</span><span class="p">,</span> <span class="n">bndts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_settles</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bnds</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bndts</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;virtual_sites3&#39;</span><span class="p">,</span> <span class="s1">&#39;dummies3&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b</span><span class="p">,</span> <span class="n">bt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_vsites3</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Cannot determine vsite geometry &#39;</span>
                                           <span class="s1">&#39;without parameter types&#39;</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">molecule</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>
                    <span class="n">bt</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">bond_types</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;exclusions&#39;</span><span class="p">:</span>
                    <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;atomtypes&#39;</span><span class="p">:</span>
                    <span class="n">attype</span><span class="p">,</span> <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_atomtypes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">attype</span><span class="p">]</span> <span class="o">=</span> <span class="n">typ</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;nonbond_params&#39;</span><span class="p">:</span>
                    <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="c1">#                   func = int(words[2]) #... unused</span>
                    <span class="n">sig</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">sig</span> <span class="o">*=</span> <span class="mi">10</span> <span class="c1"># Convert to Angstroms</span>
                    <span class="n">eps</span> <span class="o">*=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoule</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">sig</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">[(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">sig</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">add_nbfix</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">sig</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">eps</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">add_nbfix</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">sig</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">eps</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;bondtypes&#39;</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_bondtypes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;angletypes&#39;</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_angletypes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">if</span> <span class="n">ut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ut</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ut</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;dihedraltypes&#39;</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">knd</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_dihedraltypes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">rkey</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">knd</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">replace</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">DihedralTypeList</span><span class="p">([</span><span class="n">t</span><span class="p">])</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">rkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">knd</span> <span class="o">==</span> <span class="s1">&#39;improper&#39;</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">elif</span> <span class="n">knd</span> <span class="o">==</span> <span class="s1">&#39;improper_periodic&#39;</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">[</span><span class="n">rkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">elif</span> <span class="n">knd</span> <span class="o">==</span> <span class="s1">&#39;rbtorsion&#39;</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">rkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;cmaptypes&#39;</span><span class="p">:</span>
                    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cmaptypes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[(</span><span class="n">a5</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s1">&#39;pairtypes&#39;</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_pairtypes</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">[(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">itplist</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">included_files</span>

        <span class="c1"># If the file did not contain the molecules section, perhaps</span>
        <span class="c1"># because it was an itp-file. We assume that each molecule loaded</span>
        <span class="c1"># should be contained once in this structure</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">structure_contents</span> <span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">molnames</span> <span class="p">:</span>
                <span class="n">structure_contents</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Combine first, then parametrize. That way, we don&#39;t have to create</span>
        <span class="c1"># copies of the ParameterType instances in self.parameterset</span>
        <span class="k">for</span> <span class="n">molname</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">structure_contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">molname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Structure contains </span><span class="si">%s</span><span class="s1"> molecules, but no &#39;</span>
                                   <span class="s1">&#39;template defined&#39;</span> <span class="o">%</span> <span class="n">molname</span><span class="p">)</span>
            <span class="n">molecule</span><span class="p">,</span> <span class="n">nrexcl</span> <span class="o">=</span> <span class="n">molecules</span><span class="p">[</span><span class="n">molname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nrexcl</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">_any_atoms_farther_than</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">nrexcl</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;nrexcl </span><span class="si">%d</span><span class="s1"> not currently supported&#39;</span> <span class="o">%</span> <span class="n">nrexcl</span><span class="p">,</span>
                              <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">nrexcl</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">_any_atoms_farther_than</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;nrexcl </span><span class="si">%d</span><span class="s1"> not currently supported&#39;</span> <span class="o">%</span> <span class="n">nrexcl</span><span class="p">,</span>
                              <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Detected addition of 0 </span><span class="si">%s</span><span class="s1"> molecules in topology &#39;</span>
                              <span class="s1">&#39;file&#39;</span> <span class="o">%</span> <span class="n">molname</span><span class="p">,</span> <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">+=</span> <span class="n">molecules</span><span class="p">[</span><span class="n">molname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">+=</span> <span class="n">molecules</span><span class="p">[</span><span class="n">molname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">num</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> molecules&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">molname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itps</span> <span class="o">=</span> <span class="n">itplist</span>
        <span class="k">if</span> <span class="n">parametrize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parametrize</span><span class="p">()</span></div>

    <span class="c1">#===================================================</span>

    <span class="c1"># Private parsing helper functions</span>

    <span class="k">def</span> <span class="nf">_parse_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses an atom line. Returns an Atom, resname, resnum &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attype</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">attype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="n">attype</span><span class="o">.</span><span class="n">mass</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">attype</span><span class="o">.</span><span class="n">atomic_number</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">attype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">attype</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">attype</span><span class="o">.</span><span class="n">atomic_number</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">element_by_mass</span><span class="p">(</span><span class="n">mass</span><span class="p">)]</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">ExtraPoint</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">atomic_number</span><span class="o">=</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atom</span><span class="p">,</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_parse_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">bond_types</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses a bond line. Returns a Bond, BondType/None &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">funct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;bond funct != 1; unknown functional&#39;</span><span class="p">,</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bond</span> <span class="o">=</span> <span class="n">Bond</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">bond</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">funct</span>
        <span class="n">bond_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bond_types</span><span class="p">:</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">bond_types</span><span class="p">[(</span><span class="n">req</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bond_type</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span>
                        <span class="n">k</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">req</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span>
                <span class="p">)</span>
                <span class="n">bond_types</span><span class="p">[(</span><span class="n">req</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">bond_type</span>
        <span class="k">return</span> <span class="n">bond</span><span class="p">,</span> <span class="n">bond_type</span>

    <span class="k">def</span> <span class="nf">_parse_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">exc_types</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses a pairs line. Returns NonbondedException, NEType/None &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">funct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># This is not even supported in Gromacs</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;pairs funct != 1; unknown functional&#39;</span><span class="p">,</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nbe</span> <span class="o">=</span> <span class="n">NonbondedException</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">nbe</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">funct</span>
        <span class="n">nbet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span> <span class="ow">in</span> <span class="n">exc_types</span><span class="p">:</span>
                <span class="n">nbe</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">exc_types</span><span class="p">[(</span><span class="n">sig</span><span class="p">,</span> <span class="n">eps</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nbet</span> <span class="o">=</span> <span class="n">NonbondedExceptionType</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">,</span> <span class="n">eps</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">)</span>
                <span class="n">exc_types</span><span class="p">[(</span><span class="n">sig</span><span class="p">,</span> <span class="n">eps</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nbe</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">nbet</span>
        <span class="k">return</span> <span class="n">nbe</span><span class="p">,</span> <span class="n">nbet</span>

    <span class="k">def</span> <span class="nf">_parse_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">angle_types</span><span class="p">,</span> <span class="n">ub_types</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse an angles line, Returns Angle, UB/None, and types &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">funct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;angles funct != 1 or 5; unknown &#39;</span>
                          <span class="s1">&#39;functional&#39;</span><span class="p">,</span> <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">angt</span> <span class="o">=</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">ubt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">ang</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">funct</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">UreyBradley</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">funct</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">funct</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">theteq</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">theteq</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">angle_types</span><span class="p">:</span>
                <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">angle_types</span><span class="p">[(</span><span class="n">theteq</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">angt</span> <span class="o">=</span> <span class="n">AngleType</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">theteq</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
                <span class="n">angle_types</span><span class="p">[(</span><span class="n">theteq</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">angt</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">ubreq</span><span class="p">,</span> <span class="n">ubk</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ubk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ubreq</span><span class="p">,</span> <span class="n">ubk</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ub_types</span><span class="p">:</span>
                    <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ub_types</span><span class="p">[(</span><span class="n">ubreq</span><span class="p">,</span> <span class="n">ubk</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ubt</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span>
                        <span class="n">ubk</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">ubreq</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">ub_types</span><span class="p">[(</span><span class="n">ubreq</span><span class="p">,</span> <span class="n">ubk</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ubt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">NoUreyBradley</span>
        <span class="k">return</span> <span class="n">ang</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">angt</span><span class="p">,</span> <span class="n">ubt</span>

    <span class="k">def</span> <span class="nf">_parse_dihedrals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">dihedral_types</span><span class="p">,</span> <span class="n">PMD</span><span class="p">,</span> <span class="n">molecule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Processes a dihedrals line, returns None &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
        <span class="n">funct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">funct</span> <span class="o">==</span> <span class="mi">9</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">dih</span><span class="p">,</span> <span class="n">diht</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_normal_dihedral</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                                      <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">dihedral_types</span><span class="p">,</span>
                                                      <span class="n">funct</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dih</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diht</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diht</span><span class="p">)</span>
                <span class="n">diht</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">dihedral_types</span>
        <span class="k">elif</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dih</span><span class="p">,</span> <span class="n">impt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_improper</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
                                               <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">dihedral_types</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dih</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">impt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">impt</span><span class="p">)</span>
                <span class="n">impt</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">improper_types</span>
        <span class="k">elif</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dih</span><span class="p">,</span> <span class="n">rbt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_rbtorsion</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                                              <span class="n">dihedral_types</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">rb_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dih</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rbt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbt</span><span class="p">)</span>
                <span class="n">rbt</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">rb_torsion_types</span>
        <span class="k">elif</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="c1"># in-line parameters, since len(words) must be &gt;= 8</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                   <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">PMD</span><span class="p">:</span>
                <span class="n">diht</span> <span class="o">=</span> <span class="n">PMD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_dihedral_series</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">diht</span><span class="p">)</span>
                <span class="n">dih</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dih</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
                <span class="n">diht</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_dihedral_series</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
                <span class="n">dih</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PMD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PMD</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">))]</span> <span class="o">=</span> <span class="n">diht</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dih</span><span class="p">)</span>
                <span class="n">molecule</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diht</span><span class="p">)</span>
                <span class="n">diht</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">dihedral_types</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ??? unknown funct</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;torsions funct != 1, 2, 3, 4, 9; unknown&#39;</span>
                          <span class="s1">&#39; functional&#39;</span><span class="p">,</span> <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="n">dih</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                           <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dih</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">dih</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dih</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">funct</span>

    <span class="k">def</span> <span class="nf">_parse_cmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses cmap terms, returns cmap &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">funct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;cmap funct != 1; unknown functional&#39;</span><span class="p">,</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">Cmap</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">funct</span>
        <span class="k">return</span> <span class="n">cmap</span>

    <span class="k">def</span> <span class="nf">_parse_settles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses settles line; returns list of Bonds, list of BondTypes &quot;&quot;&quot;</span>
        <span class="c1"># Instead of adding bonds that get constrained for waters (or other</span>
        <span class="c1"># 3-atom molecules), GROMACS uses a &quot;settles&quot; section to specify the</span>
        <span class="c1"># constraint geometry. We have to translate that into bonds.</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">natoms</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s2">&quot;Cannot SETTLE a </span><span class="si">%d</span><span class="s2">-atom molecule&quot;</span> <span class="o">%</span> <span class="n">natoms</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oxy</span><span class="p">,</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">8</span><span class="p">]</span>
            <span class="n">hyd1</span><span class="p">,</span> <span class="n">hyd2</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Can only SETTLE water; wrong atoms&#39;</span><span class="p">)</span>
        <span class="c1">#TODO see if there&#39;s a bond_type entry in the parameter set</span>
        <span class="c1">#     that we can fill in? Wait until this is needed...</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">funct</span><span class="p">,</span> <span class="n">doh</span><span class="p">,</span> <span class="n">dhh</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">doh</span><span class="p">,</span> <span class="n">dhh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">doh</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dhh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Bad [ settles ] line&#39;</span><span class="p">)</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span>
        <span class="n">bt_oh</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span><span class="mf">5e5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span><span class="o">/</span><span class="n">nm</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">doh</span><span class="o">*</span><span class="n">nm</span><span class="p">)</span>
        <span class="n">bt_hh</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span><span class="mf">5e5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span><span class="o">/</span><span class="n">nm</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dhh</span><span class="o">*</span><span class="n">nm</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Bond</span><span class="p">(</span><span class="n">oxy</span><span class="p">,</span> <span class="n">hyd1</span><span class="p">,</span> <span class="n">bt_oh</span><span class="p">),</span> <span class="n">Bond</span><span class="p">(</span><span class="n">oxy</span><span class="p">,</span> <span class="n">hyd2</span><span class="p">,</span> <span class="n">bt_oh</span><span class="p">),</span>
                <span class="n">Bond</span><span class="p">(</span><span class="n">hyd1</span><span class="p">,</span> <span class="n">hyd2</span><span class="p">,</span> <span class="n">bt_hh</span><span class="p">)],</span> <span class="p">[</span><span class="n">bt_oh</span><span class="p">,</span> <span class="n">bt_hh</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_parse_vsites3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">all_atoms</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse vsites3/dummy3 line; returns Bond, BondType &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">vsite</span> <span class="o">=</span> <span class="n">all_atoms</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_atoms</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]]</span>
        <span class="n">funct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">funct</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TINY</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s2">&quot;No vsite frames with different weights&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Only 3-point vsite type 1 is supported&#39;</span><span class="p">)</span>
        <span class="c1"># We need to know the geometry of the frame in order to</span>
        <span class="c1"># determine the bond length between the virtual site and its</span>
        <span class="c1"># parent atom</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vsite</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Unexpected bond b/w vsite and its parent&#39;</span><span class="p">)</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">kws</span><span class="p">[</span><span class="s1">&#39;dp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">req</span>
            <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
                <span class="n">kws</span><span class="p">[</span><span class="s1">&#39;dp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">req</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angle</span> <span class="ow">or</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angle</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                   <span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="p">))</span>
            <span class="n">kws</span><span class="p">[</span><span class="s1">&#39;theteq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">theteq</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Did not break, no theta found</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
                    <span class="n">kws</span><span class="p">[</span><span class="s1">&#39;d12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">req</span>
        <span class="n">bondlen</span> <span class="o">=</span> <span class="n">ThreeParticleExtraPointFrame</span><span class="o">.</span><span class="n">from_weights</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="n">bt_vs</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bondlen</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Bond</span><span class="p">(</span><span class="n">vsite</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">bt_vs</span><span class="p">),</span> <span class="n">bt_vs</span>

    <span class="k">def</span> <span class="nf">_parse_atomtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses line from atomtypes section, returns str, AtomType &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="c1"># Support the following spec, found in the Gromacs source code:</span>
        <span class="c1"># Field 0 (mandatory) : nonbonded type name (string)</span>
        <span class="c1"># Field 1 (optional)  : bonded type (string)</span>
        <span class="c1"># Field 2 (optional)  : atomic number (int)</span>
        <span class="c1"># Field 3 (mandatory) : mass (float)</span>
        <span class="c1"># Field 4 (mandatory) : charge (float)</span>
        <span class="c1"># Field 5 (mandatory) : particle type (single character)</span>
        <span class="n">attype</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
            <span class="c1"># Field 1 and Field 2 are both missing</span>
            <span class="n">atnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">sigidx</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#           ptypeidx = 3 # ... unused</span>
            <span class="n">massidx</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">bond_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
            <span class="c1"># Both Field 1 and Field 2 are present</span>
            <span class="n">sigidx</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1">#           ptypeidx = 5 # ... unused</span>
            <span class="n">massidx</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">bond_type</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># One of Field 1 or 2 are missing</span>
<span class="c1">#           ptypeidx = 4 # ... unused</span>
            <span class="n">massidx</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">sigidx</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bond_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># This must be a bonded type string</span>
                <span class="n">bond_type</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">atnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">massidx</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">mass</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">atnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">atnum</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">element_by_mass</span><span class="p">(</span><span class="n">mass</span><span class="p">)]</span>
        <span class="n">chg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">massidx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#       ptype = words[ptypeidx] # ... unused</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">sigidx</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">sigidx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">AtomType</span><span class="p">(</span><span class="n">attype</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">atnum</span><span class="p">,</span> <span class="n">bond_type</span><span class="o">=</span><span class="n">bond_type</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">chg</span><span class="p">)</span>
        <span class="n">typ</span><span class="o">.</span><span class="n">set_lj_params</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">sig</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attype</span><span class="p">,</span> <span class="n">typ</span>

    <span class="k">def</span> <span class="nf">_parse_bondtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse bondtypes line. Returns str, str, BondType &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;bondtypes funct != 1; unknown functional&#39;</span><span class="p">,</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">BondType</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_angletypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses angletypes line. Returns str, str, str, AngleType, BondType/None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degrees</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">radians</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;angletypes funct != 1 or 5; unknown functional&#39;</span><span class="p">,</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
            <span class="c1"># Contains the angle with urey-bradley</span>
            <span class="n">ub0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">cub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">cub</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="n">NoUreyBradley</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ub0</span> <span class="o">*=</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span>
                <span class="n">cub</span> <span class="o">*=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span><span class="n">cub</span><span class="p">,</span> <span class="n">ub0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">AngleType</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">theta</span><span class="p">),</span> <span class="n">ub</span>

    <span class="k">def</span> <span class="nf">_parse_dihedraltypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parse dihedraltypes, returns (str,str,str,str), str, Type, bool &quot;&quot;&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
        <span class="c1"># Ugh. Gromacs allows only two atom types (the middle atom types) to be</span>
        <span class="c1"># specified. This signifies wild-cards</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;11&#39;</span><span class="p">):</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">a4</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
            <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">si</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">si</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">improper_periodic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">)</span>
        <span class="n">improper_periodic</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;4&#39;</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;improper&#39;</span>
        <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;rbtorsion&#39;</span>
        <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;dihedraltypes funct not supported&#39;</span><span class="p">,</span> <span class="n">GromacsWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Do the proper types</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degrees</span>
            <span class="n">phi_k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span>
            <span class="n">per</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span>
                                 <span class="n">scee</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span>
                                 <span class="n">scnb</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">improper_periodic</span><span class="p">:</span>
                <span class="c1"># must do this here, since dtype has to be &#39;normal&#39; above</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;improper_periodic&#39;</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;improper&#39;</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radians</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">])</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">ImproperType</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;rbtorsion&#39;</span><span class="p">:</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span>
                                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">si</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">RBTorsionType</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span><span class="p">,</span>
                                  <span class="n">scee</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span>
                                  <span class="n">scnb</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">),</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">replace</span>

    <span class="k">def</span> <span class="nf">_parse_cmaptypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
<span class="c1">#       funct = int(words[5]) # ... unused</span>
        <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">8</span><span class="p">:]]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">res1</span> <span class="o">*</span> <span class="n">res2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;CMAP grid dimensions do not match resolution&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res1</span> <span class="o">!=</span> <span class="n">res2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Only square CMAPs are supported&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">CmapType</span><span class="p">(</span><span class="n">res1</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_pairtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">words</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="c1">#       funct = int(words[2]) # ... unused</span>
        <span class="n">cs6</span><span class="p">,</span> <span class="n">cs12</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">cs6</span> <span class="o">*=</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">cs12</span> <span class="o">*=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span>
        <span class="k">return</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">NonbondedExceptionType</span><span class="p">(</span><span class="n">cs6</span><span class="p">,</span> <span class="n">cs12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="c1"># Internal Dihedral processing routines for different kinds of dihedrals</span>

    <span class="k">def</span> <span class="nf">_process_normal_dihedral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
                                 <span class="n">dihedral_types</span><span class="p">,</span> <span class="n">imp</span><span class="p">):</span>
        <span class="n">dih</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">improper</span><span class="o">=</span><span class="n">imp</span><span class="p">)</span>
        <span class="n">diht</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">phase</span><span class="p">,</span> <span class="n">phi_k</span><span class="p">,</span> <span class="n">per</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phi_k</span><span class="p">,</span> <span class="n">per</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dihedral_types</span><span class="p">:</span>
                <span class="n">dih</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">dihedral_types</span><span class="p">[(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phi_k</span><span class="p">,</span> <span class="n">per</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diht</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="n">phi_k</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="p">,</span>
                                    <span class="n">per</span><span class="p">,</span> <span class="n">phase</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
                                    <span class="n">scee</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span>
                                    <span class="n">scnb</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">)</span>
                <span class="n">dihedral_types</span><span class="p">[(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phi_k</span><span class="p">,</span> <span class="n">per</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">diht</span>
        <span class="k">return</span> <span class="n">dih</span><span class="p">,</span> <span class="n">diht</span>

    <span class="k">def</span> <span class="nf">_process_dihedral_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">dihtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">phase</span><span class="p">,</span> <span class="n">phi_k</span><span class="p">,</span> <span class="n">per</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="n">phi_k</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="p">,</span>
                          <span class="n">per</span><span class="p">,</span> <span class="n">phase</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
                          <span class="n">scee</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span>
                          <span class="n">scnb</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dihtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dihtype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">dtl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="n">phi_k</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="p">,</span>
                              <span class="n">per</span><span class="p">,</span> <span class="n">phase</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">,</span>
                              <span class="n">scee</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span>
                              <span class="n">scnb</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">)</span>
            <span class="n">dtl</span> <span class="o">=</span> <span class="n">DihedralTypeList</span><span class="p">()</span>
            <span class="n">dtl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dtl</span>

    <span class="k">def</span> <span class="nf">_process_improper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">dihedral_types</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Processes an improper, returns Improper, ImproperType &quot;&quot;&quot;</span>
        <span class="c1"># Improper</span>
        <span class="n">imp</span> <span class="o">=</span> <span class="n">Improper</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="n">impt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">psieq</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">psieq</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dihedral_types</span><span class="p">:</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">dihedral_types</span><span class="p">[(</span><span class="n">psieq</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">impt</span> <span class="o">=</span> <span class="n">ImproperType</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                    <span class="n">psieq</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">dihedral_types</span><span class="p">[(</span><span class="n">psieq</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">impt</span>
        <span class="k">return</span> <span class="n">imp</span><span class="p">,</span> <span class="n">impt</span>

    <span class="k">def</span> <span class="nf">_process_rbtorsion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">dihedral_types</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
        <span class="n">rbt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dihedral_types</span><span class="p">:</span>
                <span class="n">rb</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">dihedral_types</span><span class="p">[(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kjpm</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span>
                <span class="n">rbt</span> <span class="o">=</span> <span class="n">RBTorsionType</span><span class="p">(</span><span class="n">c0</span><span class="o">*</span><span class="n">kjpm</span><span class="p">,</span> <span class="n">c1</span><span class="o">*</span><span class="n">kjpm</span><span class="p">,</span> <span class="n">c2</span><span class="o">*</span><span class="n">kjpm</span><span class="p">,</span>
                                    <span class="n">c3</span><span class="o">*</span><span class="n">kjpm</span><span class="p">,</span> <span class="n">c4</span><span class="o">*</span><span class="n">kjpm</span><span class="p">,</span> <span class="n">c5</span><span class="o">*</span><span class="n">kjpm</span><span class="p">,</span>
                                    <span class="n">scee</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span>
                                    <span class="n">scnb</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">)</span>
                <span class="n">dihedral_types</span><span class="p">[(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">c5</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rb</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">rbt</span>
        <span class="k">return</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rbt</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.parametrize"><a class="viewcode-back" href="../../../api/parmed/parmed.gromacs.gromacstop.html#parmed.gromacs.GromacsTopologyFile.parametrize">[docs]</a>    <span class="k">def</span> <span class="nf">parametrize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign parameters to the current structure. This should be called</span>
<span class="sd">        *after* `read`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;parametrize called before read&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">update_typelist_from</span><span class="p">(</span><span class="n">ptypes</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
            <span class="n">added_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">ptypes</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">typ</span><span class="o">.</span><span class="n">used</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">added_types</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">added_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
                <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="c1"># Assign all of the parameters. If they&#39;ve already been assigned (i.e.,</span>
        <span class="c1"># on the parameter line itself) keep the existing parameters</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="c1"># The list of ordered 2-tuples of atoms explicitly specified in [ pairs ].</span>
        <span class="c1"># Under most circumstances, this is the list of 1-4 pairs.</span>
        <span class="n">gmx_pair</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom1</span> <span class="o">&gt;</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="p">:</span>
                <span class="n">gmx_pair</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gmx_pair</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">:</span>
                <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;geometric&#39;</span><span class="p">,</span> <span class="s1">&#39;lorentz&#39;</span><span class="p">),</span> \
                        <span class="s1">&#39;Unrecognized combining rule&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;lorentz&#39;</span><span class="p">:</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">sigma</span> <span class="o">+</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
                <span class="n">eps</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span>
                <span class="n">pairtype</span> <span class="o">=</span> <span class="n">NonbondedExceptionType</span><span class="p">(</span><span class="n">sig</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">eps</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pairtype</span><span class="p">)</span>
                <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">pairtype</span>
                <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all pair parameters can be found&#39;</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">)</span>
        <span class="c1"># This is the list of 1-4 pairs determined from the bond graph.</span>
        <span class="c1"># If this is different from what&#39;s in [ pairs ], we print a warning</span>
        <span class="c1"># and make some adjustments (specifically, other programs assume</span>
        <span class="c1"># the 1-4 list is complete, so we zero out the parameters for</span>
        <span class="c1"># 1-4 pairs that aren&#39;t in [ pairs ].</span>
        <span class="n">true_14</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bpi</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bpj</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">bpi</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">bpj</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">bpi</span> <span class="ow">in</span> <span class="n">bpj</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">or</span> <span class="n">bpi</span> <span class="ow">in</span> <span class="n">bpj</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">bpi</span> <span class="o">&gt;</span> <span class="n">bpj</span><span class="p">:</span>
                        <span class="n">true_14</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">bpj</span><span class="p">,</span> <span class="n">bpi</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">true_14</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">bpi</span><span class="p">,</span> <span class="n">bpj</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">:</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all bond parameters found&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_14</span> <span class="o">-</span> <span class="n">gmx_pair</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_pairtype</span> <span class="o">=</span> <span class="n">NonbondedExceptionType</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                                   <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_pairtype</span><span class="p">)</span>
            <span class="n">num_zero_14</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="p">(</span><span class="n">true_14</span> <span class="o">-</span> <span class="n">gmx_pair</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NonbondedException</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">zero_pairtype</span><span class="p">))</span>
                <span class="n">num_zero_14</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1"> 1-4 pairs were missing from the [ pairs ] &#39;</span>
                          <span class="s1">&#39;section and were set to zero; make sure you &#39;</span>
                          <span class="s1">&#39;know what you</span><span class="se">\&#39;</span><span class="s1">re doing!&#39;</span> <span class="o">%</span> <span class="n">num_zero_14</span><span class="p">,</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmx_pair</span> <span class="o">-</span> <span class="n">true_14</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The [ pairs ] section contains </span><span class="si">%i</span><span class="s1"> exceptions that &#39;</span>
                          <span class="s1">&#39;aren</span><span class="se">\&#39;</span><span class="s1">t 1-4 pairs; make sure you know what &#39;</span>
                          <span class="s1">&#39;you</span><span class="se">\&#39;</span><span class="s1">re doing!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gmx_pair</span> <span class="o">-</span> <span class="n">true_14</span><span class="p">)),</span>
                          <span class="n">GromacsWarning</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                   <span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">:</span>
                <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all angle parameters found&#39;</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">_find_ureybrad_key</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">:</span>
                <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NoUreyBradley</span><span class="p">:</span>
                    <span class="n">ub</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all urey-bradley parameters found&#39;</span><span class="p">)</span>
        <span class="c1"># Now strip out all of the Urey-Bradley terms whose parameters are 0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">))):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">NoUreyBradley</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span>
                   <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
                <span class="n">wckey</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">wckey1</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                          <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
                <span class="n">wckey2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span>
                          <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">wckey1</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">wckey1</span><span class="p">]</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">wckey2</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">wckey2</span><span class="p">]</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">wckey</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">wckey</span><span class="p">]</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all torsion parameters found&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">wckey</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;X&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                                  <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">])]:</span>
                        <span class="k">if</span> <span class="n">wckey</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">:</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">[</span><span class="n">wckey</span><span class="p">]</span>
                            <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all improper torsion &#39;</span>
                                             <span class="s1">&#39;parameters found&#39;</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span>
                   <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="p">))</span>
            <span class="n">wckey</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="n">wckey1</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                      <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="n">wckey2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span>
                      <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">wckey1</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">wckey1</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">wckey2</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">wckey2</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">wckey</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">wckey</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all R-B torsion parameters found&#39;</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_dihedral_exclusions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                                <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="p">)]))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="c1"># Now we will try to find a compatible wild-card... the first atom</span>
            <span class="c1"># is the central atom. So take each of the other three and plug that</span>
            <span class="c1"># one in</span>
            <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span>
                           <span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="p">)):</span>
                <span class="n">wckey</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">_gettype</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">anchor</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">wckey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">[</span><span class="n">wckey</span><span class="p">]</span>
                <span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all improper parameters found&#39;</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span>
                    <span class="n">_gettype</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atom4</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atom5</span><span class="p">))</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Not all cmap parameters found&#39;</span><span class="p">)</span>
        <span class="n">update_typelist_from</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.copy"><a class="viewcode-back" href="../../../api/parmed/parmed.gromacs.gromacstop.html#parmed.gromacs.GromacsTopologyFile.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">split_dihedrals</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a copy of the current structure as an instance of a specified</span>
<span class="sd">        subclass</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls : Structure subclass</span>
<span class="sd">            The returned object is a copy of this structure as a `cls` instance</span>
<span class="sd">        split_dihedrals : ``bool``</span>
<span class="sd">            If True, then the Dihedral entries will be split up so that each one</span>
<span class="sd">            is paired with a single DihedralType (rather than a</span>
<span class="sd">            DihedralTypeList)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        *cls* instance</span>
<span class="sd">            The instance of the Structure subclass `cls` with a copy of the</span>
<span class="sd">            current Structure&#39;s topology information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GromacsTopologyFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">split_dihedrals</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; See Structure.__getitem__ for documentation &quot;&quot;&quot;</span>
        <span class="c1"># Make sure defaults is properly copied</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GromacsTopologyFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">struct</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.from_structure"><a class="viewcode-back" href="../../../api/parmed/parmed.gromacs.gromacstop.html#parmed.gromacs.GromacsTopologyFile.from_structure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_structure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instantiates a GromacsTopologyFile instance from a Structure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        struct : :class:`parmed.Structure`</span>
<span class="sd">            The input structure to generate from</span>
<span class="sd">        copy : bool, optional</span>
<span class="sd">            If True, assign from a *copy* of ``struct`` (this is a lot slower).</span>
<span class="sd">            Default is False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gmxtop : :class:`GromacsTopologyFile`</span>
<span class="sd">            The topology file defined by the given struct</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span> <span class="k">as</span> <span class="n">_copy</span>
        <span class="n">gmxtop</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="n">_copy</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">join_dihedrals</span><span class="p">()</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">residues</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">residues</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">bonds</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">angles</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">dihedrals</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">impropers</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">cmaps</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmaps</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">rb_torsions</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">urey_bradleys</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">adjusts</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">bond_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">bond_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">angle_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">angle_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">dihedral_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedral_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">improper_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">improper_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">cmap_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmap_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">rb_torsion_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsion_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">urey_bradley_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">urey_bradley_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">adjust_types</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjust_types</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">combining_rule</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">box</span>
        <span class="n">gmxtop</span><span class="o">.</span><span class="n">nrexcl</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">nrexcl</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;GromacsTopologyFile does not support Amoeba FF&#39;</span><span class="p">)</span>
        <span class="c1"># Now check what the 1-4 scaling factors should be</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
                                                      <span class="n">_Defaults</span><span class="p">):</span>
            <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">defaults</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scee_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">scnb_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">adjust</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">adjust</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">scee_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">adjust</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span><span class="p">)</span>
                    <span class="c1"># Do not add scnb_values, since we can just set explicit</span>
                    <span class="c1"># exception pair parameters in GROMACS (which this structure</span>
                    <span class="c1"># already has)</span>
                <span class="c1"># In order to specify specific pair parameters, we need to set</span>
                <span class="c1"># gen_pairs to &#39;no&#39; so that the pair-specific L-J parameters are</span>
                <span class="c1"># printed to the topology file (rather than being auto-created)</span>
                <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">scee</span><span class="p">:</span>
                                <span class="n">scee_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">scee</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">scnb</span><span class="p">:</span>
                                <span class="n">scnb_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">scnb</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span><span class="p">:</span>
                            <span class="n">scee_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span><span class="p">:</span>
                            <span class="n">scnb_values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scee_values</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Structure has mixed 1-4 scaling which is &#39;</span>
                                   <span class="s1">&#39;not supported by Gromacs&#39;</span><span class="p">)</span>
            <span class="n">scee_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scee_values</span><span class="p">)</span>
            <span class="n">scnb_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">scnb_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scee_values</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">scee_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scnb_values</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">scnb_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">gmxtop</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
            <span class="n">gmxtop</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">comb_rule</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">gmxtop</span><span class="o">.</span><span class="n">parameterset</span> <span class="o">=</span> <span class="n">ParameterSet</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span>
                                            <span class="n">allow_unequal_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gmxtop</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="GromacsTopologyFile.write"><a class="viewcode-back" href="../../../api/parmed/parmed.gromacs.gromacstop.html#parmed.gromacs.GromacsTopologyFile.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="s1">&#39;inline&#39;</span><span class="p">,</span> <span class="n">molfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">itp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write a Gromacs Topology File from a Structure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dest : str or file-like</span>
<span class="sd">            The name of a file or a file object to write the Gromacs topology to</span>
<span class="sd">        combine : &#39;all&#39;, None, or list of iterables, optional</span>
<span class="sd">            If None, no molecules are combined into a single moleculetype. If</span>
<span class="sd">            &#39;all&#39;, all molecules are combined into a single moleculetype.</span>
<span class="sd">            Otherwise, the list of molecule indices (start from 0) will control</span>
<span class="sd">            which atoms are combined into single moleculetype&#39;s. Default is None</span>
<span class="sd">        parameters : &#39;inline&#39; or str or file-like object, optional</span>
<span class="sd">            This specifies where parameters should be printed. If &#39;inline&#39;</span>
<span class="sd">            (default), the parameters are written on the same lines as the</span>
<span class="sd">            valence terms are defined on. Any other string is interpreted as a</span>
<span class="sd">            filename for an ITP that will be written to and then included at the</span>
<span class="sd">            top of `dest`. If it is a file-like object, parameters will be</span>
<span class="sd">            written there.  If parameters is the same as ``dest``, then the</span>
<span class="sd">            parameter types will be written to the same topologyfile.</span>
<span class="sd">        molfile : None or str of file-like object, optional</span>
<span class="sd">            If specified as other than None, the molecules will be written to a</span>
<span class="sd">            separate file that is included in the main topology file. The</span>
<span class="sd">            name of this file will be the provided srting. If None or</span>
<span class="sd">            the same as the ``dest&#39;&#39;, the molecules will be written into the</span>
<span class="sd">            body of the topology file. If it is a file-like object,</span>
<span class="sd">            the molecules will be written there. Using this option can make</span>
<span class="sd">            it easier to combine multiple molecules into the same topology.</span>
<span class="sd">            This will change where the following topology sections are</span>
<span class="sd">            written: moleculetype, atoms, bonds, pairs, angles, dihedrals,</span>
<span class="sd">            cmap, settles, virtual_sites2, virtual_sites3 and exclusions.</span>
<span class="sd">        itp : bool, optional</span>
<span class="sd">            If True the following topology sections are not written:</span>
<span class="sd">            defaults, atomtypes, nonbond_params, bondtypes, pairtypes,</span>
<span class="sd">            angletypes, dihedraltypes, cmaptypes, system and molecules</span>
<span class="sd">            Thus only the individual molecules will be written in a stand-alone</span>
<span class="sd">            fashion, i.e. an itp-file.</span>
<span class="sd">            If True the molfile parameter will be set to None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError if the same molecule number appears in multiple combine lists</span>
<span class="sd">        TypeError if the dest input cannot be parsed</span>
<span class="sd">        ValueError if the combine, parameters, or molfile input cannot be parsed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">parmed.gromacs</span> <span class="k">as</span> <span class="nn">gmx</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">__version__</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">ParameterSet</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_unequal_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">dest</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">genopen</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;dest must be a file name or file-like object&#39;</span><span class="p">)</span>

        <span class="c1"># Determine where to write the parameters</span>
        <span class="n">own_parfile_handle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include_parfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parameters</span> <span class="o">==</span> <span class="s1">&#39;inline&#39;</span><span class="p">:</span>
            <span class="n">parfile</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parameters</span> <span class="o">==</span> <span class="n">fname</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">parfile</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">own_parfile_handle</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">parfile</span> <span class="o">=</span> <span class="n">genopen</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">include_parfile</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">parfile</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;parameters must be &quot;inline&quot;, a file name, or &#39;</span>
                             <span class="s1">&#39;a file-like object&#39;</span><span class="p">)</span>

        <span class="c1"># Determine where to write the molecules</span>
        <span class="k">if</span> <span class="n">itp</span> <span class="p">:</span>
            <span class="n">molfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">own_molfile_handle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include_molfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">molfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_molfile</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">molfile</span> <span class="o">==</span> <span class="n">fname</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">_molfile</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">own_molfile_handle</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">_molfile</span> <span class="o">=</span> <span class="n">genopen</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">include_molfile</span> <span class="o">=</span> <span class="n">molfile</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">molfile</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">_molfile</span> <span class="o">=</span> <span class="n">molfile</span>
            <span class="n">include_molfile</span> <span class="o">=</span> <span class="n">_molfile</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># I assume the file should still be included even if it&#39;s not passed</span>
            <span class="c1"># in as a file name. I&#39;m not sure if all `write`-able objects have a</span>
            <span class="c1"># `name` property, though.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;molfile must be &quot;top&quot;, a file name, or &#39;</span>
                             <span class="s1">&#39;a file-like object&#39;</span><span class="p">)</span>

        <span class="c1"># Error-checking for combine</span>
        <span class="k">if</span> <span class="n">combine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combine</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">combine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;combine must be None, list of indices, &#39;</span>
                                     <span class="s1">&#39;or &quot;all&quot;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combine_lists</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">combine</span><span class="p">:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Can only combine adjacent molecules&#39;</span><span class="p">)</span>
                    <span class="n">combine_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Write the header</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">;</span>
<span class="s1">;   File </span><span class="si">%s</span><span class="s1"> was generated</span>
<span class="s1">;   By user: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">)</span>
<span class="s1">;   On host: </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">;   At date: </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">;</span>
<span class="s1">;   This is a standalone topology file</span>
<span class="s1">;</span>
<span class="s1">;   Created by:</span>
<span class="s1">;   ParmEd:       </span><span class="si">%s</span><span class="s1">, VERSION </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">;   Executable:   </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">;   Library dir:  </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">;   Command line:</span>
<span class="s1">;     </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">;</span>
<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">_username</span><span class="p">,</span> <span class="n">_userid</span><span class="p">,</span> <span class="n">_uname</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1">. %B  %w </span><span class="si">%X</span><span class="s1"> %Y&#39;</span><span class="p">),</span>
       <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="n">__version__</span><span class="p">,</span>
       <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gmx</span><span class="o">.</span><span class="n">GROMACS_TOPDIR</span><span class="p">,</span>
       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;unicode_escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[ defaults ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; nbfunc        comb-rule       gen-pairs       &#39;</span>
                            <span class="s1">&#39;fudgeLJ fudgeQQ</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-15d</span><span class="s1"> </span><span class="si">%-15d</span><span class="s1"> </span><span class="si">%-15s</span><span class="s1"> </span><span class="si">%-12.8g</span><span class="s1"> </span><span class="si">%-12.8g</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">nbfunc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">comb_rule</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">gen_pairs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeLJ</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">fudgeQQ</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">include_parfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">include_parfile</span><span class="p">)</span>
            <span class="c1"># Print all atom types</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="p">:</span>
                <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ atomtypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">_bond_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)):</span>
                    <span class="n">print_bond_types</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_bond_types</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)):</span>
                    <span class="n">print_atnum</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_atnum</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; name    &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">print_bond_types</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;bond_type &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">print_atnum</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;at.num    &#39;</span><span class="p">)</span>
                <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mass    charge ptype  sigma      epsilon</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">econv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">atom_type</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">):</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-7s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">atom_type</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">print_bond_types</span><span class="p">:</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-8s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">atom_type</span><span class="o">.</span><span class="n">bond_type</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">print_atnum</span><span class="p">:</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%8d</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">atom_type</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%10.6f</span><span class="s1">  </span><span class="si">%10.8f</span><span class="s1">  A </span><span class="si">%14.8g</span><span class="s1"> </span><span class="si">%14.8g</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                  <span class="n">atom_type</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">atom_type</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">atom_type</span><span class="o">.</span><span class="n">sigma</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span>
                                  <span class="n">atom_type</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">econv</span><span class="p">))</span>
                <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Nonbonded parameters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">():</span>
                <span class="n">typemap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">)</span>
                <span class="n">types_in_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span><span class="o">.</span><span class="n">atom_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ nonbond_params ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">eps_conversion</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">typemap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types_in_system</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types_in_system</span><span class="p">:</span>
                        <span class="n">eps</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># kcal</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Angstrom</span>
                        <span class="n">eps</span> <span class="o">*=</span> <span class="n">eps_conversion</span>
                        <span class="n">sig</span> <span class="o">*=</span> <span class="mf">0.1</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> 1 </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sig</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">eps</span><span class="p">))</span>
            <span class="c1"># Print all parameter types unless we asked for inline</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="ow">and</span> <span class="n">parameters</span> <span class="o">!=</span> <span class="s1">&#39;inline&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ bondtypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; i    j  func       b0          kb</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">kilojoule</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-5s</span><span class="s1"> </span><span class="si">%-5s</span><span class="s1">    1   </span><span class="si">%.5f</span><span class="s1">   </span><span class="si">%f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="o">.</span><span class="n">req</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">conv</span><span class="p">))</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ pairtypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; i j   func    sigma1-4    epsilon1-4 ;&#39;</span>
                                  <span class="s1">&#39; ; THESE ARE 1-4 INTERACTIONS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">econv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule</span><span class="p">)</span>
                    <span class="n">lconv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
                    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-5s</span><span class="s1"> </span><span class="si">%-5s</span><span class="s1">  1  </span><span class="si">%.9f</span><span class="s1"> </span><span class="si">%.9f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">lconv</span><span class="p">,</span>
                                       <span class="n">param</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">econv</span><span class="p">))</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ angletypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;  i    j    k  func       th0       cth &#39;</span>
                                  <span class="s1">&#39;   rub         kub</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">kilojoule</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
                    <span class="n">bconv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span>
                                <span class="n">u</span><span class="o">.</span><span class="n">kilojoule</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">part</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-5s</span><span class="s1"> </span><span class="si">%-5s</span><span class="s1"> </span><span class="si">%-5s</span><span class="s1">    </span><span class="si">%%</span><span class="s1">d   </span><span class="si">%12.7f</span><span class="s1">   </span><span class="si">%12.7f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">param</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                                <span class="n">param</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">conv</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">:</span>
                            <span class="n">ub</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">part</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">ub</span><span class="o">.</span><span class="n">req</span><span class="p">,</span>
                                          <span class="n">ub</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">bconv</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">part</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ dihedraltypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;i  j   k  l  func      phase      kd      &#39;</span>
                                  <span class="s1">&#39;pn</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1">  </span><span class="si">%d</span><span class="s1">   </span><span class="si">%.2f</span><span class="s1">   </span><span class="si">%.6f</span><span class="s1">   </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                          <span class="n">dt</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">per</span><span class="p">)))</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ dihedraltypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;i  j   k  l  func      phase      kd      &#39;</span>
                                  <span class="s1">&#39;pn</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="p">)</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1">  </span><span class="si">%d</span><span class="s1">   </span><span class="si">%.2f</span><span class="s1">   </span><span class="si">%.6f</span><span class="s1">   </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                      <span class="mi">4</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                      <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">per</span><span class="p">)))</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">:</span>
                    <span class="c1"># BUGBUG -- The ordering is borked here because that made it</span>
                    <span class="c1"># simpler for me to work with back when I wrote the CHARMM</span>
                    <span class="c1"># parsers. This needs to be fixed now and handled correctly.</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ dihedraltypes ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; i  j       k       l       func     q0    &#39;</span>
                                  <span class="s1">&#39;cq</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1">    </span><span class="si">%d</span><span class="s1">   </span><span class="si">%.6f</span><span class="s1">   </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">improper_types</span><span class="p">):</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                      <span class="mi">2</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">psi_eq</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">psi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">))</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># CMAP grids are never printed inline, so if we have them, we need</span>
            <span class="c1"># to write a dedicated section for them</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">:</span>
                    <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ cmaptypes ]</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">used_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">used_keys</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">used_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1"> </span><span class="si">%-6s</span><span class="s1">   1   &#39;</span>
                                      <span class="s1">&#39;</span><span class="si">%4d</span><span class="s1"> </span><span class="si">%4d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                      <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">param</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span>
                                      <span class="n">param</span><span class="o">.</span><span class="n">resolution</span><span class="p">))</span>
                        <span class="n">res2</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">resolution</span> <span class="o">*</span> <span class="n">param</span><span class="o">.</span><span class="n">resolution</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">res2</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="n">res2</span><span class="p">)</span>
                            <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">conv</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="p">)))</span>
                        <span class="n">parfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_molfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#include &quot;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">include_molfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">combine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">molecules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">sysnum</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nameset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">nameset</span><span class="p">:</span>
                            <span class="n">orig</span> <span class="o">=</span> <span class="n">title</span>
                            <span class="n">sfx</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="k">while</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">nameset</span><span class="p">:</span>
                                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">sfx</span><span class="p">)</span>
                                <span class="n">sfx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;system</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sysnum</span>
                        <span class="n">sysnum</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                    <span class="n">nameset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                    <span class="n">GromacsTopologyFile</span><span class="o">.</span><span class="n">_write_molecule</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">_molfile</span><span class="p">,</span>
                                                        <span class="n">title</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                                        <span class="n">parameters</span> <span class="o">==</span> <span class="s1">&#39;inline&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="p">:</span>
                    <span class="c1"># System</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ system ]</span><span class="se">\n</span><span class="s1">; Name</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generic title&#39;</span><span class="p">)</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1"># Molecules</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ molecules ]</span><span class="se">\n</span><span class="s1">; Compound       #mols</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">total_mols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">total_mols</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">lst</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">molecules</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Could not find molecule </span><span class="si">%d</span><span class="s1"> &#39;</span>
                                                 <span class="s1">&#39;in list&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">total_mols</span> <span class="ow">and</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-15s</span><span class="s1"> </span><span class="si">%6d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">ii</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combine</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">combine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">GromacsTopologyFile</span><span class="o">.</span><span class="n">_write_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_molfile</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
                                                    <span class="n">params</span><span class="p">,</span>
                                                    <span class="n">parameters</span> <span class="o">==</span> <span class="s1">&#39;inline&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ system ]</span><span class="se">\n</span><span class="s1">; Name</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generic title&#39;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1"># Molecules</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ molecules ]</span><span class="se">\n</span><span class="s1">; Compound       #mols</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-15s</span><span class="s1"> </span><span class="si">%6d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">molecules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">nmols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">)</span>
                <span class="n">moleculedict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="c1"># Hash our molecules by indices</span>
                <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num</span><span class="p">:</span>
                        <span class="n">moleculedict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
                <span class="n">combined_molecules</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">combine_lists</span><span class="p">:</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">mols_in_mol</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">molid</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mol</span> <span class="o">=</span> <span class="n">moleculedict</span><span class="p">[</span><span class="n">molid</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Molecule ID out of range&#39;</span><span class="p">)</span>
                        <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">molid</span><span class="p">])]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">molid</span><span class="p">])]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">mols_in_mol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">mols_in_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">combmol</span> <span class="o">=</span> <span class="n">mols_in_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">mols_in_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">combmol</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mols_in_mol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mols_in_mol</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="ow">in</span> <span class="n">counts</span> <span class="ow">and</span> <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">mol</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">mol</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">combmol</span> <span class="o">+=</span> <span class="n">mol</span> <span class="o">*</span> <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">mol</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">combmol</span> <span class="o">+=</span> <span class="n">mol</span>
                    <span class="n">combined_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">combmol</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="p">)))</span>
                    <span class="n">nmols</span> <span class="o">-=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># combined_molecules now contains a list of tuples, and that</span>
                <span class="c1"># tuple stores the combined molecule, first molecule index of</span>
                <span class="c1"># the pre-combined molecule, and how many molecules were</span>
                <span class="c1"># combined</span>

                <span class="c1"># Sort combined molecules by starting location</span>
                <span class="n">combined_molecules</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">new_molecules</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
                <span class="n">cmc</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Combined Molecule Counter</span>
                <span class="n">add</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># How many molecules to &quot;skip&quot; due to combining</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmols</span><span class="p">):</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">add</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cmc</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_molecules</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="n">combined_molecules</span><span class="p">[</span><span class="n">cmc</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ii</span><span class="p">):</span>
                        <span class="n">new_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">combined_molecules</span><span class="p">[</span><span class="n">cmc</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">])])</span>
                        <span class="n">add</span> <span class="o">+=</span> <span class="n">combined_molecules</span><span class="p">[</span><span class="n">cmc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">cmc</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">ii</span><span class="p">])])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">ii</span><span class="p">])]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">new_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                              <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">ii</span><span class="p">])]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">counts</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">moleculedict</span><span class="p">[</span><span class="n">ii</span><span class="p">])]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sysnum</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">nameset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">new_molecules</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">nameset</span><span class="p">:</span>
                            <span class="n">orig</span> <span class="o">=</span> <span class="n">title</span>
                            <span class="n">sfx</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="k">while</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">nameset</span><span class="p">:</span>
                                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">sfx</span><span class="p">)</span>
                                <span class="n">sfx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;system</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sysnum</span>
                        <span class="n">sysnum</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                    <span class="n">nameset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                    <span class="n">GromacsTopologyFile</span><span class="o">.</span><span class="n">_write_molecule</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">_molfile</span><span class="p">,</span>
                                                        <span class="n">title</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                                        <span class="n">parameters</span> <span class="o">==</span> <span class="s1">&#39;inline&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">itp</span> <span class="p">:</span>
                    <span class="c1"># System</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ system ]</span><span class="se">\n</span><span class="s1">; Name</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Generic title&#39;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1"># Molecules</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ molecules ]</span><span class="se">\n</span><span class="s1">; Compound       #mols</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">total_mols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">new_molecules</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">total_mols</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">lst</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_molecules</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Could not find molecule </span><span class="si">%d</span><span class="s1"> &#39;</span>
                                                 <span class="s1">&#39;in list&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
                        <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">total_mols</span> <span class="ow">and</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-15s</span><span class="s1"> </span><span class="si">%6d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">ii</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">ii</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">own_parfile_handle</span><span class="p">:</span>
                <span class="n">parfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">own_molfile_handle</span><span class="p">:</span>
                <span class="n">_molfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">#===================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_molecule</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">writeparams</span><span class="p">):</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[ moleculetype ]</span><span class="se">\n</span><span class="s1">; Name            nrexcl</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">          </span><span class="si">%d</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">nrexcl</span><span class="p">))</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ atoms ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;   nr       type  resnr residue  atom   cgnr    &#39;</span>
                   <span class="s1">&#39;charge       mass  typeB    chargeB      massB</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">runchg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; residue </span><span class="si">%4d</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> rtp </span><span class="si">%s</span><span class="s1"> q </span><span class="si">%.1f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">:</span>
                <span class="n">runchg</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%5d</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%10.8f</span><span class="s1"> </span><span class="si">%10.6f</span><span class="s1">   ; &#39;</span>
                           <span class="s1">&#39;qtot </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                            <span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">runchg</span><span class="p">))</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Do valence terms now</span>
        <span class="n">EPs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)]</span>
        <span class="n">settle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">EPs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">oxy</span><span class="p">,</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
                <span class="n">hyd1</span><span class="p">,</span> <span class="n">hyd2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">settle</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">settle</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#ifdef FLEXIBLE</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ bonds ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)):</span>
                    <span class="k">continue</span> <span class="c1"># pragma: no cover</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span> <span class="c1"># pragma: no cover</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">writeparams</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span> <span class="ow">or</span> \
                        <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">params</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%.5f</span><span class="s1"> </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">conv</span><span class="p">))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Do the pair-exceptions</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ pairs ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">))</span>
            <span class="n">econv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
            <span class="n">lconv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">adjust</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">adjust</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">adjust</span><span class="o">.</span><span class="n">atom2</span><span class="p">))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">adjust</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">adjust</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">adjust</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">writeparams</span> <span class="ow">or</span>
                        <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span> <span class="ow">or</span>
                        <span class="n">adjust</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">params</span><span class="o">.</span><span class="n">pair_types</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">and</span> <span class="n">adjust</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%.9f</span><span class="s1"> </span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">adjust</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">lconv</span><span class="p">,</span> <span class="n">adjust</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">econv</span><span class="p">))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ pairs ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">))</span>
            <span class="c1"># Get the 1-4 pairs from the dihedral list</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">update_dihedral_exclusions</span><span class="p">()</span>
            <span class="n">econv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
            <span class="n">lconv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">ignore_end</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span>
                <span class="k">if</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">or</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">:</span>
                    <span class="k">continue</span> <span class="c1"># pragma: no cover</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">gen_pairs</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%.9f</span><span class="s1">  </span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">sigma_14</span><span class="o">+</span><span class="n">a2</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span><span class="o">*</span><span class="n">lconv</span><span class="p">,</span>
                                <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">epsilon_14</span><span class="o">*</span><span class="n">a2</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span><span class="o">*</span><span class="n">econv</span><span class="p">))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Angles</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span>
                        <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">conv2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ angles ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="s1"> </span><span class="si">%10s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span> <span class="s1">&#39;ak&#39;</span><span class="p">,</span> <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="p">))</span>
                <span class="n">param_equal</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span>
                <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">funct</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1"># Find the Urey-Bradley term, if it exists</span>
                    <span class="k">for</span> <span class="n">ub</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">ub</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">in</span> <span class="n">ub</span><span class="p">:</span>
                            <span class="n">ubtype</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">type</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ubtype</span> <span class="o">=</span> <span class="n">NoUreyBradley</span>
                    <span class="n">param_equal</span> <span class="o">=</span> <span class="n">param_equal</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">ubtype</span>
                <span class="k">if</span> <span class="n">writeparams</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">param_equal</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;   </span><span class="si">%.7f</span><span class="s1"> </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">conv</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">funct</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%.7f</span><span class="s1"> </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ubtype</span><span class="o">.</span><span class="n">req</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">ubtype</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">conv2</span><span class="p">))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Dihedrals</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ dihedrals ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ak&#39;</span><span class="p">,</span> <span class="s1">&#39;al&#39;</span><span class="p">,</span> <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">,</span> <span class="s1">&#39;c4&#39;</span><span class="p">,</span> <span class="s1">&#39;c5&#39;</span><span class="p">))</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span>
                    <span class="n">typedict</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">improper_periodic_types</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">typedict</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dihedral_types</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                        <span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">writeparams</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">typedict</span> <span class="ow">or</span> \
                        <span class="n">_diff_diheds</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">typedict</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">):</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                            <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">per</span><span class="p">)))</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">  </span><span class="si">%.5f</span><span class="s1">  </span><span class="si">%.7f</span><span class="s1">  </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                                    <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">dihed</span><span class="o">.</span><span class="n">funct</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">per</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%.7f</span><span class="s1">  </span><span class="si">%.7f</span><span class="s1">  </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                            <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span><span class="p">)))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># RB-torsions</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ dihedrals ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ak&#39;</span><span class="p">,</span> <span class="s1">&#39;al&#39;</span><span class="p">,</span> <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;c4&#39;</span><span class="p">,</span> <span class="s1">&#39;c5&#39;</span><span class="p">))</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
            <span class="n">paramfmt</span> <span class="o">=</span> <span class="s1">&#39;  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="p">),</span>
                        <span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="p">),</span> <span class="n">_gettype</span><span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">writeparams</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span> <span class="ow">or</span> \
                        <span class="n">params</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">paramfmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c0</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                           <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c1</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                           <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c2</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                           <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c3</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                           <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c4</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                                           <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c5</span><span class="o">*</span><span class="n">conv</span><span class="p">))</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Impropers</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ dihedrals ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39; </span><span class="si">%10s</span><span class="s1">&#39;</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ak&#39;</span><span class="p">,</span> <span class="s1">&#39;al&#39;</span><span class="p">,</span> <span class="s1">&#39;funct&#39;</span><span class="p">,</span> <span class="s1">&#39;c0&#39;</span><span class="p">,</span> <span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">))</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># BUGBUG: We always write improper types since we don&#39;t</span>
                <span class="c1"># currently store the correct ordering of the types in the</span>
                <span class="c1"># improper section</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%12.7f</span><span class="s1">  </span><span class="si">%12.7f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_eq</span><span class="p">,</span>
                                                   <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_k</span><span class="o">*</span><span class="n">conv</span><span class="p">))</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Cmaps</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ cmap ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;;</span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%5s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ai&#39;</span><span class="p">,</span> <span class="s1">&#39;aj&#39;</span><span class="p">,</span> <span class="s1">&#39;ak&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;al&#39;</span><span class="p">,</span> <span class="s1">&#39;am&#39;</span><span class="p">,</span> <span class="s1">&#39;funct&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%7d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%6d</span><span class="s1"> </span><span class="si">%5d</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">funct</span><span class="p">))</span>
        <span class="c1"># See if this is a solvent molecule with 3 or fewer particles that can</span>
        <span class="c1"># be SETTLEd</span>
        <span class="k">if</span> <span class="n">settle</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#else</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ settles ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; i     funct   doh     dhh</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">oxy</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hyd1</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                    <span class="c1"># Use default values for TIPnP if no type exists</span>
                    <span class="n">doh</span> <span class="o">=</span> <span class="mf">0.09572</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span> <span class="o">/</span> <span class="mi">10</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">hyd1</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hyd2</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                    <span class="c1"># Use default values for TIPnP if no type exists</span>
                    <span class="n">dhh</span> <span class="o">=</span> <span class="mf">0.15139</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span> <span class="o">/</span> <span class="mi">10</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">oxy</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hyd1</span> <span class="ow">in</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">hyd2</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                        <span class="n">theteq</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span> <span class="o">*</span> <span class="n">DEG_TO_RAD</span>
                        <span class="n">dhh</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">doh</span><span class="o">*</span><span class="n">doh</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">doh</span><span class="o">*</span><span class="n">doh</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theteq</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GromacsError</span><span class="p">(</span><span class="s1">&#39;Cannot determine SETTLE geometry&#39;</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;1     1   </span><span class="si">%.8f</span><span class="s1">   </span><span class="si">%.8f</span><span class="se">\n\n</span><span class="s1">#endif</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">doh</span><span class="p">,</span> <span class="n">dhh</span><span class="p">))</span>
        <span class="c1"># Virtual sites</span>
        <span class="k">if</span> <span class="n">EPs</span><span class="p">:</span>
            <span class="n">ftypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">frame_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">EPs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">ftypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="ow">is</span> <span class="n">TwoParticleExtraPointFrame</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ virtual_sites2 ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; Site  from    funct  a</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">EP</span> <span class="ow">in</span> <span class="n">EPs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="p">,</span> <span class="n">ftype</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-5d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1">   </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">EP</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">EP</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ThreeParticleExtraPointFrame</span><span class="p">,</span>
                               <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">):</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ virtual_sites3 ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;; Site  from                   funct</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">EP</span> <span class="ow">in</span> <span class="n">EPs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="p">,</span>
                                <span class="n">ThreeParticleExtraPointFrame</span><span class="p">):</span>
                            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()</span>
                            <span class="n">junk</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
                            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-5d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1">   </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">EP</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="mi">1</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="p">,</span>
                                <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">):</span>
                            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()</span>
                            <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">EP</span><span class="o">.</span><span class="n">frame_type</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
                            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-5d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1"> </span><span class="si">%-4d</span><span class="s1">   </span><span class="si">%.6f</span><span class="s1">  </span><span class="si">%.6f</span><span class="s1">  &#39;</span>
                                       <span class="s1">&#39;</span><span class="si">%.6f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">EP</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">a3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">))</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Do we need to list exclusions for systems with EPs?</span>
        <span class="k">if</span> <span class="n">EPs</span> <span class="ow">or</span> <span class="n">settle</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[ exclusions ]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">:</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;parameterset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">Structure</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameterset</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;parameterset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;defaults&#39;</span><span class="p">]</span></div>

<span class="k">def</span> <span class="nf">_any_atoms_farther_than</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks to see if there are any atom pairs farther away in the</span>
<span class="sd">    bond graph than the desired limit</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    structure : :class:`Structure`</span>
<span class="sd">        The structure to search through</span>
<span class="sd">    limit : int, optional</span>
<span class="sd">        The most number of bonds away to check for. Default is 3</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    within : bool</span>
<span class="sd">        True if any atoms are *more* than ``limit`` bonds away from any other</span>
<span class="sd">        atom</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getrecursionlimit</span><span class="p">(),</span> <span class="n">limit</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">marked</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">_mark_graph</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">atom</span><span class="o">.</span><span class="n">marked</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">_mark_graph</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Marks all atoms in the graph listing the minimum number of bonds each</span>
<span class="sd">    atom is away from the current atom</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atom : :class:`Atom`</span>
<span class="sd">        The current atom to evaluate in the bond graph</span>
<span class="sd">    num : int</span>
<span class="sd">        The current depth in our search</span>
<span class="sd">    limit : int</span>
<span class="sd">        The maximum depth we want to search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom</span><span class="o">.</span><span class="n">marked</span> <span class="o">=</span> <span class="n">num</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">marked</span> <span class="o">&lt;=</span> <span class="n">num</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">_mark_graph</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_diff_diheds</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span> <span class="n">dt2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Determine if 2 dihedrals are *really* different. dt1 can either be a</span>
<span class="sd">    DihedralType or a DihedralTypeList or dt1 can be a DihedralType and dt2 can</span>
<span class="sd">    be a DihedralTypeList.  This returns True if dt1 == dt2 *or* dt1 is equal to</span>
<span class="sd">    the only element of dt2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dt1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">dt2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dt1</span> <span class="o">==</span> <span class="n">dt2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt2</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dt2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dt1</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">_gettype</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">UnassignedAtomType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">bond_type</span>
    <span class="k">return</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015, Jason Swails

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>