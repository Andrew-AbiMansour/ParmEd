

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>parmed.amber.parameters &mdash; ParmEd  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> ParmEd
          

          
          </a>

          
            
            
              <div class="version">
                0+untagged.3319.g7a6168d
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topologyobjects.html">Core classes used to represent topologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">The core Structure class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dimensional_analysis.html">Working with units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readwrite.html">Reading and writing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amber.html">The Amber file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../charmm.html">The CHARMM file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gromacs.html">The GROMACS file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rosetta.html">PyRosetta Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html">Using <code class="docutils literal notranslate"><span class="pre">parmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html#using-xparmed">Using <code class="docutils literal notranslate"><span class="pre">xparmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed_api.html">The ParmEd API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openmm.html">OpenMM Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualization.html">Visualization Functionality</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ParmEd</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>parmed.amber.parameters</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for parmed.amber.parameters</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains classes for parsing and processing Amber parameter files.</span>

<span class="sd">Author: Jason M. Swails</span>
<span class="sd">Contributors:</span>
<span class="sd">Date: Aug. 11, 2015</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">.offlib</span> <span class="kn">import</span> <span class="n">AmberOFFLibrary</span>
<span class="kn">from</span> <span class="nn">..constants</span> <span class="kn">import</span> <span class="n">TINY</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">ParameterError</span><span class="p">,</span> <span class="n">AmberWarning</span><span class="p">,</span> <span class="n">ParameterWarning</span>
<span class="kn">from</span> <span class="nn">..modeller.residue</span> <span class="kn">import</span> <span class="n">ResidueTemplateContainer</span>
<span class="kn">from</span> <span class="nn">..formats.mol2</span> <span class="kn">import</span> <span class="n">Mol2File</span>
<span class="kn">from</span> <span class="nn">..formats.registry</span> <span class="kn">import</span> <span class="n">FileFormatType</span>
<span class="kn">from</span> <span class="nn">..parameters</span> <span class="kn">import</span> <span class="n">ParameterSet</span>
<span class="kn">from</span> <span class="nn">..periodic_table</span> <span class="kn">import</span> <span class="n">Mass</span><span class="p">,</span> <span class="n">element_by_mass</span><span class="p">,</span> <span class="n">AtomicNum</span>
<span class="kn">from</span> <span class="nn">..topologyobjects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AtomType</span><span class="p">,</span> <span class="n">BondType</span><span class="p">,</span> <span class="n">AngleType</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">,</span>
                                    <span class="n">DihedralTypeList</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utils.io</span> <span class="kn">import</span> <span class="n">genopen</span>
<span class="kn">from</span> <span class="nn">..utils.six</span> <span class="kn">import</span> <span class="n">add_metaclass</span><span class="p">,</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">PY2</span>
<span class="kn">from</span> <span class="nn">..utils.six.moves</span> <span class="kn">import</span> <span class="nb">map</span>
<span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>

<span class="c1"># parameter file regexes</span>
<span class="n">subs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">FLOATRE</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;([+-]?(?:\d+(?:\.\d*)?|\.\d+))&#39;</span><span class="p">,</span>
            <span class="n">FILENAMERE</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;&#39;&#39;(&quot;.+?&quot;|&#39;.+?&#39;|[\S]*)&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">_bondre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(..?)-(..?)\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="n">_anglere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(..?)-(..?)-(..?)\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="n">_dihedre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(..?)-(..?)-(..?)-(..?)\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+&#39;</span>
                      <span class="s1">&#39;</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="n">_dihed2re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+&#39;</span>
                       <span class="s1">&#39;</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="n">_sceere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SCEE=\s*</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="n">_scnbre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SCNB=\s*</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="n">_impropre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(..?)-(..?)-(..?)-(..?)\s+&#39;</span>
                       <span class="s1">&#39;</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">\s+</span><span class="si">%(FLOATRE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">)</span>
<span class="c1"># Leaprc regexes</span>
<span class="n">_atomtypere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;({\s*[&quot;&#39;]([\w\+\-]+)[&quot;&#39;]\s*[&quot;&#39;](\w+)[&quot;&#39;]\s*&quot;&quot;&quot;</span>
                         <span class="sa">r</span><span class="sd">&quot;&quot;&quot;[&quot;&#39;](\w+)[&quot;&#39;]\s*})&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">_loadparamsre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;loadamberparams\s+</span><span class="si">%(FILENAMERE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">_loadoffre</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;loadoff\s+</span><span class="si">%(FILENAMERE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">_loadmol2re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\S+)\s*=\s*loadmol[23]\s*</span><span class="si">%(FILENAMERE)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subs</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="k">del</span> <span class="n">subs</span>

<span class="k">def</span> <span class="nf">_find_amber_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">search_oldff</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds an Amber file. Looks in the current directory, then the following</span>
<span class="sd">    locations:</span>

<span class="sd">    - $AMBERHOME/dat/leap/lib</span>
<span class="sd">    - $AMBERHOME/dat/leap/parm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">parmed.amber</span> <span class="kn">import</span> <span class="n">AMBERHOME</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">{</span><span class="n">fname</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span> <span class="ow">in</span> <span class="p">({</span><span class="s1">&#39;&quot;&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;&#39;&quot;</span><span class="p">}):</span>
        <span class="c1"># Strip quotes</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fname</span>
    <span class="n">leapdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AMBERHOME</span><span class="p">,</span> <span class="s1">&#39;dat&#39;</span><span class="p">,</span> <span class="s1">&#39;leap&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leapdir</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leapdir</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leapdir</span><span class="p">,</span> <span class="s1">&#39;parm&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leapdir</span><span class="p">,</span> <span class="s1">&#39;parm&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">search_oldff</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leapdir</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;oldff&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leapdir</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;oldff&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot find Amber file [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>

<div class="viewcode-block" id="AmberParameterSet"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.parameters.html#parmed.amber.AmberParameterSet">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">FileFormatType</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AmberParameterSet</span><span class="p">(</span><span class="n">ParameterSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class storing parameters from an Amber parameter set</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filenames : str, list of str, file-like, or list of file-like; optional</span>
<span class="sd">        Either the name of a file or a list of filenames from which parameters</span>
<span class="sd">        should be parsed.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Order is important in the list of files provided. The parameters are loaded</span>
<span class="sd">    in the order they are provided, and any parameters that are specified in</span>
<span class="sd">    multiple places are overwritten (that is, the *last* occurrence is the</span>
<span class="sd">    parameter type that is used)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    :class:`parmed.parameters.ParameterSet`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParameterSet.id_format"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.parameters.html#parmed.amber.AmberParameterSet.id_format">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">id_format</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies the file type as either an Amber-style frcmod or parm.dat</span>
<span class="sd">        file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file to check format for</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        is_fmt : bool</span>
<span class="sd">            True if it is an Amber-style parameter file. False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">genopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="c1"># Must be an frcmod file</span>
                <span class="k">while</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MASS&#39;</span><span class="p">,</span> <span class="s1">&#39;BOND&#39;</span><span class="p">,</span> <span class="s1">&#39;ANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;ANGL&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHE&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHED&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;DIHEDRAL&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPR&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPROP&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPROPER&#39;</span><span class="p">,</span> <span class="s1">&#39;NONB&#39;</span><span class="p">,</span> <span class="s1">&#39;NONBON&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;NONBOND&#39;</span><span class="p">,</span> <span class="s1">&#39;NONBONDED&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MASS&#39;</span><span class="p">,</span> <span class="s1">&#39;BOND&#39;</span><span class="p">,</span> <span class="s1">&#39;ANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;ANGL&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHE&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHED&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHEDRAL&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;IMPR&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPROP&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPROPER&#39;</span><span class="p">,</span> <span class="s1">&#39;NONB&#39;</span><span class="p">,</span> <span class="s1">&#39;NONBON&#39;</span><span class="p">,</span> <span class="s1">&#39;NONBOND&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;NONBONDED&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span> <span class="c1"># frcmod file</span>
            <span class="c1"># This must be an atom definition in the parm.dat file</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># The first word is the atom type (must be &lt;= 2 characters, and not</span>
            <span class="c1"># an integer)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># Polarizability might not be present...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="c1"># UGLY: Check the mass and make sure it matches the element&#39;s</span>
                <span class="c1"># mass to within 1 amu. Do our best to guess the element. If</span>
                <span class="c1"># it&#39;s a two-letter element, the element might be a 2-letter</span>
                <span class="c1"># element (like Br), or it might be a 1-letter element specified</span>
                <span class="c1"># by either the first or second letter. Check all possibilities.</span>
                <span class="c1"># Special-case instances like CA, which are just as likely (more</span>
                <span class="c1"># likely?) to be a carbon atom as it is to be a calcium (i.e.,</span>
                <span class="c1"># check for carbon atoms in anything that starts with C). If at</span>
                <span class="c1"># any point, what *should* be the mass doesn&#39;t match the mass of</span>
                <span class="c1"># the guessed element, tag this as *not* a parameter file</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Mass</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mass</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mass</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="kc">False</span>
                                <span class="k">elif</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Mass</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">Mass</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mass</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="kc">False</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Mass</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mass</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">False</span>
                            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Mass</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Mass</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mass</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Mass</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Mass</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Heuristic, but anything that comes after the polarizability is</span>
                <span class="c1"># a comment, and I have yet to see a leading comment that is a</span>
                <span class="c1"># number</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">filenames</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AmberParameterSet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_scee</span> <span class="o">=</span> <span class="mf">1.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_scnb</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">AmberOFFLibrary</span><span class="o">.</span><span class="n">id_format</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">AmberOFFLibrary</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">AmberOFFLibrary</span><span class="o">.</span><span class="n">id_format</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">AmberOFFLibrary</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assume open file object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParameterSet.from_leaprc"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.parameters.html#parmed.amber.AmberParameterSet.from_leaprc">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_leaprc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">search_oldff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load a parameter set from a leaprc file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str or file-like</span>
<span class="sd">            Name of the file or open file-object from which a leaprc-style file</span>
<span class="sd">            will be read</span>

<span class="sd">        search_oldff : bool, optional, default=False</span>
<span class="sd">            If True, search the oldff directories in the main Amber leap</span>
<span class="sd">            folders. Default is False</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This does not read all parts of a leaprc file -- only those pertinent to</span>
<span class="sd">        defining force field information. For instance, the following sections</span>
<span class="sd">        and commands are processed:</span>

<span class="sd">        - addAtomTypes</span>
<span class="sd">        - loadAmberParams</span>
<span class="sd">        - loadOFF</span>
<span class="sd">        - loadMol2</span>
<span class="sd">        - loadMol3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">genopen</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fname</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># To make parsing easier, and because leaprc files are usually quite</span>
        <span class="c1"># short, I&#39;ll read the whole file into memory</span>
        <span class="k">def</span> <span class="nf">joinlines</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">newlines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">composite</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\n</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">composite</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">composite</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">composite</span><span class="p">))</span>
                <span class="n">composite</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">composite</span><span class="p">:</span>
                <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">composite</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">newlines</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">joinlines</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span> <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">else</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)],</span> <span class="n">f</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">lowertext</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># commands are case-insensitive</span>
        <span class="c1"># Now process the parameter files</span>
        <span class="k">def</span> <span class="nf">process_fname</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_BSTOKEN_&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\ &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\ &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fname</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\ &#39;</span><span class="p">,</span> <span class="s1">&#39;_BSTOKEN_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_loadparamsre</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">process_fname</span><span class="p">(</span><span class="n">_loadparamsre</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">params</span><span class="o">.</span><span class="n">load_parameters</span><span class="p">(</span><span class="n">_find_amber_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">search_oldff</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">_loadoffre</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">process_fname</span><span class="p">(</span><span class="n">_loadoffre</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">params</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">AmberOFFLibrary</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">_find_amber_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">search_oldff</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">_loadmol2re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="p">(</span><span class="n">resname</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="o">=</span> <span class="n">_loadmol2re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">residue</span> <span class="o">=</span> <span class="n">Mol2File</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">_find_amber_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">search_oldff</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">ResidueTemplateContainer</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Multi-residue mol2 files not supported by tleap. Loading anyway &#39;</span>
                                  <span class="s1">&#39;using names in mol2&#39;</span><span class="p">,</span> <span class="n">AmberWarning</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">residue</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="n">resname</span><span class="p">]</span> <span class="o">=</span> <span class="n">residue</span>
        <span class="c1"># Now process the addAtomTypes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">lowertext</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;addatomtypes&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Does not exist in this file</span>
            <span class="n">atom_types_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;addatomtypes&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="ow">and</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;</span><span class="se">\r\n\t</span><span class="s1"> &#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Unsupported addAtomTypes syntax in leaprc file&#39;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Unsupported addAtomTypes syntax in leaprc file&#39;</span><span class="p">)</span>
            <span class="c1"># We are at our first brace</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nopen</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
                    <span class="n">nopen</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">:</span>
                    <span class="n">nopen</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">nopen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">atom_types_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">symb</span><span class="p">,</span> <span class="n">hyb</span> <span class="ow">in</span> <span class="n">_atomtypere</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">atom_types_str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">symb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AtomicNum</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a recognized element&#39;</span> <span class="o">%</span> <span class="n">symb</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">symb</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">params</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParameterSet.from_structure"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.parameters.html#parmed.amber.AmberParameterSet.from_structure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_structure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">struct</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extracts known parameters from a Structure instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        struct : :class:`parmed.structure.Structure`</span>
<span class="sd">            The parametrized ``Structure`` instance from which to extract</span>
<span class="sd">            parameters into a ParameterSet</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : :class:`ParameterSet`</span>
<span class="sd">            The parameter set with all parameters defined in the Structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AmberParameterSet</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">allow_unequal_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParameterSet.load_parameters"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.parameters.html#parmed.amber.AmberParameterSet.load_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">load_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load a set of parameters from a single parameter file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str or file-like</span>
<span class="sd">            Parameter file to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">genopen</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fname</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_frcmod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MASS&#39;</span><span class="p">,</span> <span class="s1">&#39;BOND&#39;</span><span class="p">,</span> <span class="s1">&#39;ANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;ANGL&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHE&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHED&#39;</span><span class="p">,</span> <span class="s1">&#39;DIHEDRAL&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;IMPR&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPROP&#39;</span><span class="p">,</span> <span class="s1">&#39;IMPROPER&#39;</span><span class="p">,</span> <span class="s1">&#39;NONB&#39;</span><span class="p">,</span> <span class="s1">&#39;NONBON&#39;</span><span class="p">,</span> <span class="s1">&#39;NONBOND&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;NONBONDED&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_frcmod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_parm_dat</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_parse_frcmod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses an frcmod file from an open file object &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fiter</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">line</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span> <span class="k">yield</span> <span class="n">l</span>
        <span class="n">section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">finished_diheds</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fiter</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MASS&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;MASS&#39;</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;BOND&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;BOND&#39;</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ANGL&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;ANGLE&#39;</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DIHE&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;DIHEDRAL&#39;</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;IMPR&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;IMPROPER&#39;</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;NONB&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;NONBOND&#39;</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;LJEDIT&#39;</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="s1">&#39;NBFIX&#39;</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;MASS&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_mass_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;BOND&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_bond_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;ANGLE&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_angle_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;DIHEDRAL&#39;</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_dihedral_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">finished_diheds</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;IMPROPER&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_improper_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;NONBOND&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_nonbond_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s1">&#39;NBFIX&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_nbfix_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_parse_parm_dat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internal parser for parm.dat files from open file handle &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fiter</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">line</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span> <span class="k">yield</span> <span class="n">l</span>
            <span class="c1"># Keep yielding empty string after file has ended</span>
            <span class="k">yield</span> <span class="s1">&#39;&#39;</span>
        <span class="n">fiter</span> <span class="o">=</span> <span class="n">fiter</span><span class="p">()</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="n">finished_diheds</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Parse the masses</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_mass_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span> <span class="c1"># Skip the list of hydrophobic atom types</span>
        <span class="c1"># Process the bonds</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_bond_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="c1"># Process the angles</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_angle_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="c1"># Process the dihedrals</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_dihedral_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">finished_diheds</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="c1"># Process the impropers</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_improper_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="c1"># Process the 10-12 terms</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">acoef</span><span class="p">,</span> <span class="n">bcoef</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">acoef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acoef</span><span class="p">)</span>
                <span class="n">bcoef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bcoef</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Trouble parsing 10-12 terms&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acoef</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bcoef</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;10-12 potential not supported in AmberParameterSet currently&#39;</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="c1"># Process 12-6 terms. Get Equivalencing first</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="n">equivalent_ljtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">equivalent_types</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">equivalent_ljtypes</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">equivalent_types</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="n">words</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not parse the kind of nonbonded &#39;</span>
                                 <span class="s1">&#39;parameters in Amber parameter file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;RE&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Only RE nonbonded parameters supported&#39;</span><span class="p">)</span>
        <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_nonbond_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
        <span class="c1"># Now assign all of the equivalenced atoms</span>
        <span class="k">for</span> <span class="n">atyp</span><span class="p">,</span> <span class="n">otyp</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">equivalent_ljtypes</span><span class="p">):</span>
            <span class="n">otyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">otyp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">atyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atyp</span><span class="p">]</span><span class="o">.</span><span class="n">rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atyp</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">otyp</span><span class="o">.</span><span class="n">epsilon</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atyp</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TINY</span>
                            <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">otyp</span><span class="o">.</span><span class="n">rmin</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atyp</span><span class="p">]</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TINY</span><span class="p">):</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Equivalency defined between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> but parameters are &#39;</span>
                                      <span class="s1">&#39;not equal&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">otyp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atyp</span><span class="p">),</span> <span class="n">AmberWarning</span><span class="p">)</span>
                        <span class="c1"># Remove from equivalent types</span>
                        <span class="n">equivalent_types</span><span class="p">[</span><span class="n">otyp</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">atyp</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atyp</span><span class="p">]</span><span class="o">.</span><span class="n">set_lj_params</span><span class="p">(</span><span class="n">otyp</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">otyp</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;LJEDIT&#39;</span><span class="p">:</span>
            <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">rawline</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">rawline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_nbfix_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">equivalent_types</span><span class="p">)</span>
                <span class="n">rawline</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fiter</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="c1"># Private methods for processing parts of the file</span>
    <span class="k">def</span> <span class="nf">_process_mass_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not convert mass to float [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Error parsing MASS line. Not enough tokens&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;EP&#39;</span><span class="p">,</span> <span class="s1">&#39;LP&#39;</span><span class="p">):</span>
            <span class="n">atype</span> <span class="o">=</span> <span class="n">AtomType</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">atype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atype</span> <span class="o">=</span> <span class="n">AtomType</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span>
                             <span class="n">AtomicNum</span><span class="p">[</span><span class="n">element_by_mass</span><span class="p">(</span><span class="n">mass</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">atype</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_process_bond_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">rematch</span> <span class="o">=</span> <span class="n">_bondre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rematch</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand BOND line [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">eq</span> <span class="o">=</span> <span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">BondType</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">eq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">typ</span>

    <span class="k">def</span> <span class="nf">_process_angle_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">rematch</span> <span class="o">=</span> <span class="n">_anglere</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rematch</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand ANGLE line [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">eq</span> <span class="o">=</span> <span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">a3</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">AngleType</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">eq</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[(</span><span class="n">a3</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">typ</span>

    <span class="k">def</span> <span class="nf">_process_dihedral_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">finished_diheds</span><span class="p">,</span> <span class="n">last_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Processes a dihedral line, possibly part of a multi-term dihedral</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line : str</span>
<span class="sd">            Line of the file that contains a dihedral term</span>
<span class="sd">        finished_diheds : dict</span>
<span class="sd">            Dictionary of dihedral parameters whose final term has been read in</span>
<span class="sd">            already (which means additional terms will overwrite, not add)</span>
<span class="sd">        last_key : str or None</span>
<span class="sd">            If not None, this is the key for the last dihedral type that should</span>
<span class="sd">            be implied if the atom types are missing. Atom types seem to only be</span>
<span class="sd">            required for the first term in a multi-term torsion definition</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        key or None</span>
<span class="sd">            If a negative periodicity indicates another term is coming, the</span>
<span class="sd">            current key is returned so it can be passed as key to the next</span>
<span class="sd">            _process_dihedral_call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rematch</span> <span class="o">=</span> <span class="n">_dihedre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rematch</span> <span class="ow">and</span> <span class="n">last_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand DIHEDRAL line &#39;</span>
                                 <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">rematch</span><span class="p">:</span>
            <span class="n">rematch</span> <span class="o">=</span> <span class="n">_dihed2re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rematch</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand DIHEDRAL line &#39;</span>
                                     <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">div</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">per</span> <span class="o">=</span> <span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">last_key</span>
            <span class="n">rkey</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">finished_diheds</span>
            <span class="k">if</span> <span class="n">finished_diheds</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Cannot have an implied torsion that &#39;</span>
                                     <span class="s1">&#39;has already finished!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">per</span> <span class="o">=</span> <span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span>  <span class="n">a1</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">a2</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">a3</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">a4</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span>
            <span class="n">rkey</span> <span class="o">=</span> <span class="p">(</span><span class="n">a4</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">last_key</span> <span class="o">!=</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">last_key</span> <span class="o">!=</span> <span class="n">rkey</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Expecting next term in dihedral </span><span class="si">%r</span><span class="s1">, got &#39;</span>
                              <span class="s1">&#39;definition for dihedral </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">last_key</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                              <span class="n">ParameterWarning</span><span class="p">)</span>
        <span class="n">scee</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_sceere</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)]</span> <span class="ow">or</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">]</span>
        <span class="n">scnb</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_scnbre</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">)]</span> <span class="ow">or</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">]</span>
        <span class="n">per</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">div</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">per</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                           <span class="n">scee</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scnb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">finished_diheds</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="c1"># This dihedral is already finished its definition, which means</span>
            <span class="c1"># we go ahead and add a new one to override it</span>
            <span class="n">typs</span> <span class="o">=</span> <span class="n">DihedralTypeList</span><span class="p">()</span>
            <span class="n">typs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">rkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">typs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="n">finished_diheds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">finished_diheds</span><span class="p">[</span><span class="n">rkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">per</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">per</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">_process_improper_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">rematch</span> <span class="o">=</span> <span class="n">_impropre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rematch</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand IMPROPER line &#39;</span>
                                    <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">per</span> <span class="o">=</span> <span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a2</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">a3</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="n">a4</span> <span class="o">=</span> <span class="n">a4</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Pre-sort the improper types, assuming atom3 is the central atom (which</span>
        <span class="c1"># it must be in Amber parameter files!!!!)</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">])</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">DihedralType</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">per</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_process_nonbond_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atyp</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand nonbond parameter line &#39;</span>
                                 <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">atyp</span><span class="p">]</span><span class="o">.</span><span class="n">set_lj_params</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">eps</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">rmin</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Atom type </span><span class="si">%s</span><span class="s1"> not present in the database.&#39;</span> <span class="o">%</span>
                                 <span class="n">atyp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not convert nonbond parameters to &#39;</span>
                                 <span class="s1">&#39;floats [</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_process_nbfix_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">equivalents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">rmin1</span><span class="p">,</span> <span class="n">eps1</span><span class="p">,</span> <span class="n">rmin2</span><span class="p">,</span> <span class="n">eps2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not understand LJEDIT line [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rmin1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rmin1</span><span class="p">)</span>
            <span class="n">eps1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">eps1</span><span class="p">)</span>
            <span class="n">rmin2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rmin2</span><span class="p">)</span>
            <span class="n">eps2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">eps2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s1">&#39;Could not convert LJEDIT parameters &#39;</span>
                                 <span class="s1">&#39;to floats.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eps1</span><span class="o">*</span><span class="n">eps2</span><span class="p">),</span> <span class="n">rmin1</span><span class="o">+</span><span class="n">rmin2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">equivalents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We need to add the same nbfixes to all atom types that are</span>
            <span class="c1"># equivalent to the atom types defined in the LJEDIT line</span>
            <span class="k">for</span> <span class="n">oa1</span> <span class="ow">in</span> <span class="n">equivalents</span><span class="p">[</span><span class="n">a1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">oa1</span><span class="p">,</span> <span class="n">a2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">oa1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eps1</span><span class="o">*</span><span class="n">eps2</span><span class="p">),</span> <span class="n">rmin1</span><span class="o">+</span><span class="n">rmin2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">oa2</span> <span class="ow">in</span> <span class="n">equivalents</span><span class="p">[</span><span class="n">a2</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">oa2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">oa2</span><span class="p">))]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eps1</span><span class="o">*</span><span class="n">eps2</span><span class="p">),</span> <span class="n">rmin1</span><span class="o">+</span><span class="n">rmin2</span><span class="p">)</span>
            <span class="c1"># Now do the equivalenced of atom 1 with the equivalenced of atom 2</span>
            <span class="k">for</span> <span class="n">oa1</span> <span class="ow">in</span> <span class="n">equivalents</span><span class="p">[</span><span class="n">a1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">oa2</span> <span class="ow">in</span> <span class="n">equivalents</span><span class="p">[</span><span class="n">a2</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">[(</span><span class="nb">min</span><span class="p">(</span><span class="n">oa1</span><span class="p">,</span> <span class="n">oa2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">oa1</span><span class="p">,</span> <span class="n">oa2</span><span class="p">))]</span> <span class="o">=</span> \
                            <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eps1</span><span class="o">*</span><span class="n">eps2</span><span class="p">),</span> <span class="n">rmin1</span><span class="o">+</span><span class="n">rmin2</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParameterSet.write"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.parameters.html#parmed.amber.AmberParameterSet.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Created by ParmEd&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;frcmod&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes a parm.dat file with the current parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dest : str or file-like</span>
<span class="sd">            The file name or file-like object to write the parameters to</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            The title of the frcmod to write. Default is &#39;Created by ParmEd&#39;</span>
<span class="sd">        style : str, optional</span>
<span class="sd">            If &#39;frcmod&#39;, the parameters are written in frcmod-format. If &#39;parm&#39;,</span>
<span class="sd">            the parameters are written in parm.dat-format. Default is &#39;frcmod&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">genopen</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">dest</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">style</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;frcmod&#39;</span><span class="p">,</span> <span class="s1">&#39;parm&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;style must be either frcmod or parm, not </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">style</span><span class="p">)</span>

        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">title</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the atom mass</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MASS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">):</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%6.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">typ</span><span class="o">.</span><span class="n">mass</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the bonds</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;BOND</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">),</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">   </span><span class="si">%8.3f</span><span class="s1">  </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">typ</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">req</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the angles</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ANGLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">),</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">   </span><span class="si">%8.3f</span><span class="s1">  </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a3</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                                         <span class="n">typ</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">theteq</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the dihedrals</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;DIHE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">),</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">):</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="n">typ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%8.3f</span><span class="s1"> </span><span class="si">%5.1f</span><span class="s1">    SCEE=</span><span class="si">%s</span><span class="s1"> SCNB=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a3</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a4</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span>
                               <span class="n">typ</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">scnb</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dtyp</span> <span class="ow">in</span> <span class="n">typ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%8.3f</span><span class="s1"> </span><span class="si">%5.1f</span><span class="s1">    SCEE=</span><span class="si">%s</span><span class="s1"> SCNB=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a3</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a4</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="n">dtyp</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="o">-</span><span class="n">dtyp</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">scnb</span><span class="p">))</span>
                <span class="n">dtyp</span> <span class="o">=</span> <span class="n">typ</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%8.3f</span><span class="s1"> </span><span class="si">%5.1f</span><span class="s1">    SCEE=</span><span class="si">%s</span><span class="s1"> SCNB=</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a3</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a4</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span>
                               <span class="n">dtyp</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">.</span><span class="n">scnb</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the impropers</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;IMPROPER</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">written_impropers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">),</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improper_periodic_types</span><span class="p">):</span>
            <span class="c1"># Make sure wild-cards come at the beginning</span>
            <span class="k">if</span> <span class="n">a2</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">a4</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Malformed generic improper!&#39;</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a1</span>
            <span class="k">elif</span> <span class="n">a4</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a2</span>
            <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a4</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span> <span class="ow">in</span> <span class="n">written_impropers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">written_impropers</span><span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">typ</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Multiple impropers with the same atom set not allowed&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> </span><span class="si">%14.8f</span><span class="s1"> </span><span class="si">%8.3f</span><span class="s1"> </span><span class="si">%5.1f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a3</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a4</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">typ</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span>
                           <span class="n">typ</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">per</span><span class="p">))</span>
            <span class="n">written_impropers</span><span class="p">[(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">)]</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the LJ terms</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NONB</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">):</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  </span><span class="si">%12.8f</span><span class="s1"> </span><span class="si">%12.8f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">typ</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Write the NBFIX terms</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;LJEDIT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">),</span> <span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">rmin</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nbfix_types</span><span class="p">):</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%12.8f</span><span class="s1"> </span><span class="si">%12.8f</span><span class="s1"> </span><span class="si">%12.8f</span><span class="s1"> </span><span class="si">%12.8f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">a2</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">eps</span><span class="p">,</span> <span class="n">rmin</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">rmin</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015, Jason Swails

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>