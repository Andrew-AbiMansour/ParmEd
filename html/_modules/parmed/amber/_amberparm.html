

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>parmed.amber._amberparm &mdash; ParmEd  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> ParmEd
          

          
          </a>

          
            
            
              <div class="version">
                0+untagged.3319.g7a6168d
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../topologyobjects.html">Core classes used to represent topologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">The core Structure class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dimensional_analysis.html">Working with units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readwrite.html">Reading and writing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amber.html">The Amber file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../charmm.html">The CHARMM file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gromacs.html">The GROMACS file classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rosetta.html">PyRosetta Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html">Using <code class="docutils literal notranslate"><span class="pre">parmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed.html#using-xparmed">Using <code class="docutils literal notranslate"><span class="pre">xparmed</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parmed_api.html">The ParmEd API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openmm.html">OpenMM Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualization.html">Visualization Functionality</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ParmEd</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>parmed.amber._amberparm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for parmed.amber._amberparm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains an amber prmtop class that will read in all</span>
<span class="sd">parameters and allow users to manipulate that data and write a new</span>
<span class="sd">prmtop object.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">_copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">..constants</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DEG_TO_RAD</span><span class="p">,</span> <span class="n">IFBOX</span><span class="p">,</span> <span class="n">IFCAP</span><span class="p">,</span> <span class="n">IFPERT</span><span class="p">,</span> <span class="n">MBONA</span><span class="p">,</span> <span class="n">MBPER</span><span class="p">,</span> <span class="n">MDPER</span><span class="p">,</span>
                         <span class="n">MGPER</span><span class="p">,</span> <span class="n">MPHIA</span><span class="p">,</span> <span class="n">MTHETA</span><span class="p">,</span> <span class="n">NATOM</span><span class="p">,</span> <span class="n">NATYP</span><span class="p">,</span> <span class="n">NBONA</span><span class="p">,</span> <span class="n">NBONH</span><span class="p">,</span>
                         <span class="n">NBPER</span><span class="p">,</span> <span class="n">NCOPY</span><span class="p">,</span> <span class="n">NDPER</span><span class="p">,</span> <span class="n">NEXT</span><span class="p">,</span> <span class="n">NGPER</span><span class="p">,</span> <span class="n">NHPARM</span><span class="p">,</span> <span class="n">NMXRS</span><span class="p">,</span> <span class="n">NNB</span><span class="p">,</span>
                         <span class="n">NPARM</span><span class="p">,</span> <span class="n">NPHB</span><span class="p">,</span> <span class="n">NPHIA</span><span class="p">,</span> <span class="n">NPHIH</span><span class="p">,</span> <span class="n">NPTRA</span><span class="p">,</span> <span class="n">NRES</span><span class="p">,</span> <span class="n">NTHETA</span><span class="p">,</span>
                         <span class="n">NTHETH</span><span class="p">,</span> <span class="n">NTYPES</span><span class="p">,</span> <span class="n">NUMANG</span><span class="p">,</span> <span class="n">NUMBND</span><span class="p">,</span> <span class="n">NUMEXTRA</span><span class="p">,</span> <span class="n">RAD_TO_DEG</span><span class="p">,</span>
                         <span class="n">SMALL</span><span class="p">,</span> <span class="n">TRUNCATED_OCTAHEDRON_ANGLE</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">AmberError</span><span class="p">,</span> <span class="n">AmberWarning</span><span class="p">,</span> <span class="n">MoleculeError</span>
<span class="kn">from</span> <span class="nn">..geometry</span> <span class="kn">import</span> <span class="n">box_lengths_and_angles_to_vectors</span>
<span class="kn">from</span> <span class="nn">..periodic_table</span> <span class="kn">import</span> <span class="n">AtomicNum</span><span class="p">,</span> <span class="n">element_by_mass</span>
<span class="kn">from</span> <span class="nn">..residue</span> <span class="kn">import</span> <span class="n">ALLION_NAMES</span><span class="p">,</span> <span class="n">SOLVENT_NAMES</span>
<span class="kn">from</span> <span class="nn">..structure</span> <span class="kn">import</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">needs_openmm</span>
<span class="kn">from</span> <span class="nn">..topologyobjects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Angle</span><span class="p">,</span> <span class="n">AngleType</span><span class="p">,</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">AtomList</span><span class="p">,</span> <span class="n">AtomType</span><span class="p">,</span>
                               <span class="n">Bond</span><span class="p">,</span> <span class="n">BondType</span><span class="p">,</span> <span class="n">Dihedral</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">,</span>
                               <span class="n">DihedralTypeList</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">,</span> <span class="n">Cmap</span><span class="p">,</span> <span class="n">CmapType</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..utils.six</span> <span class="kn">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">..utils.six.moves</span> <span class="kn">import</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">..vec3</span> <span class="kn">import</span> <span class="n">Vec3</span>
<span class="kn">from</span> <span class="nn">.amberformat</span> <span class="kn">import</span> <span class="n">AmberFormat</span>
<span class="kn">from</span> <span class="nn">.asciicrd</span> <span class="kn">import</span> <span class="n">AmberAsciiRestart</span>
<span class="kn">from</span> <span class="nn">.netcdffiles</span> <span class="kn">import</span> <span class="n">NetCDFRestart</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simtk</span> <span class="kn">import</span> <span class="n">openmm</span> <span class="k">as</span> <span class="n">mm</span>
    <span class="kn">from</span> <span class="nn">simtk.openmm</span> <span class="kn">import</span> <span class="n">app</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<div class="viewcode-block" id="AmberParm"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm">[docs]</a><span class="k">class</span> <span class="nc">AmberParm</span><span class="p">(</span><span class="n">AmberFormat</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Amber Topology (parm7 format) class. Gives low, and some high, level access</span>
<span class="sd">    to topology data. You can interact with the raw data in the topology file</span>
<span class="sd">    directly or interact with some of the high-level classes comprising the</span>
<span class="sd">    system topology and parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prm_name : str, optional</span>
<span class="sd">        If provided, this file is parsed and the data structures will be loaded</span>
<span class="sd">        from the data in this file</span>
<span class="sd">    xyz : str or array, optional</span>
<span class="sd">        If provided, the coordinates and unit cell dimensions from the provided</span>
<span class="sd">        Amber inpcrd/restart file will be loaded into the molecule, or the</span>
<span class="sd">        coordinates will be loaded from the coordinate array</span>
<span class="sd">    box : array, optional</span>
<span class="sd">        If provided, the unit cell information will be set from the provided</span>
<span class="sd">        unit cell dimensions (a, b, c, alpha, beta, and gamma, respectively)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    parm_data : dict {str : list}</span>
<span class="sd">        A dictionary that maps FLAG names to all of the data contained in that</span>
<span class="sd">        section of the Amber file.</span>
<span class="sd">    formats : dict {str : FortranFormat}</span>
<span class="sd">        A dictionary that maps FLAG names to the FortranFormat instance in which</span>
<span class="sd">        the data is stored in that section</span>
<span class="sd">    parm_comments : dict {str : list}</span>
<span class="sd">        A dictionary that maps FLAG names to the list of COMMENT lines that were</span>
<span class="sd">        stored in the original file</span>
<span class="sd">    flag_list : list</span>
<span class="sd">        An ordered list of all FLAG names. This must be kept synchronized with</span>
<span class="sd">        `parm_data`, `formats`, and `parm_comments` such that every item in</span>
<span class="sd">        `flag_list` is a key to those 3 dicts and no other keys exist</span>
<span class="sd">    charge_flag : str=&#39;CHARGE&#39;</span>
<span class="sd">        The name of the name of the FLAG that describes partial atomic charge</span>
<span class="sd">        data. If this flag is found, then its data are multiplied by the</span>
<span class="sd">        ELECTROSTATIC_CONSTANT to convert back to fractions of electrons</span>
<span class="sd">    version : str</span>
<span class="sd">        The VERSION string from the Amber file</span>
<span class="sd">    name : str</span>
<span class="sd">        The file name of the originally parsed file (set to the fname parameter)</span>
<span class="sd">    LJ_types : dict {str : int}</span>
<span class="sd">        A mapping whose keys are atom types paired with the nonbonded index of</span>
<span class="sd">        that type</span>
<span class="sd">    LJ_radius : list(float)</span>
<span class="sd">        A list of floats corresponding to the Rmin/2 parameter for every</span>
<span class="sd">        Lennard-Jones type. The indexes are the nonbonded index (`nb_idx`</span>
<span class="sd">        attribute of the `Atom` class) minus 1 to account for indexing from 0 in</span>
<span class="sd">        Python. The values are in Angstroms. To get the radius for a particular</span>
<span class="sd">        atom type, you can use `LJ_radius[LJ_types[&quot;type&quot;]-1]`</span>
<span class="sd">    LJ_depth : list(float)</span>
<span class="sd">        A list of Lennard-Jones epsilon parameters laid out the same way as</span>
<span class="sd">        LJ_radius, described above.</span>
<span class="sd">    atoms : AtomList(Atom)</span>
<span class="sd">        List of all atoms in the system</span>
<span class="sd">    residues : ResidueList(Residue)</span>
<span class="sd">        List of all residues in the system</span>
<span class="sd">    bonds : TrackedList(Bond)</span>
<span class="sd">        List of bonds between two atoms in the system</span>
<span class="sd">    angles : TrackedList(Angle)</span>
<span class="sd">        List of angles between three atoms in the system</span>
<span class="sd">    dihedrals : TrackedList(Angle)</span>
<span class="sd">        List of all proper and improper torsions between 4 atoms in the system</span>
<span class="sd">    box : list of 6 floats</span>
<span class="sd">        Periodic boundary unit cell dimensions and angles</span>
<span class="sd">    bond_types : TrackedList(BondType)</span>
<span class="sd">        The bond types containing the parameters for each bond stretching term</span>
<span class="sd">    angle_types : TrackedList(AngleType)</span>
<span class="sd">        The angle types containing the parameters for each angle bending term</span>
<span class="sd">    dihedral_types : TrackedList(DihedralType)</span>
<span class="sd">        The dihedral types containing the parameters for each torsional term</span>
<span class="sd">    bonds_inc_h : iterator(Bond)</span>
<span class="sd">        Read-only generator that loops through all bonds that contain Hydrogen</span>
<span class="sd">    bonds_without_h : iterator(Bond)</span>
<span class="sd">        Read-only generator that loops through all bonds that do not contain</span>
<span class="sd">        Hydrogen</span>
<span class="sd">    angles_inc_h : iterator(Angle)</span>
<span class="sd">        Read-only generator that loops through all angles that contain Hydrogen</span>
<span class="sd">    angles_without_h : iterator(Angle)</span>
<span class="sd">        Read-only generator that loops through all angles that do not contain</span>
<span class="sd">        Hydrogen</span>
<span class="sd">    dihedrals_inc_h : iterator(Dihedral)</span>
<span class="sd">        Read-only generator that loops through all dihedrals that contain</span>
<span class="sd">        Hydrogen</span>
<span class="sd">    dihedrals_without_h : iterator(Dihedral)</span>
<span class="sd">        Read-only generator that loops through all dihedrals that do not contain</span>
<span class="sd">        Hydrogen</span>
<span class="sd">    chamber : bool=False</span>
<span class="sd">        On AmberParm instances, this is always False to indicate that it is not</span>
<span class="sd">        a CHAMBER-style topology file</span>
<span class="sd">    amoeba : bool=False</span>
<span class="sd">        On AmberParm instances, this is always False to indicate that it is not</span>
<span class="sd">        an AMOEBA-style topology file</span>
<span class="sd">    has_cmap : bool=False</span>
<span class="sd">        On AmberParm instances, this is always False to indicate that it does</span>
<span class="sd">        not have correction maps (unique to CHARMM force field and chamber</span>
<span class="sd">        topologies)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_cmap_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.__init__"><a class="viewcode-back" href="../../../amberobj/parmed.amber.AmberParm.html#parmed.amber.AmberParm.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prm_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rst7_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates an AmberParm object from data in prm_name and establishes</span>
<span class="sd">        validity based on presence of POINTERS and CHARGE sections. In general,</span>
<span class="sd">        you should use LoadParm from the readparm module instead. LoadParm will</span>
<span class="sd">        correctly dispatch the object to the &#39;correct&#39; flavor of AmberParm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">AmberFormat</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prm_name</span><span class="p">)</span>
        <span class="n">Structure</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasvels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasbox</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crdname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rst7_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;rst7_name keyword is deprecated. Use xyz instead&#39;</span><span class="p">,</span>
                 <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crdname</span> <span class="o">=</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">rst7_name</span>
        <span class="k">elif</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">rst7_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;rst7_name keyword is deprecated and ignored in favor of xyz&#39;</span><span class="p">,</span>
                 <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crdname</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="k">if</span> <span class="n">prm_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_topology</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.initialize_topology"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.initialize_topology">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes topology data structures, like the list of atoms, bonds,</span>
<span class="sd">        etc., after the topology file has been read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">load_file</span>
        <span class="c1"># We need to handle RESIDUE_ICODE properly since it may have picked up</span>
        <span class="c1"># some extra values</span>
        <span class="k">if</span> <span class="s1">&#39;RESIDUE_ICODE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_array</span><span class="p">(</span><span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NRES</span><span class="p">])</span>
        <span class="c1"># Set up some of the attributes provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pointers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_LJ</span><span class="p">()</span>
        <span class="c1"># The way we check if the combining rules are geometric vs.</span>
        <span class="c1"># Lorentz-Berthelot is to try and change the combining rules to</span>
        <span class="c1"># geometric *if we detect NBFIXes* and see if we still have NBFIXes. If</span>
        <span class="c1"># not, then our combining rules are clearly geometric.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_1012</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">=</span> <span class="s1">&#39;geometric&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">=</span> <span class="s1">&#39;lorentz&#39;</span>
        <span class="c1"># Instantiate the Structure data structures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_structure</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">skip_bonds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not have coordinates&#39;</span> <span class="o">%</span> <span class="n">xyz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">coordinates</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;velocities&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">velocities</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">box</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">box</span>

        <span class="c1"># If all else fails, set the box from the prmtop file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;BOX_DIMENSIONS&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hasbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.from_rawdata"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.from_rawdata">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_rawdata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rawdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the raw data from a AmberFormat object and initialize an AmberParm</span>
<span class="sd">        from that data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rawdata : :class:`AmberFormat`</span>
<span class="sd">            An AmberFormat instance that has already been instantiated</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parm : :class:`AmberParm`</span>
<span class="sd">            An instance of this type from the data in rawdata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">name</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">version</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">formats</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">parm_data</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">parm_comments</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">parm_comments</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">flag_list</span> <span class="o">=</span> <span class="n">rawdata</span><span class="o">.</span><span class="n">flag_list</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">initialize_topology</span><span class="p">()</span>
        <span class="c1"># See if the rawdata has any kind of structural attributes, like</span>
        <span class="c1"># coordinates and an atom list with positions and/or velocities</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rawdata</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">):</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rawdata</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rawdata</span><span class="p">,</span> <span class="s1">&#39;velocities&#39;</span><span class="p">):</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rawdata</span><span class="o">.</span><span class="n">velocities</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rawdata</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">):</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rawdata</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">hasbox</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">hasvels</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">n_copy</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">pointers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NCOPY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_copy</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">_label_alternates</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inst</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.from_structure"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.from_structure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_structure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a Structure instance and initialize an AmberParm instance from that</span>
<span class="sd">        data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        struct : :class:`Structure`</span>
<span class="sd">            The input structure from which to construct an AmberParm instance</span>
<span class="sd">        copy : bool</span>
<span class="sd">            If True, the input struct is deep-copied to make sure it does not</span>
<span class="sd">            share any objects with the original ``struct``. Default is False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        inst : :class:`AmberParm`</span>
<span class="sd">            The AmberParm instance derived from the input structure</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the structure has parameters not supported by the standard Amber</span>
<span class="sd">            force field (i.e., standard bond, angle, and dihedral types)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Due to the nature of the prmtop file, struct almost *always* returns a</span>
<span class="sd">        deep copy. The one exception is when struct is already of type</span>
<span class="sd">        :class:`AmberParm`, in which case the original object is returned unless</span>
<span class="sd">        ``copy`` is ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">struct</span>
        <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">unknown_functional</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cannot instantiate an AmberParm from unknown functional&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">impropers</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmaps</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="ow">or</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="ow">or</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">multipole_frames</span> <span class="ow">or</span> <span class="n">struct</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;AmberParm does not support all of the &#39;</span>
                                <span class="s1">&#39;parameters defined in the input Structure&#39;</span><span class="p">)</span>
            <span class="c1"># Maybe it just has CHARMM parameters?</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;AmberParm does not support all of the parameters &#39;</span>
                            <span class="s1">&#39;defined in the input Structure. Try ChamberParm&#39;</span><span class="p">)</span>

        <span class="c1"># Convert all RB torsions to propers and delete the originals.</span>
        <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
            <span class="n">proper_types</span> <span class="o">=</span> <span class="n">DihedralTypeList</span><span class="o">.</span><span class="n">from_rbtorsion</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">proper_type</span> <span class="ow">in</span> <span class="n">proper_types</span><span class="p">:</span>
                <span class="n">proper</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
                <span class="n">proper</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">proper_type</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proper</span><span class="p">)</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proper</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[:]</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="n">struct</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>

        <span class="n">inst</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">split_dihedrals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">update_dihedral_exclusions</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_add_missing_13_14</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">inst</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[:]</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">pointers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">LJ_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">nbfixes</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">_set_nbidx_lj_params</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_add_standard_flags</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NATOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NATOM</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="c1"># pmemd likes to skip torsions with periodicities of 0, which may be</span>
        <span class="c1"># present as a way to hack entries into the 1-4 pairlist. See</span>
        <span class="c1"># https://github.com/ParmEd/ParmEd/pull/145 for discussion. The solution</span>
        <span class="c1"># here is to simply set that periodicity to 1.</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_cleanup_dihedrals_with_periodicity_zero</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_set_nonbonded_tables</span><span class="p">(</span><span class="n">nbfixes</span><span class="p">)</span>
        <span class="n">n_copy</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">pointers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NCOPY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_copy</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">_label_alternates</span><span class="p">()</span>

        <span class="c1"># Setting box sets some of the flag data appropriately</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">get_box</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inst</span></div>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_set_nbidx_lj_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nbfixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">assign_nbidx_from_types</span><span class="p">()</span>
        <span class="c1"># Give virtual sites a name that Amber understands</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;EP&#39;</span>
        <span class="c1"># Fill the Lennard-Jones arrays/dicts</span>
        <span class="n">ntyp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LJ_types</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span>
            <span class="n">ntyp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ntyp</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntyp</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntyp</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">rmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">epsilon</span>
        <span class="k">return</span> <span class="n">nbfixes</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Needs to copy a few additional data structures &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__copy__</span><span class="p">()</span>
        <span class="n">other</span><span class="o">.</span><span class="n">initialize_topology</span><span class="p">()</span>
        <span class="c1"># Copy coordinates, box, etc. if applicable</span>
        <span class="n">other</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">))</span>
        <span class="n">other</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_box</span><span class="p">)</span>
        <span class="c1"># Now we should have a full copy</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span>
        <span class="n">other</span><span class="o">.</span><span class="n">pointers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copy_lj_data</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">other</span><span class="o">.</span><span class="n">_add_standard_flags</span><span class="p">()</span>
        <span class="n">other</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="n">other</span><span class="o">.</span><span class="n">_set_nonbonded_tables</span><span class="p">()</span>
        <span class="c1"># Add back the original L-J tables to restore any NBFIXes that may have</span>
        <span class="c1"># been there</span>
        <span class="n">other</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">][:]</span>
        <span class="n">other</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">][:]</span>
        <span class="k">if</span> <span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">:</span>
            <span class="n">other</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">][:]</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_copy_lj_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Copies Lennard-Jones lists and dicts from myself to a copy &quot;&quot;&quot;</span>
        <span class="n">other</span><span class="o">.</span><span class="n">LJ_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_types</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">other</span><span class="o">.</span><span class="n">LJ_radius</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">)</span>
        <span class="n">other</span><span class="o">.</span><span class="n">LJ_depth</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">other</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">rmin</span>
            <span class="n">other</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">epsilon</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="fm">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncopies</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__imul__</span><span class="p">(</span><span class="n">ncopies</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_1012</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot combine Amber systems with NBFIX or 10-12 parameters&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__iadd__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="c1"># Make sure we properly recompute the LJ tables</span>
        <span class="n">nbfixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_nbidx_lj_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_nonbonded_tables</span><span class="p">(</span><span class="n">nbfixes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.load_pointers"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.load_pointers">[docs]</a>    <span class="k">def</span> <span class="nf">load_pointers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data in POINTERS section into a pointers dictionary with each</span>
<span class="sd">        key being the pointer name according to http://ambermd.org/formats.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NATOM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NATOM</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NTYPES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NBONH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NBONH</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;MBONA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">MBONA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NTHETH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NTHETH</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;MTHETA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">MTHETA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NPHIH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NPHIH</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;MPHIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">MPHIA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NHPARM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NHPARM</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NPARM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NPARM</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NEXT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NEXT</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NNB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NNB</span><span class="p">]</span> <span class="c1"># alias for above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NRES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NRES</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NBONA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NBONA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NTHETA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NTHETA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NPHIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NPHIA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NUMBND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NUMBND</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NUMANG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NUMANG</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NPTRA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NPTRA</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NATYP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NATYP</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NPHB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NPHB</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;IFPERT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">IFPERT</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NBPER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NBPER</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NGPER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NGPER</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NDPER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NDPER</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;MBPER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">MBPER</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;MGPER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">MGPER</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;MDPER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">MDPER</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;IFBOX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NMXRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NMXRS</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;IFCAP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">IFCAP</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NUMEXTRA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NUMEXTRA</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;IPTRES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NSPM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NSPSOL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># The next is probably only there for LES-prmtops</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s2">&quot;NCOPY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s2">&quot;POINTERS&quot;</span><span class="p">][</span><span class="n">NCOPY</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># If CMAP is not present, don&#39;t load the pointers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_cmap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_COUNT&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP_TYPES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_COUNT&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.load_structure"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.load_structure">[docs]</a>    <span class="k">def</span> <span class="nf">load_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads all of the topology instance variables. This is necessary if we</span>
<span class="sd">        actually want to modify the topological layout of our system</span>
<span class="sd">        (like deleting atoms)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_section_lengths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_atoms_and_residues</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_atom_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_bond_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_angle_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_dihedral_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_cmap_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_extra_exclusions</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.load_atom_info"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.load_atom_info">[docs]</a>    <span class="k">def</span> <span class="nf">load_atom_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads atom properties into the atoms that have been loaded. If any</span>
<span class="sd">        arrays are too short or too long, an IndexError will be raised</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Collect all of the atom properties present in our topology file</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">_zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>
        <span class="n">anam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">]</span>
        <span class="n">chg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">]</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;MASS&#39;</span><span class="p">]</span>
        <span class="n">nbtyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">]</span>
        <span class="n">atyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;AMBER_ATOM_TYPE&#39;</span><span class="p">]</span>
        <span class="n">join</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;JOIN_ARRAY&#39;</span><span class="p">]</span>
        <span class="n">irot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;IROTAT&#39;</span><span class="p">]</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;TREE_CHAIN_CLASSIFICATION&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RADII&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="n">zeros</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SCREEN&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="n">zeros</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">]</span>
            <span class="n">replace_atnum</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">atnum</span> <span class="o">=</span> <span class="p">[</span><span class="n">AtomicNum</span><span class="p">[</span><span class="n">element_by_mass</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mass</span><span class="p">]</span>
            <span class="n">replace_atnum</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">occu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOM_OCCUPANCY&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">occu</span> <span class="o">=</span> <span class="n">zeros</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bfac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOM_BFACTOR&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">bfac</span> <span class="o">=</span> <span class="n">zeros</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">anum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOM_NUMBER&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">anum</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">anam</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">chg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span> <span class="o">=</span> <span class="n">nbtyp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">atyp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">join</span> <span class="o">=</span> <span class="n">join</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">irotat</span> <span class="o">=</span> <span class="n">irot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">solvent_radius</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">replace_atnum</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atnum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">element_by_mass</span><span class="p">(</span><span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">=</span> <span class="n">atnum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span> <span class="o">=</span> <span class="n">AtomType</span><span class="p">(</span><span class="n">atyp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atnum</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">=</span> <span class="n">occu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">bfactor</span> <span class="o">=</span> <span class="n">bfac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">anum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">depth14</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_14_depth</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">radius14</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_14_radius</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">depth14</span> <span class="o">=</span> <span class="n">radius14</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">set_lj_params</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">depth14</span><span class="p">,</span> <span class="n">radius14</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.ptr"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.ptr">[docs]</a>    <span class="k">def</span> <span class="nf">ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the value of the given pointer, and converts to upper-case so</span>
<span class="sd">        it&#39;s case-insensitive. A non-existent pointer meets with a KeyError</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pointer : str</span>
<span class="sd">            The AMBER pointer for which to extract the value</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The returned integer is the value of that pointer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="n">pointer</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.write_rst7"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.write_rst7">[docs]</a>    <span class="k">def</span> <span class="nf">write_rst7</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">netcdf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a restart file with the current coordinates and velocities and</span>
<span class="sd">        box info if it&#39;s present</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the file to write the restart file to</span>
<span class="sd">        netcdf : bool=False</span>
<span class="sd">            If True, write a NetCDF-format restart file (requires a NetCDF</span>
<span class="sd">            backend; scipy, netCDF4, or ScientificPython; to be installed)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If `netcdf` is not specified and the filename extension given by `name`</span>
<span class="sd">        is `.ncrst`, the a NetCDF restart file will be written. However, an</span>
<span class="sd">        explicit value for `netcdf` will override any filename extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># By default, determine file type by extension (.ncrst is NetCDF)</span>
        <span class="n">netcdf</span> <span class="o">=</span> <span class="n">netcdf</span> <span class="ow">or</span> <span class="p">(</span><span class="n">netcdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ncrst&#39;</span><span class="p">))</span>

        <span class="c1"># Check that we have a rst7 loaded, then overwrite it with a new one if</span>
        <span class="c1"># necessary</span>
        <span class="n">rst7</span> <span class="o">=</span> <span class="n">Rst7</span><span class="p">(</span><span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">))</span>

        <span class="c1"># Now fill in the rst7 coordinates</span>
        <span class="n">rst7</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rst7</span><span class="o">.</span><span class="n">vels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">i3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">rst7</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i3</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">xx</span>
            <span class="n">rst7</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">rst7</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">xz</span>
            <span class="k">if</span> <span class="n">rst7</span><span class="o">.</span><span class="n">hasvels</span><span class="p">:</span>
                <span class="n">rst7</span><span class="o">.</span><span class="n">vels</span><span class="p">[</span><span class="n">i3</span>  <span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">vx</span>
                <span class="n">rst7</span><span class="o">.</span><span class="n">vels</span><span class="p">[</span><span class="n">i3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">vy</span>
                <span class="n">rst7</span><span class="o">.</span><span class="n">vels</span><span class="p">[</span><span class="n">i3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">vz</span>

        <span class="n">rst7</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="c1"># Now write the restart file</span>
        <span class="n">rst7</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">netcdf</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.write_parm"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.write_parm">[docs]</a>    <span class="k">def</span> <span class="nf">write_parm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the current data in parm_data into a new topology file with a given name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str or file-like</span>
<span class="sd">            The name of the file to write the prmtop to or the file object to write to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span>
        <span class="n">AmberFormat</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.remake_parm"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.remake_parm">[docs]</a>    <span class="k">def</span> <span class="nf">remake_parm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills :attr:`parm_data` from the data in the parameter and topology</span>
<span class="sd">        arrays (e.g., :attr:`atoms`, :attr:`bonds`, :attr:`bond_types`, ...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get rid of terms containing deleted atoms and empty residues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune_empty_terms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rediscover_molecules</span><span class="p">()</span>

        <span class="c1"># Transfer information from the topology lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfer_atom_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfer_residue_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfer_bond_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfer_angle_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfer_dihedral_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfer_cmap_properties</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ifbox</span><span class="p">()</span>
        <span class="c1"># Load the pointers dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_pointers</span><span class="p">()</span>
        <span class="c1"># Mark atom list as unchanged</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.is_changed"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.is_changed">[docs]</a>    <span class="k">def</span> <span class="nf">is_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if any of the topological arrays have changed since the</span>
<span class="sd">        last upload</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_changed</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">is_changed</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_changed</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_topology&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span>
        <span class="k">return</span> <span class="n">is_changed</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.strip"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a subset of the atoms corresponding to an atom-based selection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selection : AmberMask, str, or iterable of bool</span>
<span class="sd">            This is the selection of atoms that will be deleted from this</span>
<span class="sd">            structure. If it is a string, it will be interpreted as an</span>
<span class="sd">            AmberMask. If it is an AmberMask, it will be converted to a</span>
<span class="sd">            selection of atoms. If it is an iterable, it must be the same length</span>
<span class="sd">            as the `atoms` list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remake_parm</span><span class="p">()</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.rediscover_molecules"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.rediscover_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">rediscover_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solute_ions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fix_broken</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This determines the molecularity and sets the ATOMS_PER_MOLECULE and</span>
<span class="sd">        SOLVENT_POINTERS sections of the prmtops. Returns the new atom sequence</span>
<span class="sd">        in terms of the &#39;old&#39; atom indexes if re-ordering was necessary to fix</span>
<span class="sd">        the tleap bug. Returns None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Bail out of we are not doing a solvated prmtop</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">owner</span> <span class="o">=</span> <span class="n">set_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">all_solvent</span> <span class="o">=</span> <span class="n">SOLVENT_NAMES</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">solute_ions</span><span class="p">:</span>
            <span class="n">all_solvent</span> <span class="o">=</span> <span class="n">all_solvent</span> <span class="o">|</span> <span class="n">ALLION_NAMES</span>
        <span class="n">first_solvent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">all_solvent</span><span class="p">:</span>
                <span class="n">first_solvent</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="c1"># Now remake our SOLVENT_POINTERS and ATOMS_PER_MOLECULE section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_solvent</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">owner</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Find the first solvent molecule if there are any</span>
        <span class="k">if</span> <span class="n">first_solvent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="n">first_solvent</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marked</span>

        <span class="c1"># Now set up ATOMS_PER_MOLECULE and catch any errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">owner</span><span class="p">]</span>

        <span class="c1"># Check that all of our molecules are contiguous, because we have to</span>
        <span class="c1"># re-order atoms if they&#39;re not</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">owner</span><span class="p">:</span>
                <span class="n">sortedmol</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortedmol</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">sortedmol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sortedmol</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fix_broken</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MoleculeError</span><span class="p">(</span><span class="s1">&#39;Molecule atoms are not contiguous!&#39;</span><span class="p">)</span>
            <span class="c1"># Non-contiguous molecules detected... time to fix (ugh!)</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Molecule atoms are not contiguous! I am attempting to &#39;</span>
                 <span class="s1">&#39;reorder the atoms to fix this.&#39;</span><span class="p">,</span> <span class="n">AmberWarning</span><span class="p">)</span>
            <span class="c1"># Make sure that no residues are split up by this</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                <span class="n">molid</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marked</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">molid</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">marked</span><span class="p">:</span>
                        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Residues cannot be part of 2 molecules! Molecule &#39;</span>
                             <span class="s1">&#39;section will not be correctly set. [Offending &#39;</span>
                             <span class="s1">&#39;residue is </span><span class="si">%d</span><span class="s1">: </span><span class="si">%r</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">res</span><span class="p">),</span>
                             <span class="n">AmberWarning</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
            <span class="n">new_atoms</span> <span class="o">=</span> <span class="n">AtomList</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">owner</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
                    <span class="n">new_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">new_atoms</span>
            <span class="c1"># Re-sort our residues and residue list for new atom ordering</span>
            <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                <span class="n">residue</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">owner</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.fill_LJ"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.fill_LJ">[docs]</a>    <span class="k">def</span> <span class="nf">fill_LJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the Lennard-Jones parameters (Rmin/2 and epsilon) for each</span>
<span class="sd">        atom type by computing their values from the A and B coefficients of</span>
<span class="sd">        each atom interacting with itself.</span>

<span class="sd">        This fills the :attr:`LJ_radius`, :attr:`LJ_depth`, and :attr:`LJ_types`</span>
<span class="sd">        data structures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty LJ_radii so it can be re-filled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># empty LJ_depths so it can be re-filled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LJ_types</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># empty LJ_types so it can be re-filled</span>
        <span class="n">one_sixth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span>    <span class="c1"># we need to raise some numbers to the 1/6th power</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="n">acoef</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]</span>
        <span class="n">bcoef</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">]</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NATOM&#39;</span><span class="p">]</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span> <span class="c1"># fill the LJ_types array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LJ_types</span><span class="p">[</span><span class="n">pd</span><span class="p">[</span><span class="s2">&quot;AMBER_ATOM_TYPE&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s2">&quot;ATOM_TYPE_INDEX&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="n">lj_index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s2">&quot;NONBONDED_PARM_INDEX&quot;</span><span class="p">][</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">lj_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">acoef</span><span class="p">[</span><span class="n">lj_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0e-10</span> <span class="ow">or</span> <span class="n">bcoef</span><span class="p">[</span><span class="n">lj_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0e-10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">acoef</span><span class="p">[</span><span class="n">lj_index</span><span class="p">]</span> <span class="o">/</span> <span class="n">bcoef</span><span class="p">[</span><span class="n">lj_index</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">one_sixth</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bcoef</span><span class="p">[</span><span class="n">lj_index</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.recalculate_LJ"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.recalculate_LJ">[docs]</a>    <span class="k">def</span> <span class="nf">recalculate_LJ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills the ``LENNARD_JONES_ACOEF`` and ``LENNARD_JONES_BCOEF`` arrays in</span>
<span class="sd">        the :attr:`parm_data` raw data dictionary by applying the canonical</span>
<span class="sd">        Lorentz-Berthelot combining rules to the values in :attr:`LJ_radius` and</span>
<span class="sd">        :attr:`LJ_depth`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This will undo any off-diagonal L-J modifications you may have made, so</span>
<span class="sd">        call this function with care.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lorentz&#39;</span><span class="p">,</span> <span class="s1">&#39;geometric&#39;</span><span class="p">),</span> <span class="s2">&quot;Unrecognized combining rule&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;lorentz&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">+</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">sig1</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">]</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">LJ_sigma</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">fac</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">]</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># This indicates *either* a 10-12 potential for this pair</span>
                    <span class="c1"># _or_ it indicates a placeholder for HW atom type</span>
                    <span class="c1"># interactions and serves as a tag for fast water routines</span>
                    <span class="c1"># (or did in the past, anyway). So just skip to the next one</span>
                    <span class="k">continue</span>
                <span class="n">rij</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">LJ_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">LJ_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">fac</span>
                <span class="n">wdij</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">pd</span><span class="p">[</span><span class="s2">&quot;LENNARD_JONES_ACOEF&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdij</span> <span class="o">*</span> <span class="n">rij</span><span class="o">**</span><span class="mi">12</span>
                <span class="n">pd</span><span class="p">[</span><span class="s2">&quot;LENNARD_JONES_BCOEF&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wdij</span> <span class="o">*</span> <span class="n">rij</span><span class="o">**</span><span class="mi">6</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.has_NBFIX"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.has_NBFIX">[docs]</a>    <span class="k">def</span> <span class="nf">has_NBFIX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This routine determines whether there are any off-diagonal Lennard-Jones</span>
<span class="sd">        modifications (i.e., if any two atoms have a L-J pair interaction that</span>
<span class="sd">        does not match the combined L-J parameters for that pair).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nbfix : bool</span>
<span class="sd">            If True, off-diagonal elements in the combined Lennard-Jones matrix</span>
<span class="sd">            exist. If False, they do not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lorentz&#39;</span><span class="p">,</span> <span class="s1">&#39;geometric&#39;</span><span class="p">),</span> <span class="s2">&quot;Unrecognized combining rule&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;lorentz&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">+</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">sig1</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">LJ_sigma</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">fac</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_radius</span><span class="p">]</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">rij</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">LJ_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">LJ_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">fac</span>
                <span class="n">wdij</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LJ_depth</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">pd</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">wdij</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rij</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="p">(</span><span class="n">wdij</span> <span class="o">*</span> <span class="n">rij</span><span class="o">**</span><span class="mi">12</span><span class="p">))</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">or</span>
                        <span class="nb">abs</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">wdij</span> <span class="o">*</span> <span class="n">rij</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.has_1012"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.has_1012">[docs]</a>    <span class="k">def</span> <span class="nf">has_1012</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This routine determines whether there are any defined 10-12</span>
<span class="sd">        Lennard-Jones interactions that are non-zero</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        has_10_12 : bool</span>
<span class="sd">            If True, 10-12 interactions *are* defined for this particular system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices_with_1012</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">ntypes</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="c1"># It was negative, so we should have ADDED 1 to adjust for</span>
                <span class="c1"># indexing from 0</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBOND_ACOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBOND_BCOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">indices_with_1012</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indices_with_1012</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Now make sure that some of the atoms *have* those indices</span>
        <span class="n">active_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span> <span class="n">active_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indices_with_1012</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active_indices</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">active_indices</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.load_rst7"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.load_rst7">[docs]</a>    <span class="k">def</span> <span class="nf">load_rst7</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rst7</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads coordinates into the AmberParm class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rst7 : str or :class:`Rst7`</span>
<span class="sd">            The Amber coordinate file (either ASCII restart or NetCDF restart)</span>
<span class="sd">            object or filename to assign atomic coordinates from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rst7</span><span class="p">,</span> <span class="s1">&#39;coordinates&#39;</span><span class="p">):</span>
            <span class="n">rst7</span> <span class="o">=</span> <span class="n">Rst7</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">rst7</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasvels</span> <span class="o">=</span> <span class="n">rst7</span><span class="o">.</span><span class="n">hasvels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rst7</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasvels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="n">rst7</span><span class="o">.</span><span class="n">vels</span></div>

    <span class="c1">#===================================================</span>

<div class="viewcode-block" id="AmberParm.omm_nonbonded_force"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.AmberParm.omm_nonbonded_force">[docs]</a>    <span class="nd">@needs_openmm</span>
    <span class="k">def</span> <span class="nf">omm_nonbonded_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                            <span class="n">switchDistance</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                            <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                            <span class="n">reactionFieldDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the OpenMM NonbondedForce (and CustomNonbondedForce if</span>
<span class="sd">        necessary) to define the nonbonded interatomic potential for this</span>
<span class="sd">        system. A CustomNonbondedForce is used for the r^-4 part of the 12-6-4</span>
<span class="sd">        Lennard-Jones potential as well as any modified off-diagonal (i.e.,</span>
<span class="sd">        NBFIX) terms</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating point number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff.</span>
<span class="sd">        switchDistance : float or distance Quantity</span>
<span class="sd">            The distance at which the switching function is turned on for van</span>
<span class="sd">            der Waals interactions. This is ignored when no cutoff is used, and</span>
<span class="sd">            no switch is used if switchDistance is 0, negative, or greater than</span>
<span class="sd">            the cutoff</span>
<span class="sd">        ewaldErrorTolerance : float=0.0005</span>
<span class="sd">            When using PME or Ewald, the Ewald parameters will be calculated</span>
<span class="sd">            from this value</span>
<span class="sd">        reactionFieldDielectric : float=78.5</span>
<span class="sd">            If the nonbondedMethod is CutoffPeriodic or CutoffNonPeriodic, the</span>
<span class="sd">            region beyond the cutoff is treated using a reaction field method</span>
<span class="sd">            with this dielectric constant. It should be set to 1 if another</span>
<span class="sd">            implicit solvent model is being used (e.g., GB)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NonbondedForce [, CustomNonbondedForce]</span>
<span class="sd">            If a CustomNonbondedForce is necessary, the return value is a</span>
<span class="sd">            2-element tuple of NonbondedForce, CustomNonbondedForce. If only a</span>
<span class="sd">            NonbondedForce is necessary, that is the return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="n">nonbfrc</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AmberParm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">omm_nonbonded_force</span><span class="p">(</span>
            <span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">switchDistance</span><span class="p">,</span>
            <span class="n">ewaldErrorTolerance</span><span class="p">,</span> <span class="n">reactionFieldDielectric</span>
        <span class="p">)</span>
        <span class="n">has1012</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_1012</span><span class="p">()</span>
        <span class="n">hasnbfix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">()</span>
        <span class="n">has1264</span> <span class="o">=</span> <span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hasnbfix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has1264</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has1012</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chamber</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_modify_nonb_exceptions</span><span class="p">(</span><span class="n">nonbfrc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nonbfrc</span>

        <span class="c1"># If we have NBFIX, omm_nonbonded_force returned a tuple</span>
        <span class="k">if</span> <span class="n">hasnbfix</span><span class="p">:</span> <span class="n">nonbfrc</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If we have a 10-12 potential, toggle hasnbfix since the 12-6 terms</span>
        <span class="c1"># need to be handled via a lookup table (to avoid counting *both* 10-12</span>
        <span class="c1"># and 12-6 terms for the same pairs). Do this now, since nonbfrc is only</span>
        <span class="c1"># a tuple if hasnbfix is True *without* 10-12 detection.</span>
        <span class="n">hasnbfix</span> <span class="o">=</span> <span class="n">hasnbfix</span> <span class="ow">or</span> <span class="n">has1012</span>

        <span class="c1"># We need a CustomNonbondedForce... determine what it needs to calculate</span>
        <span class="k">if</span> <span class="n">hasnbfix</span> <span class="ow">and</span> <span class="n">has1264</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has1012</span><span class="p">:</span>
                <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
                        <span class="s1">&#39;(a/r6)^2-b/r6-c/r4+(ah/r6)^2-bh/(r6*r4); r6=r4*r2;&#39;</span>
                                                <span class="s1">&#39;r4=r2^2; r2=r^2;&#39;</span>
                                                <span class="s1">&#39;a=acoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;b=bcoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;c=ccoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;ah=ahcoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;bh=bhcoef(type1, type2);&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s1">&#39;(a/r6)^2-b/r6-c/r4; r6=r4*r2;&#39;</span>
                                                <span class="s1">&#39;r4=r2^2; r2=r^2;&#39;</span>
                                                <span class="s1">&#39;a=acoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;b=bcoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;c=ccoef(type1, type2);&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hasnbfix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has1012</span><span class="p">:</span>
                <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
                        <span class="s1">&#39;(a/r6)^2-b/r6+(ah/r6)^2-bh/(r6*r4);&#39;</span>
                        <span class="s1">&#39;r6=r4*r2;r4=r2^2;r2=r^2;&#39;</span>
                        <span class="s1">&#39;a=acoef(type1, type2);&#39;</span>
                        <span class="s1">&#39;b=bcoef(type1, type2);&#39;</span>
                        <span class="s1">&#39;ah=ahcoef(type1, type2);&#39;</span>
                        <span class="s1">&#39;bh=bhcoef(type1, type2);&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s1">&#39;(a/r6)^2-b/r6; r6=r2*r2*r2;&#39;</span>
                                                <span class="s1">&#39;r2=r^2; a=acoef(type1, type2);&#39;</span>
                                                <span class="s1">&#39;b=bcoef(type1, type2);&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">has1264</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s1">&#39;-c/r^4;c=ccoef(type1, type2);&#39;</span><span class="p">)</span>

        <span class="c1"># Set up the force with all of the particles</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span> <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Now construct the lookup tables</span>
        <span class="n">ene_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hasnbfix</span><span class="p">:</span>
            <span class="n">acoef</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="o">*</span><span class="n">ntypes</span><span class="p">)]</span>
            <span class="n">parm_acoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]</span>
            <span class="n">bcoef</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[:]</span>
            <span class="n">parm_bcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">has1264</span><span class="p">:</span>
                <span class="n">ccoef</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[:]</span>
                <span class="n">parm_ccoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">has1012</span><span class="p">:</span>
                <span class="n">ahcoef</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[:]</span>
                <span class="n">bhcoef</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[:]</span>
                <span class="n">parm_ahcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBOND_ACOEF&#39;</span><span class="p">]</span>
                <span class="n">parm_bhcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;HBOND_BCOEF&#39;</span><span class="p">]</span>
            <span class="n">afac</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ene_conv</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">6</span>
            <span class="n">bfac</span> <span class="o">=</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">6</span>
            <span class="n">cfac</span> <span class="o">=</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">ahfac</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ene_conv</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">6</span>
            <span class="n">bhfac</span> <span class="o">=</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">10</span>
            <span class="n">nbidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">nbidx</span><span class="p">[</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="n">j</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">has1012</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span> <span class="c1"># Fix adjust for 0 since it was negative</span>
                        <span class="n">ahcoef</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">parm_ahcoef</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">ahfac</span>
                        <span class="n">bhcoef</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm_bhcoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">bhfac</span>
                        <span class="k">if</span> <span class="n">has1264</span><span class="p">:</span>
                            <span class="n">ccoef</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm_ccoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cfac</span>
                    <span class="k">elif</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">acoef</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">parm_acoef</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">afac</span>
                        <span class="n">bcoef</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm_bcoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">bfac</span>
                        <span class="k">if</span> <span class="n">has1264</span><span class="p">:</span>
                            <span class="n">ccoef</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm_ccoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cfac</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;acoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">acoef</span><span class="p">))</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;bcoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">bcoef</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">has1264</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;ccoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">ccoef</span><span class="p">))</span>
            <span class="c1"># Our CustomNonbondedForce is taking care of the LJ part of our</span>
            <span class="c1"># potential, so we need to go through nonbfrc and zero-out the</span>
            <span class="c1"># Lennard-Jones parameters, but keep the charge parameters in place.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
                <span class="n">chg</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">nonbfrc</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chg</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="c1"># We still let the NonbondedForce handle our nonbonded exceptions,</span>
            <span class="c1"># but we may have to modify the Lennard-Jones part with</span>
            <span class="c1"># off-diagonal modifications. Offload this to a private method so it</span>
            <span class="c1"># can be overridden in the ChamberParm class</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modify_nonb_exceptions</span><span class="p">(</span><span class="n">nonbfrc</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">has1264</span><span class="p">:</span>
            <span class="c1"># Here we have JUST the r^-4 or r^-10/r^-12 parts, since the</span>
            <span class="c1"># hasnbfix block above handled the &quot;hasnbfix and has1264&quot; case</span>
            <span class="k">if</span> <span class="n">has1264</span><span class="p">:</span>
                <span class="n">ccoef</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="o">*</span><span class="n">ntypes</span><span class="p">)]</span>
                <span class="n">parm_ccoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">]</span>
            <span class="n">cfac</span> <span class="o">=</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">4</span>
            <span class="n">ahfac</span> <span class="o">=</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">12</span>
            <span class="n">bhfac</span> <span class="o">=</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">length_conv</span><span class="o">**</span><span class="mi">10</span>
            <span class="n">nbidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">nbidx</span><span class="p">[</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">ccoef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">ntypes</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm_ccoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">cfac</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;ccoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">ccoef</span><span class="p">))</span>
            <span class="c1"># Copy the exclusions</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ee</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has1012</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;ahcoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">ahcoef</span><span class="p">))</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s1">&#39;bhcoef&#39;</span><span class="p">,</span> <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">ntypes</span><span class="p">,</span> <span class="n">bhcoef</span><span class="p">))</span>
        <span class="c1"># Copy the switching function information to the CustomNonbondedForce</span>
        <span class="k">if</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getUseSwitchingFunction</span><span class="p">():</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getSwitchingDistance</span><span class="p">())</span>
        <span class="c1"># Set the dispersion correction on (by default)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Determine which nonbonded method we should use and transfer the</span>
        <span class="c1"># nonbonded cutoff</span>
        <span class="k">assert</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">,</span>
                                   <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">),</span> <span class="s1">&#39;Bad nonbondedMethod&#39;</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">nonbfrc</span><span class="p">,</span> <span class="n">force</span></div>

    <span class="c1">#===================================================</span>

    <span class="c1"># Iterators for parameters with and without hydrogen</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bonds_inc_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All bonds including hydrogen &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">bond</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bonds_without_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All bonds without hydrogen &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">bond</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">angles_inc_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All angles including hydrogen &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">angle</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">angles_without_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All angles including hydrogen &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">angle</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dihedrals_inc_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All dihedrals including hydrogen &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">dihed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dihedrals_without_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All dihedrals including hydrogen &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">dihed</span>

    <span class="c1">#===================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chamber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Whether this instance uses the CHARMM force field &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">amoeba</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Whether this instance uses the Amoeba force field &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_cmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Whether this instance has correction map terms or not &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_COUNT&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>


    <span class="c1">#===========  PRIVATE INSTANCE METHODS  ============</span>

    <span class="k">def</span> <span class="nf">_truncate_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Truncates an array to get the given length &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">section</span><span class="p">][:</span><span class="n">length</span><span class="p">]</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_load_cmap_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads the CHARMM CMAP types and array &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_cmap</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[:]</span>
        <span class="n">resolution_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_RESOLUTION&#39;</span>
        <span class="n">parameter_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_PARAMETER_</span><span class="si">%02d</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP_TYPES&#39;</span><span class="p">]):</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">resolution_key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">parameter_key</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">cmts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_comments</span><span class="p">[</span><span class="n">parameter_key</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CmapType</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">cmts</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">))</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_INDEX&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_check_section_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks that all of the raw sections have the appropriate length as</span>
<span class="sd">        specified by the POINTER section.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AmberError if any of the lengths are incorrect</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">check_length</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AmberError</span><span class="p">(</span><span class="s1">&#39;FLAG </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%d</span><span class="s1"> elements; expected </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">length</span><span class="p">))</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NATOM&#39;</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;MASS&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;NUMBER_EXCLUDED_ATOMS&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;JOIN_ARRAY&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;IROTAT&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;RADIUS&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;SCREEN&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">,</span> <span class="n">ntypes</span><span class="o">*</span><span class="n">ntypes</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">,</span> <span class="n">ntypes</span><span class="o">*</span><span class="p">(</span><span class="n">ntypes</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">,</span> <span class="n">ntypes</span><span class="o">*</span><span class="p">(</span><span class="n">ntypes</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_CCOEF&#39;</span><span class="p">,</span> <span class="n">ntypes</span><span class="o">*</span><span class="p">(</span><span class="n">ntypes</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">nres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NRES&#39;</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;RESIDUE_LABEL&#39;</span><span class="p">,</span> <span class="n">nres</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;RESIDUE_POINTER&#39;</span><span class="p">,</span> <span class="n">nres</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;RESIDUE_CHAINID&#39;</span><span class="p">,</span> <span class="n">nres</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">,</span> <span class="n">nres</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span><span class="p">,</span> <span class="n">nres</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;BOND_FORCE_CONSTANT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NUMBND&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;BOND_EQUIL_VALUE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NUMBND&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ANGLE_FORCE_CONSTANT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NUMANG&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ANGLE_EQUIL_VALUE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NUMANG&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;DIHEDRAL_FORCE_CONSTANT&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPTRA&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;DIHEDRAL_PERIODICITY&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPTRA&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;DIHEDRAL_PHASE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPTRA&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPTRA&#39;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPTRA&#39;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;SOLTY&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NATYP&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;BONDS_INC_HYDROGEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NBONH&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;BONDS_WITHOUT_HYDROGEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;MBONA&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ANGLES_INC_HYDROGEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NTHETH&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ANGLES_WITHOUT_HYDROGEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NTHETA&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;DIHEDRALS_INC_HYDROGEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPHIH&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;DIHEDRALS_WITHOUT_HYDROGEN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPHIA&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;HBOND_ACOEF&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPHB&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;HBOND_BCOEF&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;NPHB&#39;</span><span class="p">))</span>
        <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;SOLVENT_POINTERS&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">:</span>
            <span class="n">check_length</span><span class="p">(</span><span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_cmap</span><span class="p">:</span>
            <span class="n">check_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_COUNT&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">check_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_RESOLUTION&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP_TYPES&#39;</span><span class="p">])</span>
            <span class="n">resolution_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_RESOLUTION&#39;</span>
            <span class="n">parameter_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_PARAMETER_</span><span class="si">%02d</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP_TYPES&#39;</span><span class="p">]):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="n">resolution_key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">check_length</span><span class="p">(</span><span class="n">parameter_key</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">res</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_load_atoms_and_residues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the atoms and residues (which are always done together) into the</span>
<span class="sd">        data structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[:]</span>
        <span class="c1"># Figure out on which atoms the residues start and stop</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NATOM</span><span class="p">]</span>
        <span class="n">res_ptr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_POINTER&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">natom</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atnums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">atnums</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res_icd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">res_icd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NRES</span><span class="p">])]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res_chn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_CHAINID&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">res_chn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NRES</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">resname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_LABEL&#39;</span><span class="p">]):</span>
            <span class="n">resstart</span> <span class="o">=</span> <span class="n">res_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">resend</span> <span class="o">=</span> <span class="n">res_ptr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">resstart</span><span class="p">,</span> <span class="n">resend</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atnums</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;AMBER_ATOM_TYPE&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;EP&#39;</span><span class="p">,</span> <span class="s1">&#39;LP&#39;</span><span class="p">):</span>
                        <span class="n">atom</span> <span class="o">=</span> <span class="n">ExtraPoint</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">atnums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">ExtraPoint</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">res_chn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">res_icd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># Residue number may not be unique, since zeros may be assigned to all</span>
        <span class="c1"># solvent residues by addPDB. So we can&#39;t use the RESIDUE_NUMBER section</span>
        <span class="c1"># to fill in the residue sequence IDs in the add_atom call above. Add it</span>
        <span class="c1"># in as a post-hoc addition now if that information is present</span>
        <span class="k">if</span> <span class="s1">&#39;RESIDUE_NUMBER&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span><span class="p">]):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">num</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_load_extra_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look through the exclusion list in the prmtop file and see if any</span>
<span class="sd">        _additional_ exclusions outside the basic ones defined for bonds,</span>
<span class="sd">        angles, and dihedrals are specified. If so, add those to the exclusion</span>
<span class="sd">        list.</span>

<span class="sd">        This also goes through all atoms and loads the proper bond, angle and</span>
<span class="sd">        dihedral partners into any extra points. The way extra points are</span>
<span class="sd">        handled is that they are considered to carry the same topological</span>
<span class="sd">        connectivity as they actual atom they are bonded to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_excluded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NUMBER_EXCLUDED_ATOMS&#39;</span><span class="p">]</span>
        <span class="n">excluded_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;EXCLUDED_ATOMS_LIST&#39;</span><span class="p">]</span>
        <span class="n">first_excl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">exclusions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">bond_excl</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">_bond_partners</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">_angle_partners</span> <span class="o">+</span>
                            <span class="n">atom</span><span class="o">.</span><span class="n">_dihedral_partners</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">_tortor_partners</span> <span class="o">+</span>
                            <span class="n">atom</span><span class="o">.</span><span class="n">_exclusion_partners</span><span class="p">)</span>
            <span class="n">nexcl</span> <span class="o">=</span> <span class="n">num_excluded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_excl</span><span class="p">,</span> <span class="n">first_excl</span><span class="o">+</span><span class="n">nexcl</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">excluded_list</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="c1"># Zeros are placeholders</span>
                    <span class="n">exclusions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">excluded_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">eatom</span> <span class="ow">in</span> <span class="n">exclusions</span> <span class="o">-</span> <span class="n">bond_excl</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">eatom</span><span class="p">)</span>
            <span class="n">first_excl</span> <span class="o">+=</span> <span class="n">nexcl</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_load_bond_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads the bond types and bond arrays &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">req</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;BOND_FORCE_CONSTANT&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;BOND_EQUIL_VALUE&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BondType</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">))</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;BONDS_WITHOUT_HYDROGEN&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;BONDS_INC_HYDROGEN&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Bond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_load_angle_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads the angle types and angle arrays &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">theteq</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ANGLE_FORCE_CONSTANT&#39;</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ANGLE_EQUIL_VALUE&#39;</span><span class="p">]):</span>
            <span class="n">theteq</span> <span class="o">*=</span> <span class="n">RAD_TO_DEG</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AngleType</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">theteq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">))</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ANGLES_WITHOUT_HYDROGEN&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;ANGLES_INC_HYDROGEN&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">k</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_load_dihedral_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads the dihedral types and dihedral arrays &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">scee</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_FORCE_CONSTANT&#39;</span><span class="p">]]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scnb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">scnb</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_FORCE_CONSTANT&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_FORCE_CONSTANT&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_PERIODICITY&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_PHASE&#39;</span><span class="p">],</span>
                                    <span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span><span class="p">):</span>
            <span class="n">ph</span> <span class="o">*=</span> <span class="n">RAD_TO_DEG</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DihedralType</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRALS_WITHOUT_HYDROGEN&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="n">ignore_end</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">improper</span> <span class="o">=</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Dihedral</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                             <span class="n">improper</span><span class="o">=</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">ignore_end</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;DIHEDRALS_INC_HYDROGEN&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>
            <span class="n">ignore_end</span> <span class="o">=</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">improper</span> <span class="o">=</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Dihedral</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="p">],</span>
                             <span class="n">improper</span><span class="o">=</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">ignore_end</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_xfer_atom_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the various topology file section data from the `atoms` list to the</span>
<span class="sd">        topology file data in `parm_data`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NATOM</span><span class="p">]</span> <span class="o">=</span> <span class="n">natom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NATOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">natom</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;AMBER_ATOM_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MASS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;JOIN_ARRAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">join</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;TREE_CHAIN_CLASSIFICATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">tree</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;IROTAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">irotat</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUMBER_EXCLUDED_ATOMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;RADII&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RADII&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">solvent_radius</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;SCREEN&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SCREEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">screen</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ATOMIC_NUMBER&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="c1"># Do the non-bonded exclusions now</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;EXCLUDED_ATOMS_LIST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nextra</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_typ</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">excl</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">nonbonded_exclusions</span><span class="p">(</span><span class="n">index_from</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">excl</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;EXCLUDED_ATOMS_LIST&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">excl</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NUMBER_EXCLUDED_ATOMS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nextra</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">max_typ</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_typ</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">nb_idx</span><span class="p">)</span>
        <span class="n">nnb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EXCLUDED_ATOMS_LIST&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NNB</span><span class="p">]</span> <span class="o">=</span> <span class="n">nnb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NNB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NEXT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nnb</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NUMEXTRA</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NUMEXTRA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextra</span>
        <span class="n">max_typ</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">],</span> <span class="n">max_typ</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NTYPES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_typ</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_xfer_residue_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the various topology file section data from the `residues` list to</span>
<span class="sd">        the topology file data in `parm_data`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="n">nres</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NRES</span><span class="p">]</span> <span class="o">=</span> <span class="n">nres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NRES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nres</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_LABEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_POINTER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;RESIDUE_NUMBER&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_NUMBER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">number</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;RESIDUE_CHAINID&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_CHAINID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">chain</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;RESIDUE_ICODE&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;RESIDUE_ICODE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">insertion_code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>
        <span class="n">nmxrs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NMXRS</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmxrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NMXRS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmxrs</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_xfer_bond_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the data for the various bond arrays in the raw data from the</span>
<span class="sd">        parameter lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First do the bond types</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="k">for</span> <span class="n">bond_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">:</span>
            <span class="n">bond_type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">prune_unused</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BOND_FORCE_CONSTANT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">k</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BOND_EQUIL_VALUE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">req</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NUMBND</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NUMBND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">)</span>
        <span class="c1"># Now do the bond arrays</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BONDS_INC_HYDROGEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bond_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bond_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds_inc_h</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bond_list</span><span class="p">:</span>
            <span class="n">bond_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NBONH</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NBONH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BONDS_WITHOUT_HYDROGEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bond_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bond_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds_without_h</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bond_list</span><span class="p">:</span>
            <span class="n">bond_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">MBONA</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NBONA</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;MBONA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NBONA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bond_list</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_xfer_angle_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the data for the various angle arrays in the raw data from the</span>
<span class="sd">        parameter lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First do the angle types</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="k">for</span> <span class="n">angle_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">:</span>
            <span class="n">angle_type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">prune_unused</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ANGLE_FORCE_CONSTANT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">k</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ANGLE_EQUIL_VALUE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">theteq</span><span class="o">*</span><span class="n">DEG_TO_RAD</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NUMANG</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NUMANG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">)</span>
        <span class="c1"># Now do the angle arrays</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ANGLES_INC_HYDROGEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angle_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles_inc_h</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angle_list</span><span class="p">:</span>
            <span class="n">angle_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTHETH</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NTHETH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ANGLES_WITHOUT_HYDROGEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angle_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles_without_h</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angle_list</span><span class="p">:</span>
            <span class="n">angle_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTHETA</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">MTHETA</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NTHETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;MTHETA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle_list</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_xfer_dihedral_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the data for the various dihedral arrays in the raw data from the</span>
<span class="sd">        parameter lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First do the dihedral types</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="k">for</span> <span class="n">dihedral_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
            <span class="n">dihedral_type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">prune_unused</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_FORCE_CONSTANT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">phi_k</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_PERIODICITY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">per</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;DIHEDRAL_PHASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">phase</span><span class="o">*</span><span class="n">DEG_TO_RAD</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">scee</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="o">.</span><span class="n">scnb</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NPTRA</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NPTRA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
        <span class="c1"># Now do the dihedral arrays</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;DIHEDRALS_INC_HYDROGEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dihed_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dihed_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals_inc_h</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="n">dihed_list</span><span class="p">:</span>
            <span class="n">imp_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">improper</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">end_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">ignore_end</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dihed_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">end_sign</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">imp_sign</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dihed_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">end_sign</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">imp_sign</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NPHIH</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dihed_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NPHIH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dihed_list</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;DIHEDRALS_WITHOUT_HYDROGEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dihed_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dihed_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals_without_h</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dihed</span> <span class="ow">in</span> <span class="n">dihed_list</span><span class="p">:</span>
            <span class="n">imp_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">improper</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">end_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">ignore_end</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dihed_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">end_sign</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">imp_sign</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dihed_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">end_sign</span><span class="p">,</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="n">imp_sign</span><span class="p">,</span>
                                    <span class="n">dihed</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NPHIA</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">MPHIA</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dihed_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NPHIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;MPHIA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dihed_list</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_xfer_cmap_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the topology file section data from the cmap arrays &quot;&quot;&quot;</span>
        <span class="c1"># If we have no cmaps, delete all remnants of the CMAP terms in the</span>
        <span class="c1"># prmtop and bail out</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># We have deleted all cmaps. Get rid of them from the parm file and</span>
            <span class="c1"># bail out. This is probably pretty unlikely, though...</span>
            <span class="n">flag_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP&#39;</span>
            <span class="n">flags_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span> <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">flag_prefix</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags_to_delete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;CMAP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;CMAP_TYPES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP_TYPES&#39;</span><span class="p">]</span>
            <span class="k">return</span>
        <span class="c1"># Time to transfer our CMAP types</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span>
        <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">:</span>
            <span class="n">ct</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">cmap</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">prune_unused</span><span class="p">()</span>
        <span class="c1"># All of our CMAP types are in different topology file sections. We need</span>
        <span class="c1"># to delete all of the CMAP_PARAMETER_XX sections and then</span>
        <span class="c1"># recreate them with the correct size and comments.  The comments have</span>
        <span class="c1"># been stored in the CMAP types themselves to prevent them from being</span>
        <span class="c1"># lost. We will also assume that the Fortran format we&#39;re going to use</span>
        <span class="c1"># is the same for all CMAP types, so just pull it from</span>
        <span class="c1"># CMAP_PARAMETER_01 (or fall back to 8(F9.5))</span>
        <span class="n">parameter_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_PARAMETER_</span><span class="si">%02d</span><span class="s1">&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="n">parameter_key</span> <span class="o">%</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;8(F9.5)&#39;</span>
        <span class="n">flags_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;CMAP_PARAMETER&#39;</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">flags_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags_to_delete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="c1"># Now add them back</span>
        <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_RESOLUTION&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">):</span>
            <span class="n">newflag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_PARAMETER_</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="n">newflag</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">newflag</span>
        <span class="c1"># Now do the CMAP_INDEX section</span>
        <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_INDEX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">cmap_array</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">cm</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">cm</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_COUNT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">)]</span>
        <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_RESOLUTION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">resolution</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;CMAP_TYPES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_add_standard_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds all of the standard flags to the parm_data array &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;TITLE&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;CHARGE&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOMIC_NUMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;MASS&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOM_TYPE_INDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;NUMBER_EXCLUDED_ATOMS&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_LABEL&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RESIDUE_POINTER&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;BOND_FORCE_CONSTANT&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;BOND_EQUIL_VALUE&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ANGLE_FORCE_CONSTANT&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ANGLE_EQUIL_VALUE&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;DIHEDRAL_FORCE_CONSTANT&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;DIHEDRAL_PERIODICITY&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;DIHEDRAL_PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SCEE_SCALE_FACTOR&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SCNB_SCALE_FACTOR&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;NATYP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NATYP</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SOLTY&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;BONDS_INC_HYDROGEN&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;BONDS_WITHOUT_HYDROGEN&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ANGLES_INC_HYDROGEN&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ANGLES_WITHOUT_HYDROGEN&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;DIHEDRALS_INC_HYDROGEN&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;DIHEDRALS_WITHOUT_HYDROGEN&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;EXCLUDED_ATOMS_LIST&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;HBOND_ACOEF&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;HBOND_BCOEF&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;HBCUT&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;AMBER_ATOM_TYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;TREE_CHAIN_CLASSIFICATION&#39;</span><span class="p">,</span> <span class="s1">&#39;20a4&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;JOIN_ARRAY&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;IROTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_cmap</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_COUNT&#39;</span><span class="p">,</span> <span class="s1">&#39;2I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Number of CMAP terms, number of unique CMAP parameters&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_RESOLUTION&#39;</span><span class="p">,</span> <span class="s1">&#39;20I4&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Number of steps along each phi/psi CMAP axis&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;for each CMAP_PARAMETER grid&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cmap_prefix</span> <span class="o">+</span> <span class="s1">&#39;CMAP_INDEX&#39;</span><span class="p">,</span> <span class="s1">&#39;6I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Atom index i,j,k,l,m of the cross term&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;and then pointer to CMAP_PARAMETER_n&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">,</span> <span class="s1">&#39;3I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;BOX_DIMENSIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RADIUS_SET&#39;</span><span class="p">,</span> <span class="s1">&#39;1a80&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;RADII&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SCREEN&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;IPOL&#39;</span><span class="p">,</span> <span class="s1">&#39;1I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_set_nonbonded_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nbfixes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the tables of Lennard-Jones nonbonded interaction pairs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span>
        <span class="n">ntypes2</span> <span class="o">=</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="n">ntypes</span>
        <span class="c1"># Set up the index lookup tables (not a unique solution)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes2</span><span class="p">)]</span>
        <span class="n">holder</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes2</span><span class="p">)]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">holder</span><span class="p">[</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">holder</span><span class="p">[</span><span class="n">ntypes</span><span class="o">*</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntypes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">holder</span><span class="p">[</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">nttyp</span> <span class="o">=</span> <span class="n">ntypes</span> <span class="o">*</span> <span class="p">(</span><span class="n">ntypes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># Now build the Lennard-Jones arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nttyp</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nttyp</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_LJ</span><span class="p">()</span>
        <span class="c1"># Now make any NBFIX modifications we had</span>
        <span class="k">if</span> <span class="n">nbfixes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nbfixes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">terms</span> <span class="ow">in</span> <span class="n">fix</span><span class="p">:</span>
                    <span class="n">j</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">rmin14</span><span class="p">,</span> <span class="n">eps14</span> <span class="o">=</span> <span class="n">terms</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
                    <span class="n">eps14</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eps14</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">][</span><span class="n">ntypes</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">rmin</span><span class="o">**</span><span class="mi">12</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">eps</span> <span class="o">*</span> <span class="n">rmin</span><span class="o">**</span><span class="mi">6</span>

    <span class="c1">#===================================================</span>

    <span class="nd">@needs_openmm</span>
    <span class="k">def</span> <span class="nf">_modify_nonb_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbfrc</span><span class="p">,</span> <span class="n">customforce</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the nonbonded force exceptions and the custom nonbonded force</span>
<span class="sd">        exclusions. The exceptions on the nonbonded force might need to be</span>
<span class="sd">        adjusted if off-diagonal modifications on the L-J matrix are present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># To get into this routine, either NBFIX is present OR this is a chamber</span>
        <span class="c1"># prmtop and we need to pull the 1-4 L-J parameters from the</span>
        <span class="c1"># LENNARD_JONES_14_A/BCOEF arrays</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">ene_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_14_ACOEF&#39;</span><span class="p">]</span>
            <span class="n">bcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_14_BCOEF&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">acoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_ACOEF&#39;</span><span class="p">]</span>
            <span class="n">bcoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;LENNARD_JONES_BCOEF&#39;</span><span class="p">]</span>
        <span class="n">nbidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;NONBONDED_PARM_INDEX&#39;</span><span class="p">]</span>
        <span class="n">ntypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">NTYPES</span><span class="p">]</span>
        <span class="n">sigma_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_conv</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ee</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">qq</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">elementary_charge</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">ss</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilocalories_per_mole</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Copy this exclusion as-is... no need to modify the nonbfrc</span>
                <span class="c1"># exception parameters</span>
                <span class="k">if</span> <span class="n">customforce</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">customforce</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># Figure out what the 1-4 scaling parameters were for this pair...</span>
            <span class="n">unscaled_ee</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">one_scnb</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules_per_mole</span><span class="p">)</span> <span class="o">/</span> <span class="n">unscaled_ee</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="n">one_scnb</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">id1</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nb_idx</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">id2</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">nb_idx</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">nbidx</span><span class="p">[</span><span class="n">ntypes</span><span class="o">*</span><span class="n">id1</span><span class="o">+</span><span class="n">id2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">bcoef</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">elif</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># b / a == 2 / r^6 --&gt; (a / b * 2)^(1/6) = rmin</span>
                <span class="n">rmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rmin</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">*</span> <span class="n">one_scnb</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">rmin</span> <span class="o">*</span> <span class="n">sigma_scale</span>
            <span class="n">nonbfrc</span><span class="o">.</span><span class="n">setExceptionParameters</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">customforce</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">customforce</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_add_missing_13_14</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_inconsistent_vdw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the bond graph to fill in zero-parameter angles and dihedrals. The</span>
<span class="sd">        reason this is necessary is that Amber assumes that the list of angles</span>
<span class="sd">        and dihedrals encompasses *all* 1-3 and 1-4 pairs as determined by the</span>
<span class="sd">        bond graph, respectively. As a result, Amber programs use the angle and</span>
<span class="sd">        dihedral lists to set nonbonded exclusions and exceptions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ignore_inconsistent_vdw : bool, optional</span>
<span class="sd">            If True, do not make inconsistent 1-4 vdW parameters fatal. For</span>
<span class="sd">            ChamberParm, the 1-4 specific vdW parameters can compensate. For</span>
<span class="sd">            AmberParm, the 1-4 scaling factor cannot represent arbitrary</span>
<span class="sd">            exceptions. Default is False (should only be True for ChamberParm)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        n13, n14 : int, int</span>
<span class="sd">            The number of 1-3 and 1-4 pairs that needed to be added,</span>
<span class="sd">            respectively. Purely diagnostic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We need to figure out what 1-4 scaling term to use if we don&#39;t have</span>
        <span class="c1"># explicit exceptions</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lorentz&#39;</span><span class="p">,</span> <span class="s1">&#39;geometric&#39;</span><span class="p">),</span> <span class="s2">&quot;Unrecognized combining rule&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="n">scalings</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dih</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dih</span><span class="o">.</span><span class="n">ignore_end</span> <span class="ow">or</span> <span class="n">dih</span><span class="o">.</span><span class="n">improper</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">scalings</span><span class="p">[(</span><span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scalings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">maxkey</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">scalings</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">scalings</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">maxval</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">:</span>
                        <span class="n">maxkey</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>
                <span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span> <span class="o">=</span> <span class="n">maxkey</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="mf">1e10</span>
            <span class="n">zero_torsion</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Turn list of exceptions into a dict so we can look it up quickly</span>
            <span class="n">adjust_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
                <span class="n">adjust_dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="p">]))]</span> <span class="o">=</span> <span class="n">pair</span>
            <span class="n">ignored_torsion</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">zero_torsion</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Scan through existing dihedrals to make sure the exceptions match</span>
            <span class="c1"># the dihedral list</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;lorentz&#39;</span><span class="p">:</span>
                <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">+</span> <span class="n">sig2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
                <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">sig1</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">)</span>
            <span class="n">fac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="p">]))</span>
                <span class="n">eref</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                <span class="n">rref</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">fac</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">adjust_dict</span><span class="p">:</span>
                    <span class="n">pair</span> <span class="o">=</span> <span class="n">adjust_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="mf">1e10</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="n">eref</span> <span class="o">/</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span>
                    <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="mf">1e10</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span>
                    <span class="k">if</span> <span class="n">ignore_inconsistent_vdw</span><span class="p">:</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rref</span> <span class="o">-</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SMALL</span> <span class="ow">and</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cannot translate exceptions&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scnb</span> <span class="o">-</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SMALL</span> <span class="ow">and</span>
                            <span class="nb">abs</span><span class="p">(</span><span class="n">scee</span> <span class="o">-</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SMALL</span><span class="p">):</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="mf">1e10</span>
                <span class="n">newtype</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                <span class="n">newtype</span><span class="o">.</span><span class="n">scee</span> <span class="o">=</span> <span class="n">scee</span>
                <span class="n">newtype</span><span class="o">.</span><span class="n">scnb</span> <span class="o">=</span> <span class="n">scnb</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">newtype</span>
                <span class="n">newtype</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtype</span><span class="p">)</span>

        <span class="n">zero_angle</span> <span class="o">=</span> <span class="n">AngleType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">n13</span> <span class="o">=</span> <span class="n">n14</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;lorentz&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">+</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">sig1</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
            <span class="k">for</span> <span class="n">batom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">for</span> <span class="n">aatom</span> <span class="ow">in</span> <span class="n">batom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aatom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)</span> <span class="ow">or</span> <span class="n">aatom</span> <span class="ow">is</span> <span class="n">atom</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">datom</span> <span class="ow">in</span> <span class="n">aatom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">datom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">angle_partners</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span> <span class="o">+</span>
                                <span class="n">atom</span><span class="o">.</span><span class="n">dihedral_partners</span> <span class="ow">or</span> <span class="n">datom</span> <span class="ow">is</span> <span class="n">atom</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="c1"># Add the missing dihedral</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
                            <span class="n">tortype</span> <span class="o">=</span> <span class="n">zero_torsion</span>
                            <span class="k">if</span> <span class="n">n14</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">tortype</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tortype</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Figure out what the scale factors must be</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span> <span class="n">datom</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adjust_dict</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">ignored_torsion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">ignored_torsion</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ignored_torsion</span><span class="p">)</span>
                                    <span class="n">ignored_torsion</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span>
                                <span class="n">tortype</span> <span class="o">=</span> <span class="n">ignored_torsion</span>
                            <span class="k">elif</span> <span class="mi">0</span> <span class="ow">in</span> <span class="p">(</span><span class="n">adjust_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">adjust_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span> \
                                 <span class="ow">and</span> <span class="n">adjust_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">ignored_torsion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">ignored_torsion</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">,</span>
                                                                   <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ignored_torsion</span><span class="p">)</span>
                                <span class="n">tortype</span> <span class="o">=</span> <span class="n">ignored_torsion</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">pair</span> <span class="o">=</span> <span class="n">adjust_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span>
                                <span class="n">rmin</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">rmin</span>
                                <span class="c1"># Compare it to the 1-4 parameters that are</span>
                                <span class="c1"># already present</span>
                                <span class="n">eref</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">scnb</span> <span class="o">=</span> <span class="mf">1e10</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">scnb</span> <span class="o">=</span> <span class="n">eref</span> <span class="o">/</span> <span class="n">epsilon</span>
                                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">scee</span> <span class="o">=</span> <span class="mf">1e10</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">scee</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span>
                                <span class="n">rref</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">fac</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rmin</span> <span class="o">-</span> <span class="n">rref</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SMALL</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">ignore_inconsistent_vdw</span><span class="p">:</span>
                                        <span class="n">scnb</span> <span class="o">=</span> <span class="mf">1.0</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cannot translate exceptions&#39;</span><span class="p">)</span>
                                <span class="n">tortype</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span><span class="p">,</span>
                                                       <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tortype</span><span class="p">)</span>
                        <span class="n">dihedral</span> <span class="o">=</span> <span class="n">Dihedral</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">batom</span><span class="p">,</span> <span class="n">aatom</span><span class="p">,</span> <span class="n">datom</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">improper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">tortype</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dihedral</span><span class="p">)</span>
                        <span class="n">n14</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">aatom</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">angle_partners</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># Add the missing angle</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Angle</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">batom</span><span class="p">,</span> <span class="n">aatom</span><span class="p">,</span> <span class="n">zero_angle</span><span class="p">))</span>
                    <span class="n">n13</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">n13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero_angle</span><span class="p">)</span>
            <span class="n">zero_angle</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span>
        <span class="k">if</span> <span class="n">n14</span><span class="p">:</span> <span class="c1"># See if there is some ambiguity here</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scalings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Multiple 1-4 scaling factors detected. Using the most-used values scee=</span><span class="si">%f</span><span class="s1"> &#39;</span>
                     <span class="s1">&#39;scnb=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scee</span><span class="p">,</span> <span class="n">scnb</span><span class="p">),</span> <span class="n">AmberWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n13</span><span class="p">,</span> <span class="n">n14</span>

    <span class="c1">#===================================================</span>

    <span class="k">def</span> <span class="nf">_get_atom_collection_for_alternate_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atom_collection</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">adict</span><span class="p">,</span> <span class="n">residue</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atom_collection</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">adict</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atom_collection</span>

    <span class="k">def</span> <span class="nf">_label_alternates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atom_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_atom_collection_for_alternate_labels</span><span class="p">()</span>
        <span class="n">possible_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">adict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atom_collection</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">atom_name</span><span class="p">,</span> <span class="n">atom_list</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">adict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atom_list</span><span class="p">):</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">possible_labels</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">possible_labels</span><span class="p">)]</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">altloc</span> <span class="o">=</span> <span class="n">label</span>

    <span class="c1">#===================================================</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@box</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Deleting the box is more complicated for AmberParm, so override it</span>
        <span class="c1"># here</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Delete all of the other box info in the prmtop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;IPTRES&#39;</span><span class="p">,</span> <span class="s1">&#39;NSPM&#39;</span><span class="p">,</span> <span class="s1">&#39;NSPSOL&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">,</span> <span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span><span class="p">,</span> <span class="s1">&#39;BOX_DIMENSIONS&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hasbox</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Box information must be 6 floats&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

            <span class="c1"># We are adding a box for the first time, so make sure we add some flags</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="n">box</span>
                <span class="c1"># We need to add topology information</span>
                <span class="k">if</span> <span class="s1">&#39;SOLVENT_POINTERS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">,</span> <span class="s1">&#39;3I8&#39;</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="s1">&#39;IROTAT&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span><span class="p">,</span> <span class="s1">&#39;10I8&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">after</span><span class="o">=</span><span class="s1">&#39;SOLVENT_POINTERS&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;BOX_DIMENSIONS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_flag</span><span class="p">(</span><span class="s1">&#39;BOX_DIMENSIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;5E16.8&#39;</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="s1">&#39;ATOMS_PER_MOLECULE&#39;</span><span class="p">,</span>
                                  <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rediscover_molecules</span><span class="p">(</span><span class="n">fix_broken</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">MoleculeError</span><span class="p">:</span>
                    <span class="c1"># Do not reorder molecules here -- only do that when</span>
                    <span class="c1"># specifically requested. Otherwise we could get out-of-sync</span>
                    <span class="c1"># with coordinates.</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_pointers</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;BOX_DIMENSIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="n">box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ifbox</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_ifbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the IFBOX pointers to 1 (ortho), 2 (octahedral) , or 3 (other) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;IFBOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="mi">90</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;IFBOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">TRUNCATED_OCTAHEDRON_ANGLE</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;IFBOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># General triclinic</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parm_data</span><span class="p">[</span><span class="s1">&#39;POINTERS&#39;</span><span class="p">][</span><span class="n">IFBOX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointers</span><span class="p">[</span><span class="s1">&#39;IFBOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">_cleanup_dihedrals_with_periodicity_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For torsions with only a single term and a periodicity set to 0, make sure pmemd still</span>
<span class="sd">        properly recognizes the necessary exception parameters. update_dihedral_exclusions will</span>
<span class="sd">        make sure that if a dihedral has a type pn0 *and* ignore_end is set to False (which means</span>
<span class="sd">        that it is required to specify exclusions), then it is the *only* torsion between those</span>
<span class="sd">        atoms in the system. This allows us to scan through our dihedrals, look for significant</span>
<span class="sd">        terms that have pn==0, and simply add another dihedral with pn=1 and k=0 to ensure that</span>
<span class="sd">        pmemd will always get that exception correct</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dihedrals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dih</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dih</span><span class="o">.</span><span class="n">ignore_end</span> <span class="ow">or</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># If we got here, ignore_end must be False and out periodicity must be 0. So add</span>
            <span class="c1"># another dihedral</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">new_dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Dihedral</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom3</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="p">,</span> <span class="n">improper</span><span class="o">=</span><span class="n">dih</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span>
                         <span class="n">ignore_end</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Now that we added the above dihedral, we can start ignoring the end-group interactions</span>
            <span class="c1"># on this dihedral</span>
            <span class="n">dih</span><span class="o">.</span><span class="n">ignore_end</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">new_dihedrals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_dihedrals</span><span class="p">)</span>

    <span class="c1">#===================================================</span>

    <span class="n">_AMBERPARM_ATTRS</span> <span class="o">=</span> <span class="s1">&#39;LJ_types LJ_radius LJ_depth parm_data pointers&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">Structure</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">AmberFormat</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AMBERPARM_ATTRS</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">AmberFormat</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">Structure</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AMBERPARM_ATTRS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span></div>


<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<div class="viewcode-block" id="Rst7"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.Rst7">[docs]</a><span class="k">class</span> <span class="nc">Rst7</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Amber input coordinate (or restart coordinate) file. Front-end for the</span>
<span class="sd">    readers and writers, supports both NetCDF and ASCII restarts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str, optional</span>
<span class="sd">        If a filename is provided, this file is parsed and the Rst7 data</span>
<span class="sd">        populated from that file. The format (ASCII or NetCDF) is autodetected</span>
<span class="sd">    natom : int, optional</span>
<span class="sd">        If no filename is provided, this value is required. If a filename is</span>
<span class="sd">        provided, this value is ignored (and instead set to the value of natom</span>
<span class="sd">        from the coordinate file). This is the number of atoms for which we have</span>
<span class="sd">        coordinates. If not provided for a new file, it *must* be set later.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        For a file that is to be written, this is the title that will be given</span>
<span class="sd">        to that file. Default is an empty string</span>
<span class="sd">    time : float, optional</span>
<span class="sd">        The time to write to the restart file. This is cosmetic. Default is 0</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Rst7.__init__"><a class="viewcode-back" href="../../../amberobj/parmed.amber.Rst7.html#parmed.amber.Rst7.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optionally takes a filename to read. This is deprecated, though, as the</span>
<span class="sd">        alternative constructor &quot;open&quot; should be used instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="n">natom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box</span>
    <span class="nd">@box</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="Rst7.open"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.Rst7.open">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructor that opens and parses an input coordinate file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file to parse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span></div>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open and parse an input coordinate file in either ASCII or NetCDF format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">AmberAsciiRestart</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">natom</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Maybe it&#39;s a NetCDF file?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">NetCDFRestart</span><span class="o">.</span><span class="n">open_old</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">atom</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">AmberError</span><span class="p">(</span><span class="s1">&#39;Could not parse restart file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">hasvels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vels</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">velocities</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">hasbox</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">time</span>

<div class="viewcode-block" id="Rst7.copy_from"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.Rst7.copy_from">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">copy_from</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies the coordinates, velocities, and box information from another</span>
<span class="sd">        instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">natom</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">natom</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">title</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="s1">&#39;vels&#39;</span><span class="p">):</span> <span class="n">inst</span><span class="o">.</span><span class="n">vels</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">vels</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="s1">&#39;box&#39;</span><span class="p">):</span> <span class="n">inst</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">_copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">thing</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">time</span>

        <span class="k">return</span> <span class="n">inst</span></div>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Copy constructor &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Rst7.write"><a class="viewcode-back" href="../../../api/parmed/parmed.amber.readparm.html#parmed.amber.Rst7.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">netcdf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Writes the coordinates and/or velocities to a restart file &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">netcdf</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Number of atoms must be set for NetCDF &#39;</span>
                                   <span class="s1">&#39;Restart files before write time&#39;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">NetCDFRestart</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">vels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">AmberAsciiRestart</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">natom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span>
                                  <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
        <span class="c1"># Now write the coordinates</span>
        <span class="n">f</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Atomic coordinates with units &quot;&quot;&quot;</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Vec3</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Atomic velocities in units of angstroms/picoseconds &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vels</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natom</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unit cell vectors with units &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">box_lengths_and_angles_to_vectors</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Whether or not this Rst7 has unit cell information &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasvels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Whether or not this Rst7 has velocities &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>

<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="k">def</span> <span class="nf">set_molecules</span><span class="p">(</span><span class="n">parm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correctly sets the ATOMS_PER_MOLECULE and SOLVENT_POINTERS sections of the</span>
<span class="sd">    topology file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">setrecursionlimit</span><span class="p">,</span> <span class="n">getrecursionlimit</span>
    <span class="c1"># Since we use a recursive function here, we make sure that the recursion</span>
    <span class="c1"># limit is large enough to handle the maximum possible recursion depth we&#39;ll</span>
    <span class="c1"># need (NATOM). We don&#39;t want to shrink it, though, since we use list</span>
    <span class="c1"># comprehensions in list constructors in some places that have an implicit</span>
    <span class="c1"># (shallow) recursion, therefore, reducing the recursion limit too much here</span>
    <span class="c1"># could raise a recursion depth exceeded exception during a _Type/Atom/XList</span>
    <span class="c1"># creation. Therefore, set the recursion limit to the greater of the current</span>
    <span class="c1"># limit or the number of atoms</span>
    <span class="n">setrecursionlimit</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="n">getrecursionlimit</span><span class="p">()))</span>

    <span class="c1"># Unmark all atoms so we can track which molecule each goes into</span>
    <span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">unmark</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">parm</span><span class="o">.</span><span class="n">ptr</span><span class="p">(</span><span class="s1">&#39;ifbox&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MoleculeError</span><span class="p">(</span><span class="s1">&#39;Only periodic prmtops can have &#39;</span>
                            <span class="s1">&#39;Molecule definitions&#39;</span><span class="p">)</span>
    <span class="c1"># The molecule &quot;ownership&quot; list</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># The way I do this is via a recursive algorithm, in which</span>
    <span class="c1"># the &quot;set_owner&quot; method is called for each bonded partner an atom</span>
    <span class="c1"># has, which in turn calls set_owner for each of its partners and</span>
    <span class="c1"># so on until everything has been assigned.</span>
    <span class="n">molecule_number</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># which molecule number we are on</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
        <span class="c1"># If this atom has not yet been &quot;owned&quot;, make it the next molecule</span>
        <span class="c1"># However, we only increment which molecule number we&#39;re on if</span>
        <span class="c1"># we actually assigned a new molecule (obviously)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">marked</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">_set_owner</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">molecule_number</span><span class="p">)</span>
            <span class="c1"># Make sure the atom indexes are sorted</span>
            <span class="n">owner</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">molecule_number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">owner</span>

<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="k">def</span> <span class="nf">_set_owner</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">owner_array</span><span class="p">,</span> <span class="n">atm</span><span class="p">,</span> <span class="n">mol_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Recursively sets ownership of given atom and all bonded partners &quot;&quot;&quot;</span>
    <span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atm</span><span class="p">]</span><span class="o">.</span><span class="n">marked</span> <span class="o">=</span> <span class="n">mol_id</span>
    <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="n">parm</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atm</span><span class="p">]</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">partner</span><span class="o">.</span><span class="n">marked</span><span class="p">:</span>
            <span class="n">owner_array</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">_set_owner</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="n">owner_array</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">mol_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">partner</span><span class="o">.</span><span class="n">marked</span> <span class="o">!=</span> <span class="n">mol_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MoleculeError</span><span class="p">(</span><span class="s1">&#39;Atom </span><span class="si">%d</span><span class="s1"> in multiple molecules&#39;</span> <span class="o">%</span>
                                <span class="n">partner</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>

<span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="k">def</span> <span class="nf">_zeros</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns an array of zeros of the given length &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015, Jason Swails

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>